<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>GORM for Mongo 1.0.0.RC2</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
    </head>

    <body class="body" onload="addJsClass();">
        <div id="navigation">
            <ul>
                <li>
                    <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                        <a href="../guide/index.html" class="button">Table of contents</a>
                        <div id="nav-summary-childs" style="display:none;">
                            
                            <div class="toc-item" style="margin-left:0"><a href="#1.%20Introduction"><strong>1</strong><span>Introduction</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#2.%20Getting%20Started"><strong>2</strong><span>Getting Started</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#3.%20Mapping%20Domain%20Classes%20to%20Mongo%20Collections"><strong>3</strong><span>Mapping Domain Classes to Mongo Collections</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#4.%20Low-level%20API"><strong>4</strong><span>Low-level API</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#5.%20Transactions"><strong>5</strong><span>Transactions</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#6.%20Unit%20Testing"><strong>6</strong><span>Unit Testing</span></a></div>
                            
                        </div>
                    </div>
                </li>
                <li class="separator selected">
                    <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
                </li>
            </ul>
        </div>
        <div id="header">
            <div class="images clearfix">
                
                
            </div>
            <p></p>
        </div>


        <table id="colset" border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td id="col1">
                    <div id="main" class="corner-all">

                        <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                        <div class="project">
                            <h1>GORM for Mongo - Reference Documentation</h1>
                            <p><strong>Authors:</strong> Graeme Rocher, Burt Beckwith</p>
                            <p><strong>Version:</strong> 1.0.0.RC2</p>
                        </div>

                        
                        <div id="table-of-content">
                            <h2>Table of Contents</h2>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#1.%20Introduction"><strong>1</strong><span>Introduction</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#1.1%20Compatibility%20with%20GORM%20for%20Hibernate"><strong>1.1</strong><span>Compatibility with GORM for Hibernate</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#1.2%20Release%20Notes"><strong>1.2</strong><span>Release Notes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#2.%20Getting%20Started"><strong>2</strong><span>Getting Started</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#2.1%20Using%20Mongo%20Standalone"><strong>2.1</strong><span>Using Mongo Standalone</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#2.2%20Combining%20Mongo%20and%20Hibernate"><strong>2.2</strong><span>Combining Mongo and Hibernate</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#2.3%20Advanced%20Configuration"><strong>2.3</strong><span>Advanced Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#3.%20Mapping%20Domain%20Classes%20to%20Mongo%20Collections"><strong>3</strong><span>Mapping Domain Classes to Mongo Collections</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#3.1%20Identity%20Generation"><strong>3.1</strong><span>Identity Generation</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#3.2%20Indexing%20Queries"><strong>3.2</strong><span>Indexing Queries</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#3.3%20Customizing%20the%20WriteConcern"><strong>3.3</strong><span>Customizing the WriteConcern</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#3.4%20Dynamic%20Attributes"><strong>3.4</strong><span>Dynamic Attributes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#3.5%20Geospacial%20Querying"><strong>3.5</strong><span>Geospacial Querying</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#3.6%20Custom%20User%20Types"><strong>3.6</strong><span>Custom User Types</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#4.%20Low-level%20API"><strong>4</strong><span>Low-level API</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#5.%20Transactions"><strong>5</strong><span>Transactions</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#6.%20Unit%20Testing"><strong>6</strong><span>Unit Testing</span></a></div>
                            
                            <div style="clear:both" ></div>
                        </div>
                        
                        

<h1 id="1. Introduction">1 Introduction</h1>
MongoDB bridges the gap between key-value stores (which are fast and highly scalable) and traditional RDBMS systems (which provide rich queries and deep functionality).<p class="paragraph"/>MongoDB (from "humongous") is a scalable, high-performance, open source, document-oriented database.<p class="paragraph"/>This project aims to provide an object-mapping layer on top of Mongo to ease common activities such as:
<ul class="star">
<li>Marshalling from Mongo to Groovy/Java types and back again</li>
<li>Support for GORM dynamic finders, criteria and named queries</li>
<li>Session-managed transactions</li>
<li>Validating domain instances backed by the Mongo datastore</li>
</ul><p class="paragraph"/>


<h2 id="1.1 Compatibility with GORM for Hibernate">1.1 Compatibility with GORM for Hibernate</h2>
This implementation tries to be as compatible as possible with GORM for Hibernate. In general you can refer to the <a href="http://grails.org/doc/latest/guide/5.%20Object%20Relational%20Mapping%20(GORM).html" target="blank">GORM documentation</a> and the "Domain Classes" section of the <a href="http://grails.org/doc/latest/" target="blank">reference guide</a> (see the left nav) for usage information.<p class="paragraph"/>The following key features are supported by GORM for Mongo:
<ul class="star">
<li>Simple persistence methods</li>
<li>Dynamic finders</li>
<li>Criteria queries</li>
<li>Named queries</li>
<li>Inheritance</li>
<li>Embedded types</li>
<li>Query by example</li>
</ul><p class="paragraph"/>However, some features are not supported:
<ul class="star">
<li>HQL queries</li>
<li>Dirty checking methods</li>
<li>Composite primary keys</li>
<li>Many-to-many associations (these can be modelled with a mapping class)</li>
<li>Any direct interaction with the Hibernate API</li>
<li>Custom Hibernate user types</li>
</ul><p class="paragraph"/>There may be other limitations not mentioned here so in general it shouldn't be expected that an application based on GORM for Hibernate will "just work" without some tweaking involved. Having said that, the large majority of common GORM functionality is supported.



<h2 id="1.2 Release Notes">1.2 Release Notes</h2>
Below are the details of the changes across releases:<p class="paragraph"/><h4>1.0 RC1 and RC2</h4>
<ul class="star">
<li>Support for querying embedded associations</li>
<li>Support for hint query modifier</li>
<li>Support for assigned identifiers</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 7</h4>
<ul class="star">
<li>Support for hasOne associations</li>
<li>Support for custom user types</li>
<li>Associations now linked via DBRef</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 6</h4>
<ul class="star">
<li>Support for embedded collections of Mongo domain classes</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 5</h4>
<ul class="star">
<li>Remaining GORM events (beforeLoad, afterLoad)</li>
<li>Optimistic locking via versioning</li>
<li>Services can now be made transactional for Mongo only via transactional = "mongo"</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 4</h4>
<ul class="star">
<li>Bug fixes and minor improvements</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 3</h4>
<ul class="star">
<li>Bug fixes and minor improvements</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 2</h4><p class="paragraph"/>Features added in 1.0 Milestone 2:
<ul class="star">
<li>Embedded types</li>
<li>Support for Maps and Lists</li>
<li>Geospacial Indexing</li>
<li>Schemaless Domain Models (Dynamic Attributes)</li>
<li>Custom Index Attributes</li>
</ul><p class="paragraph"/><h4>1.0 Milestone 1</h4><p class="paragraph"/>Features added in 1.0 Milestone 1:
<ul class="star">
<li>Dynamic finders</li>
<li>Criteria queries</li>
<li>Named queries</li>
<li>Support for GMongo as a lower level API</li>
</ul><p class="paragraph"/>


<h1 id="2. Getting Started">2 Getting Started</h1>
To get started with GORM for Mongo you need to install the plugin into a Grails application:<p class="paragraph"/><div class="code"><pre>grails install&#45;plugin mongodb</pre></div><p class="paragraph"/>Or configure it as a dependency in <code>BuildConfig.groovy</code>:<p class="paragraph"/><div class="code"><pre>plugins &#123;
	compile <span class="java&#45;quote<a href="mongodb:latest.version"</span>">></a>
&#125;</pre></div><p class="paragraph"/>With that done you need to set up a running Mongodb server. Refer to the <a href="http://www.mongodb.org/display/DOCS/Quickstart" target="blank">Mongodb Quick Start guide</a> for an explanation on how to startup a Mongo instance. Once installed starting Mongo is typically a matter of executing the following command:<p class="paragraph"/><div class="code"><pre>MONGO_HOME/bin/mongod</pre></div><p class="paragraph"/>With the above commands executed in a terminal window you should see output like the following appear:<p class="paragraph"/><div class="code"><pre>Thu Nov 11 16:54:08 MongoDB starting : pid=4600 port=27017 dbpath=/data/db/ 64&#45;bit
Thu Nov 11 16:54:08 db version v1.6.3, pdfile version 4.5
Thu Nov 11 16:54:08 git version: 278bd2ac2f2efbee556f32c13c1b6803224d1c01
Thu Nov 11 16:54:08 sys info: Darwin erh2.10gen.cc 9.6.0 Darwin Kernel Version 9.6.0: Mon Nov 24 17:37:00 PST 2008; root:xnu&#45;1228.9.59~1/RELEASE_I386 i386 BOOST_LIB_VERSION=1_40
Thu Nov 11 16:54:08 &#91;initandlisten&#93; waiting <span class="java&#45;keyword">for</span> connections on port 27017
Thu Nov 11 16:54:08 &#91;websvr&#93; web admin <span class="java&#45;keyword">interface</span> listening on port 28017</pre></div><p class="paragraph"/>As you can see the server is running on port 27017, but don't worry the Mongodb plugin for Grails will automatically configure itself to look for Mongodb on that port by default.<p class="paragraph"/>If you want to configure how Grails connects to Mongo then you can do so using the following settings in <code>grails-app/conf/DataSource.groovy</code>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    mongo &#123;
        host = <span class="java&#45;quote">"localhost"</span>
        port = 27107
        username = <span class="java&#45;quote">"blah"</span>
        password = <span class="java&#45;quote">"blah"</span>
        databaseName = <span class="java&#45;quote">"foo"</span>
    &#125;
&#125;</pre></div>



<h2 id="2.1 Using Mongo Standalone">2.1 Using Mongo Standalone</h2>
If you plan to use Mongo as your primary datastore then you need to uninstall the Hibernate plugin:<p class="paragraph"/><div class="code"><pre>grails uninstall&#45;plugin hibernate</pre></div><p class="paragraph"/>Or if it has been defined in the <code>grails-app/conf/BuildConfig.groovy</code> file comment out the hibernate line in the plugins block<p class="paragraph"/><div class="code"><pre>compile <span class="java&#45;quote<a href="hibernate:$grailsVersion"</span></pre></div>">></a><p class="paragraph"/>With this done all domain classes in grails-app/domain will be persisted via Mongo and not Hibernate. You can create a domain class by running the regular <code>create-domain-class</code> command:<p class="paragraph"/><div class="code"><pre>grails create&#45;domain&#45;class Person</pre></div><p class="paragraph"/>The <code>Person</code> domain class will automatically be a persistent entity that can be stored in Mongo.



<h2 id="2.2 Combining Mongo and Hibernate">2.2 Combining Mongo and Hibernate</h2>
If you have both the Hibernate and Mongo plugins installed then by default all classes in the <code>grails-app/domain</code> directory will be persisted by Hibernate and not Mongo. If you want to persist a particular domain class with Mongo then you must use the <code>mapWith</code> property in the domain class:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> mapWith = <span class="java&#45;quote">"mongo"</span></pre></div><p class="paragraph"/>Alternatively you can persist Hibernate entities to Mongo using the special <code>mongo</code> scope added to all Hibernate entities:<p class="paragraph"/><div class="code"><pre>def hibernatePerson = Person.get(1)<p class="paragraph"/>hibernatePerson.mongo.save()<p class="paragraph"/>def mongoPerson = Person.mongo.get(1)</pre></div><p class="paragraph"/>


<h2 id="2.3 Advanced Configuration">2.3 Advanced Configuration</h2>
As mentioned the GORM for Mongo plugin will configure all the defaults for you, but if you wish to customize those defaults you can do so in the your <code>grails-app/conf/DataSource.groovy</code> file:<p class="paragraph"/><div class="code"><pre>grails &#123;
    mongo &#123;
        host = <span class="java&#45;quote">"localhost"</span>
        port = 27107
        username = <span class="java&#45;quote">"blah"</span>
        password = <span class="java&#45;quote">"blah"</span>
        databaseName = <span class="java&#45;quote">"foo"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The <code>databaseName</code> setting configures the default database name. If not specified the <code>databaseName</code> will default to the name of your application.<p class="paragraph"/>You can also customize the Mongo connection settings using an <code>options</code> block:<p class="paragraph"/><div class="code"><pre>grails &#123;
    mongo &#123;
        options &#123;
            autoConnectRetry = <span class="java&#45;keyword">true</span>
            connectTimeout = 300
        &#125;
    &#125;
&#125;</pre></div><p class="paragraph"/>Available options and their descriptions are defined in the <a href="http://api.mongodb.org/java/current/com/mongodb/MongoOptions.html" target="blank">MongoOptions</a> javadoc.<p class="paragraph"/>In production scenarios you will typically use more than one Mongo server in either <a href="http://www.mongodb.org/display/DOCS/Master+Slave" target="blank">master/slave</a> or <a href="http://www.mongodb.org/display/DOCS/Replication" target="blank">replication</a> scenarios. The plugin allows you to configure <a href="http://www.mongodb.org/display/DOCS/Replica+Pairs" target="blank">replica pairs</a>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    mongo &#123;
        replicaPair = &#91; <span class="java&#45;quote">"localhost:27017"</span>, <span class="java&#45;quote">"localhost:27018"</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>Or <a href="http://www.mongodb.org/display/DOCS/Replica+Sets" target="blank">replica sets</a>:<p class="paragraph"/><div class="code"><pre>grails &#123;
    mongo &#123;
        replicaSet = &#91; <span class="java&#45;quote">"localhost:27017"</span>, <span class="java&#45;quote">"localhost:27018"</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>The replica sets are defined using a list of strings that conform to the Mongo <a href="http://api.mongodb.org/java/current/com/mongodb/DBAddress.html" target="blank">DBAddress</a> specification.



<h1 id="3. Mapping Domain Classes to Mongo Collections">3 Mapping Domain Classes to Mongo Collections</h1>
The way GORM for Mongo works is to map each domain class to a Mongo collection. For example given a domain class such as:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName
    <span class="java&#45;keyword">static</span> hasMany = &#91;pets:Pet&#93;
&#125;</pre></div><p class="paragraph"/>This will map onto a Mongo <a href="http://api.mongodb.org/java/current/com/mongodb/DBCollection.html" target="blank">DBCollection</a> called "person".<p class="paragraph"/>It is quite common in Mongo to embed documents within documents (nested documents). This can be done with GORM embedded types:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName
    Address address
    <span class="java&#45;keyword">static</span> embedded = &#91;'address'&#93;
&#125;</pre></div><p class="paragraph"/>You can map embedded lists and sets of documents/domain classes:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> firstName
    <span class="java&#45;object">String</span> lastName
    Address address
    List otherAddresses
    <span class="java&#45;keyword">static</span> embedded = &#91;'address', 'otherAddresses'&#93;
&#125;</pre></div><p class="paragraph"/>You can also map lists and maps of basic types (such as strings) simply by defining the appropriate collection type:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    List&#60;<span class="java&#45;object">String</span>&#62; friends
    Map pets
&#125;<p class="paragraph"/>...<p class="paragraph"/><span class="java&#45;keyword">new</span> Person(friends:&#91;'Fred', 'Bob'&#93;, pets:&#91;chuck:<span class="java&#45;quote">"Dog"</span>, eddie:'Parrot'&#93;).save(flush:<span class="java&#45;keyword">true</span>)</pre></div><p class="paragraph"/>Basic collection types are stored as native ArrayList and BSON documents within the Mongo documents.<p class="paragraph"/>You may wish to customize how a domain class maps onto a <code>DBCollection</code>. This is possible using the <code>mapping</code> block as follows:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    ..
    <span class="java&#45;keyword">static</span> mapping = &#123;
        collection <span class="java&#45;quote">"mycollection"</span>
        database <span class="java&#45;quote">"mydb"</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>In this example we see that the <code>Person</code> entity has been mapped to a collection called "mycollection" in a database called "mydb".<p class="paragraph"/>You can also control how an individual property maps onto a Mongo Document field (the default is to use the property name itself):<p class="paragraph"/><div class="code"><pre>class Person &#123;
    ..
    <span class="java&#45;keyword">static</span> mapping = &#123;
        firstName attr:<span class="java&#45;quote">"first_name"</span>
    &#125;
&#125;</pre></div>



<h2 id="3.1 Identity Generation">3.1 Identity Generation</h2>
By default in GORM entities are supplied with an integer-based identifier. So for example the following entity:<p class="paragraph"/><div class="code"><pre>class Person &#123;&#125;</pre></div><p class="paragraph"/>Has a property called <code>id</code> of type <code>java.lang.Long</code>. In this case GORM for Mongo will generate a sequence based identifier using the technique <a href="http://www.mongodb.org/display/DOCS/Atomic+Operations" target="blank">described in the Mongo documentation</a> on Atomic operations.<p class="paragraph"/>However, sequence based integer identifiers are not ideal for environments that require <a href="http://www.mongodb.org/display/DOCS/Sharding" target="blank">sharding</a> (one of the nicer features of Mongo). Hence it is generally advised to use either String based ids:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> id
&#125;</pre></div><p class="paragraph"/>Or a native BSON <a href="http://api.mongodb.org/java/current/org/bson/types/ObjectId.html" target="blank">ObjectId</a>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.bson.types.ObjectId<p class="paragraph"/>class Person &#123;
    ObjectId id
&#125;</pre></div><p class="paragraph"/>BSON <code>ObjectId</code> instances are generated in a similar fashion to <code>UUIDs</code>.


<h2 id="3.2 Indexing Queries">3.2 Indexing Queries</h2>
Mongo doesn't require that you specify indices to query, but like a relational database without specifying indices your queries will be significantly slower.<p class="paragraph"/>With that in mind it is important to specify the properties you plan to query using the mapping block:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> mapping = &#123;
        name index:<span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>With the above mapping a Mongo index will be automatically created for you. You can customize the index options using the <code>indexAttributes</code> configuration parameter:<p class="paragraph"/><div class="code"><pre>class Person &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> mapping = &#123;
        name index:<span class="java&#45;keyword">true</span>, indexAttributes: &#91;unique:<span class="java&#45;keyword">true</span>, dropDups:<span class="java&#45;keyword">true</span>&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>You can use MongoDB <a href="http://www.mongodb.org/display/DOCS/Optimization#Optimization-Hint" target="blank">Query Hints</a> by passing the <code>hint</code> argument to any dynamic finder:<p class="paragraph"/><div class="code"><pre>def people = Person.findByName(<span class="java&#45;quote">"Bob"</span>, &#91;hint:&#91;name:1&#93;&#93;)</pre></div><p class="paragraph"/>Or in a criteria query using the query "arguments" method<p class="paragraph"/><div class="code"><pre>Person.withCriteria &#123;
	eq 'firstName', 'Bob'
    arguments hint:&#91;<span class="java&#45;quote">"firstName"</span>:1&#93;
&#125;</pre></div>



<h2 id="3.3 Customizing the WriteConcern">3.3 Customizing the WriteConcern</h2>
A feature of Mongo is its ability to customize how important a database write is to the user. The Java client models this as a <a href="http://api.mongodb.org/java/current/com/mongodb/WriteConcern.html" target="blank">WriteConcern</a> and there are various options that indicate whether the client cares about server or network errors, or whether the data has been successfully written or not.<p class="paragraph"/>If you wish to customize the <code>WriteConcern</code> for a domain class you can do so in the mapping block:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.mongodb.WriteConcern<p class="paragraph"/>class Person &#123;
    <span class="java&#45;object">String</span> name
    <span class="java&#45;keyword">static</span> mapping = &#123;
        writeConcern WriteConcern.FSYNC_SAFE
    &#125;
&#125;</pre></div>



<h2 id="3.4 Dynamic Attributes">3.4 Dynamic Attributes</h2>
Unlike a relational database, Mongo allows for "schemaless" persistence where there are no limits to the number of attributes a particular document can have. A GORM domain class on the other hand has a schema in that there are a fixed number of properties. For example consider the following domain class:<p class="paragraph"/><div class="code"><pre>class Plant &#123;
    <span class="java&#45;object">boolean</span> goesInPatch
    <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/>Here there are two fixed properties, <code>name</code> and <code>goesInPatch</code>, that will be persisted into the Mongo document. Using GORM for Mongo you can however use dynamic properties via the Groovy subscript operator. For example:<p class="paragraph"/><div class="code"><pre>def p = <span class="java&#45;keyword">new</span> Plant(name:<span class="java&#45;quote">"Pineapple"</span>)
p&#91;'color'&#93; = 'Yellow'
p&#91;'hasLeaves'&#93; = <span class="java&#45;keyword">true</span>
p.save()<p class="paragraph"/>p = Plant.findByName(<span class="java&#45;quote">"Pineapple"</span>)<p class="paragraph"/>println p&#91;'color'&#93;
println p&#91;'hasLeaves'&#93;</pre></div><p class="paragraph"/>Using the subscript operator you can add additional attributes to the underlying <code>DBObject</code> instance that gets persisted to the Mongo allowing for more dynamic domain models.


<h2 id="3.5 Geospacial Querying">3.5 Geospacial Querying</h2>
It is possible to use Mongo's <a href="http://www.mongodb.org/display/DOCS/Geospatial+Indexing" target="blank">Geospacial querying</a> capability by mapping a list or map property using the <code>geoIndex</code> mapping:<p class="paragraph"/><div class="code"><pre>class Hotel &#123;
    <span class="java&#45;object">String</span> name
    List location<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        location geoIndex:<span class="java&#45;keyword">true</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>By default the index creation assumes latitude/longitude and thus is configured for a -180..180 range. If you are indexing something else you can customise this with <code>indexAttributes</code><p class="paragraph"/><div class="code"><pre>class Hotel &#123;
    <span class="java&#45;object">String</span> name
    List location<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        location geoIndex:<span class="java&#45;keyword">true</span>, indexAttributes:&#91;min:&#45;500, max:500&#93;
    &#125;
&#125;</pre></div><p class="paragraph"/>You can then save Geo locations using a two dimensional list:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Hotel(name:<span class="java&#45;quote">"Hilton"</span>, location:&#91;50, 50&#93;).save()</pre></div><p class="paragraph"/>Alternatively you can use a map with keys representing latitude and longitude:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">new</span> Hotel(name:<span class="java&#45;quote">"Hilton"</span>, location:&#91;lat: 40.739037d, <span class="java&#45;object">long</span>: 73.992964d&#93;).save()</pre></div><p class="paragraph"/><blockquote class="note">
You must specify whether the number of a floating point or double by adding a 'd' or 'f' at the end of the number eg. 40.739037d. Groovy's default type for decimal numbers is <code>BigDecimal</code> which is not supported by MongoDB.
</blockquote><p class="paragraph"/>Once you have your data indexed you can use Mongo specific dynamic finders to find hotels near a given a location:<p class="paragraph"/><div class="code"><pre>def h = Hotel.findByLocationNear(&#91;50, 60&#93;)
assert h.name == 'Hilton'</pre></div><p class="paragraph"/>You can also find a location within a box (bound queries). Boxes are defined by specifying the lower-left and upper-right corners:<p class="paragraph"/><div class="code"><pre>def box = &#91;&#91;40.73083d, &#45;73.99756d&#93;, &#91;40.741404d,  &#45;73.988135d&#93;&#93;
def h = Hotel.findByLocationWithinBox(box)</pre></div><p class="paragraph"/>You can also find a location within a circle. Circles are specified using a center and radius:<p class="paragraph"/><div class="code"><pre>def center = &#91;50, 50&#93;
def radius = 10
def h = Hotel.findByLocationWithinCircle(&#91;center, radius&#93;)</pre></div><p class="paragraph"/>If you plan on querying a location and some other value it is recommended to use a compound index:<p class="paragraph"/><div class="code"><pre>class Hotel &#123;
    <span class="java&#45;object">String</span> name
    List location
    <span class="java&#45;object">int</span> stars<p class="paragraph"/>    <span class="java&#45;keyword">static</span> mapping = &#123;
        compoundIndex location:<span class="java&#45;quote">"2d"</span>, stars:1
    &#125;
&#125;</pre></div><p class="paragraph"/>In the example above you an index is created for both the location and the number of stars a <code>Hotel</code> has.



<h2 id="3.6 Custom User Types">3.6 Custom User Types</h2>
GORM for MongoDB will persist all common known Java types like String, Integer, URL etc., however if you want to persist one of your own classes that is not a domain class you can implement a custom user type. For example consider the following class:<p class="paragraph"/><div class="code"><pre>class Birthday <span class="java&#45;keyword">implements</span> Comparable&#123;
    Date date<p class="paragraph"/>    Birthday(Date date) &#123;
        <span class="java&#45;keyword">this</span>.date = date
    &#125;<p class="paragraph"/>    @Override
    <span class="java&#45;object">int</span> compareTo(<span class="java&#45;object">Object</span> t) &#123;
        date.compareTo(t.date)
    &#125;
&#125;</pre></div><p class="paragraph"/><blockquote class="note">
Custom types should go in src/groovy not grails-app/domain
</blockquote><p class="paragraph"/>If you attempt to reference this class from a domain class it will not automatically be persisted for you. However you can create a custom type implementation and register it with the Spring. For example:<p class="paragraph"/><div class="code"><pre>class BirthdayType <span class="java&#45;keyword">extends</span> AbstractMappingAwareCustomTypeMarshaller&#60;Birthday, DBObject, DBObject&#62; &#123;
	BirthdayType() &#123;
		<span class="java&#45;keyword">super</span>(Birthday)
	&#125;
    @Override
    <span class="java&#45;keyword">protected</span> <span class="java&#45;object">Object</span> writeInternal(PersistentProperty property, <span class="java&#45;object">String</span> key, Birthday value, DBObject nativeTarget) &#123;
        <span class="java&#45;keyword">final</span> converted = value.date.time
        nativeTarget.put(key, converted)
        <span class="java&#45;keyword">return</span> converted
    &#125;<p class="paragraph"/>    @Override
    <span class="java&#45;keyword">protected</span> void queryInternal(PersistentProperty property, <span class="java&#45;object">String</span> key, PropertyCriterion criterion, DBObject nativeQuery) &#123;
        <span class="java&#45;keyword">if</span>(criterion <span class="java&#45;keyword">instanceof</span> Between) &#123;
            def dbo = <span class="java&#45;keyword">new</span> BasicDBObject()
            dbo.put(MongoQuery.MONGO_GTE_OPERATOR, criterion.getFrom().date.time);
            dbo.put(MongoQuery.MONGO_LTE_OPERATOR, criterion.getTo().date.time);
            nativeQuery.put(key, dbo)
        &#125;
        <span class="java&#45;keyword">else</span> &#123;
            nativeQuery.put(key, criterion.value.date.time)
        &#125;<p class="paragraph"/>    &#125;<p class="paragraph"/>    @Override
    <span class="java&#45;keyword">protected</span> Birthday readInternal(PersistentProperty property, <span class="java&#45;object">String</span> key, DBObject nativeSource) &#123;
        <span class="java&#45;keyword">final</span> num = nativeSource.get(key)
        <span class="java&#45;keyword">if</span>(num <span class="java&#45;keyword">instanceof</span> <span class="java&#45;object">Long</span>) &#123;
            <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> Birthday(<span class="java&#45;keyword">new</span> Date(num))
        &#125;
        <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">null</span>
    &#125;
&#125;</pre></div><p class="paragraph"/>The above <code>BirthdayType</code> class is a custom user type implementation for MongoDB for the <code>Birthday</code> class. It provides implementations for three methods: <code>readInternal</code>, <code>writeInternal</code> and the optional <code>queryInternal</code>. If you do not implement <code>queryInternal</code> your custom type can be persisted but not queried.<p class="paragraph"/>The <code>writeInternal</code> method gets passed the property, the key to store it under, the value and the native DBObject where the custom type is to be stored:<p class="paragraph"/><div class="code"><pre>@Override
<span class="java&#45;keyword">protected</span> <span class="java&#45;object">Object</span> writeInternal(PersistentProperty property, <span class="java&#45;object">String</span> key, Birthday value, DBObject nativeTarget) &#123;
    <span class="java&#45;keyword">final</span> converted = value.date.time
    nativeTarget.put(key, converted)
    <span class="java&#45;keyword">return</span> converted
&#125;</pre></div><p class="paragraph"/>You can then read the values of the custom type and register them with the <code>DBObject</code>. The <code>readInternal</code> method gets passed the <code>PersistentProperty</code>, the key the user type info is stored under (although you may want to use multiple keys) and the <code>DBObject</code>:<p class="paragraph"/><div class="code"><pre>@Override
<span class="java&#45;keyword">protected</span> Birthday readInternal(PersistentProperty property, <span class="java&#45;object">String</span> key, DBObject nativeSource) &#123;
    <span class="java&#45;keyword">final</span> num = nativeSource.get(key)
    <span class="java&#45;keyword">if</span>(num <span class="java&#45;keyword">instanceof</span> <span class="java&#45;object">Long</span>) &#123;
        <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">new</span> Birthday(<span class="java&#45;keyword">new</span> Date(num))
    &#125;
    <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">null</span>
&#125;</pre></div><p class="paragraph"/>You can the construct the custom type from by reading values from the <code>DBObject</code>. Finally the <code>queryInternal</code> method allows you to handle how a custom type is queried:<p class="paragraph"/><div class="code"><pre>@Override
<span class="java&#45;keyword">protected</span> void queryInternal(PersistentProperty property, <span class="java&#45;object">String</span> key, PropertyCriterion criterion, DBObject nativeQuery) &#123;
    <span class="java&#45;keyword">if</span>(criterion <span class="java&#45;keyword">instanceof</span> Between) &#123;
        def dbo = <span class="java&#45;keyword">new</span> BasicDBObject()
        dbo.put(MongoQuery.MONGO_GTE_OPERATOR, criterion.getFrom().date.time);
        dbo.put(MongoQuery.MONGO_LTE_OPERATOR, criterion.getTo().date.time);
        nativeQuery.put(key, dbo)
    &#125;
    <span class="java&#45;keyword">else</span> <span class="java&#45;keyword">if</span>(criterion <span class="java&#45;keyword">instanceof</span> Equals)&#123;
        nativeQuery.put(key, criterion.value.date.time)
    &#125;
    <span class="java&#45;keyword">else</span> &#123;
	    <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> RuntimeException(<span class="java&#45;quote">"unsupported query type <span class="java&#45;keyword">for</span> property $property"</span>)
    &#125;
&#125;</pre></div><p class="paragraph"/>The method gets passed a <code>criterion</code> which is the type of query and depending on the type of query you may handle the query differently. For example the above implementation supports <code>between</code> and <code>equals</code> style queries. So the following 2 queries will work:<p class="paragraph"/><div class="code"><pre>Person.findByBirthday(<span class="java&#45;keyword">new</span> Birthday(<span class="java&#45;keyword">new</span> Date()&#45;7)) // find someone who was born 7 days ago
Person.findByBirthdayBetween(<span class="java&#45;keyword">new</span> Birthday(<span class="java&#45;keyword">new</span> Date()&#45;7), <span class="java&#45;keyword">new</span> Birthday(<span class="java&#45;keyword">new</span> Date())) // find someone who was born in the last 7 days</pre></div><p class="paragraph"/>However "like" or other query types will not work.


<h1 id="4. Low-level API">4 Low-level API</h1>
A lower level API is provided by the plugin that is based on the <a href="http://github.com/poiati/gmongo" target="blank">GMongo</a> project.<p class="paragraph"/>GMongo is a simple Groovy wrapper around the regular <a href="http://www.mongodb.org/display/DOCS/Java+Language+Center" target="blank">Mongo Java Driver</a>. In general you can refer to the Mongo Java Drivers <a href="http://api.mongodb.org/java/current/index.html" target="blank">Javadoc API</a> when using GMongo.<p class="paragraph"/>GMongo provides some nice enhancements like easy access to collections using the dot operator and support for Groovy operator overloading.<p class="paragraph"/><blockquote class="note">
There is an excellent tutorial on how to use the Mongo Java driver's API directly in the <a href="http://www.mongodb.org/display/DOCS/Java+Tutorial" target="blank">Mongo documentation</a>
</blockquote><p class="paragraph"/>An example of GMongo usage can be seen below:<p class="paragraph"/><div class="code"><pre>// Get a db reference in the old fashion way
def db = mongo.getDB(<span class="java&#45;quote">"gmongo"</span>)<p class="paragraph"/>// Collections can be accessed as a db property (like the javascript API)
assert db.myCollection <span class="java&#45;keyword">instanceof</span> com.mongodb.DBCollection
// They also can be accessed with array notation
assert db&#91;'my.collection'&#93; <span class="java&#45;keyword">instanceof</span> com.mongodb.DBCollection<p class="paragraph"/>// Insert a document
db.languages.insert(&#91;name: 'Groovy'&#93;)
// A less verbose way to <span class="java&#45;keyword">do</span> it
db.languages.insert(name: 'Ruby')
// Yet another way
db.languages &#60;&#60; &#91;name: 'Python'&#93;<p class="paragraph"/>// Insert a list of documents
db.languages &#60;&#60; &#91;&#91;name: 'Javascript', type: 'prototyped'&#93;, &#91;name: 'Ioke', type: 'prototyped'&#93;&#93;</pre></div><p class="paragraph"/>
To get hold of the <code>mongo</code> instance (which is an of the <a href="http://api.mongodb.org/java/current/com/mongodb/Mongo.html" target="blank">com.mongodb.Mongo</a> class) inside a controller or service simple define a <code>mongo</code> property:<p class="paragraph"/><div class="code"><pre>def mongo
def myAction = &#123;
    def db = mongo.getDB(<span class="java&#45;quote">"mongo"</span>)
    db.languages.insert(&#91;name: 'Groovy'&#93;)
&#125;</pre></div><p class="paragraph"/>A request scoped bean is also available for the default database (typically the name of your application, unless specified by the <code>databaseName</code> config option, plus the suffix "DB").<p class="paragraph"/><div class="code"><pre>def peopleDB
def myAction = &#123;
    peopleDB.languages.insert(&#91;name: 'Fred'&#93;)
&#125;</pre></div><p class="paragraph"/>Each domain class you define also has a <code>collection</code> property that allows easy access to the underlying <code>DBCollection</code> instance and hence the GMongo API:<p class="paragraph"/><div class="code"><pre>Person.collection.count() == 1
Person.collection.findOne(firstName:<span class="java&#45;quote">"Fred"</span>).lastName == <span class="java&#45;quote">"Flintstone"</span></pre></div><p class="paragraph"/><blockquote class="note">
If you are using Hibernate entities with Mongo then the collection will be scoped in the <code>mongo</code> namespace. Example: Person.mongo.collection.count()
</blockquote>



<h1 id="5. Transactions">5 Transactions</h1>
Mongo doesn't support transactions directly, however GORM for Mongo does batch up inserts and updates until the session is flushed. This makes it possible to support some rollback options.<p class="paragraph"/>You can use either transactional services or the static <code>withTransaction</code> method. To mark a service as using the Mongo transaction manager, use the static <code>transactional</code> property with the value <code>'mongo'</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">static</span> transactional = 'mongo'</pre></div><p class="paragraph"/>Alternately you can do ad-hoc transactions using the <code>withTransaction</code> method:<p class="paragraph"/><div class="code"><pre>Person.withTransaction &#123; status &#45;&#62;
    <span class="java&#45;keyword">new</span> Person(name:<span class="java&#45;quote">"Bob"</span>, age:50).save()
    <span class="java&#45;keyword">throw</span> <span class="java&#45;keyword">new</span> RuntimeException(<span class="java&#45;quote">"bad"</span>)
    <span class="java&#45;keyword">new</span> Person(name:<span class="java&#45;quote">"Fred"</span>, age:45).save()
&#125;</pre></div><p class="paragraph"/>For example in this case neither <code>Person</code> object will be persisted to the database, because underneath the surface a persistence session is being used to batch up both insert operations into a single insert. When the exception is thrown neither insert is ever executed, hence we allow for some transactional semantics are the GORM-level.<p class="paragraph"/>Using the lower level API you can of course also take advantage of Mongo's support for <a href="http://www.mongodb.org/display/DOCS/Atomic+Operations" target="blank">Atomic operations</a>.



<h1 id="6. Unit Testing">6 Unit Testing</h1>
The Mongo plugin provides a Groovy mixin called <a href="../ref/Testing/DatastoreUnitTestMixin.html" class="testing">DatastoreUnitTestMixin</a> for testing purposes. This mixin sets up a datastore implementation that operates against an in-memory <code>ConcurrentHashMap</code>. The datastore implementation that operates against an in-memory map is as complete as the one for Mongo and provides support for:
<ul class="star">
<li>Simple persistence methods</li>
<li>Dynamic finders</li>
<li>Criteria</li>
<li>Named queries</li>
<li>Inheritance</li>
</ul><p class="paragraph"/>You can easily write tests that use the mixin using Groovy's <code>Mixin</code> annotation on any existing unit test:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> grails.datastore.test.DatastoreUnitTestMixin<p class="paragraph"/>@Mixin(DatastoreUnitTestMixin)
class PersonTests <span class="java&#45;keyword">extends</span> GroovyTestCase &#123;
    void testPersist() &#123;
        mockDomain(Person)
        def s = <span class="java&#45;keyword">new</span> Person(name:<span class="java&#45;quote">"Bob"</span>)
        s.save()<p class="paragraph"/>        assert s.id != <span class="java&#45;keyword">null</span><p class="paragraph"/>        s = Person.get(s.id)<p class="paragraph"/>        assert s != <span class="java&#45;keyword">null</span>
    &#125;<p class="paragraph"/>    void tearDown() &#123;
        disconnect()
    &#125;
&#125;</pre></div><p class="paragraph"/>You should call the <code>mockDomain()</code> method to mock a domain instance and then the remainder of the API is the same. Note that you should call <code>disconnect()</code> in <code>tearDown()</code> otherwise your tests will share data.


                    </div>
                </td>
                <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Beans</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Beans/mongo.html">mongo</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Testing</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Testing/DatastoreUnitTestMixin.html">DatastoreUnitTestMixin</a>
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
        </td>
            </tr>
        </table>

        <div id="footer">
            
            
        </div>



<script type="text/javascript" src="../js/docs.js"></script>

    </body>
</html>
