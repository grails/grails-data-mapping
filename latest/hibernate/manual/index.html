<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<meta name="author" content="Graeme Rocher, Puneet Behl">
<title>GORM for Hibernate</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>GORM for Hibernate</h1>
<div class="details">
<span id="author" class="author">Graeme Rocher, Puneet Behl</span><br>
<span id="revnumber">version 8.0.2</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#releaseHistory">1.1. Release History</a></li>
<li><a href="#upgradeNotes">1.2. Upgrade Notes</a></li>
</ul>
</li>
<li><a href="#gettingStarted">2. Getting Started</a>
<ul class="sectlevel2">
<li><a href="#_common_problems">2.1. Common Problems</a></li>
<li><a href="#hibernateVersions">2.2. Configuring Different Hibernate Versions</a></li>
<li><a href="#springBoot">2.3. Using GORM in Spring Boot</a></li>
<li><a href="#outsideGrails">2.4. Using GORM for Hibernate Outside Grails</a></li>
</ul>
</li>
<li><a href="#quickStartGuide">3. Quick Start Guide</a>
<ul class="sectlevel2">
<li><a href="#basicCRUD">3.1. Basic CRUD</a></li>
</ul>
</li>
<li><a href="#configuration">4. Configuration</a>
<ul class="sectlevel2">
<li><a href="#_configuration_example">4.1. Configuration Example</a></li>
<li><a href="#_configuration_reference">4.2. Configuration Reference</a></li>
<li><a href="#_the_default_mapping_constraints">4.3. The Default Mapping &amp; Constraints</a></li>
<li><a href="#_hibernate_customization">4.4. Hibernate Customization</a></li>
</ul>
</li>
<li><a href="#domainClasses">5. Domain Modelling in GORM</a>
<ul class="sectlevel2">
<li><a href="#gormAssociation">5.1. Association in GORM</a></li>
<li><a href="#gormComposition">5.2. Composition in GORM</a></li>
<li><a href="#inheritanceInGORM">5.3. Inheritance in GORM</a></li>
<li><a href="#sets">5.4. Sets, Lists and Maps</a></li>
</ul>
</li>
<li><a href="#persistenceBasics">6. Persistence Basics</a>
<ul class="sectlevel3">
<li><a href="#_transactional_write_behind">6.1. Transactional Write-Behind</a></li>
<li><a href="#savingAndUpdating">6.2. Saving and Updating</a></li>
<li><a href="#deletingObjects">6.3. Deleting Objects</a></li>
<li><a href="#cascades">6.4. Understanding Cascading Updates and Deletes</a></li>
<li><a href="#fetching">6.5. Eager and Lazy Fetching</a></li>
<li><a href="#_configuring_eager_fetching">6.6. Configuring Eager Fetching</a></li>
<li><a href="#_altering_fetch_strategy_for_a_query">6.7. Altering Fetch Strategy for a Query</a></li>
<li><a href="#_using_batch_fetching">6.8. Using Batch Fetching</a></li>
<li><a href="#locking">6.9. Pessimistic and Optimistic Locking</a></li>
<li><a href="#modificationChecking">6.10. Modification Checking</a></li>
</ul>
</li>
<li><a href="#querying">7. Querying with GORM</a>
<ul class="sectlevel3">
<li><a href="#_listing_instances">7.1. Listing instances</a></li>
<li><a href="#_retrieval_by_database_identifier">7.2. Retrieval by Database  Identifier</a></li>
<li><a href="#finders">7.3. Dynamic Finders</a></li>
<li><a href="#whereQueries">7.4. Where Queries</a></li>
<li><a href="#criteria">7.5. Criteria</a></li>
<li><a href="#detachedCriteria">7.6. Detached Criteria</a></li>
<li><a href="#hql">7.7. Hibernate Query Language (HQL)</a></li>
</ul>
</li>
<li><a href="#advancedGORMFeatures">8. Advanced GORM Features</a>
<ul class="sectlevel2">
<li><a href="#eventsAutoTimestamping">8.1. Events and Auto Timestamping</a></li>
<li><a href="#ormdsl">8.2. Custom ORM Mapping</a></li>
<li><a href="#defaultSortOrder">8.3. Default Sort Order</a></li>
</ul>
</li>
<li><a href="#programmaticTransactions">9. Programmatic Transactions</a>
<ul class="sectlevel3">
<li><a href="#_using_the_withtransaction_method">9.1. Using the withTransaction Method</a></li>
<li><a href="#_using_transactionservice">9.2. Using TransactionService</a></li>
</ul>
</li>
<li><a href="#dataServices">10. GORM Data Services</a>
<ul class="sectlevel2">
<li><a href="#_data_service_basics">10.1. Data Service Basics</a></li>
<li><a href="#_data_service_queries">10.2. Data Service Queries</a></li>
<li><a href="#_query_joins">10.3. Query Joins</a></li>
<li><a href="#_data_service_write_operations">10.4. Data Service Write Operations</a></li>
<li><a href="#_validating_data_services">10.5. Validating Data Services</a></li>
<li><a href="#_rxjava_support">10.6. RxJava Support</a></li>
</ul>
</li>
<li><a href="#multipleDataSources">11. Multiple Data Sources</a>
<ul class="sectlevel2">
<li><a href="#_configuring_multiple_data_sources">11.1. Configuring Multiple Data Sources</a></li>
<li><a href="#_mapping_domain_classes_to_data_sources">11.2. Mapping Domain Classes to Data Sources</a></li>
<li><a href="#_data_source_namespaces">11.3. Data Source Namespaces</a></li>
<li><a href="#connectionSources">11.4. The ConnectionSources API</a></li>
</ul>
</li>
<li><a href="#multiTenancy">12. Multi-Tenancy</a>
<ul class="sectlevel2">
<li><a href="#_multi_tenancy_modes">12.1. Multi-Tenancy Modes</a></li>
<li><a href="#_multi_tenancy_transformations">12.2. Multi-Tenancy Transformations</a></li>
<li><a href="#_database_per_tenant">12.3. Database Per Tenant</a></li>
<li><a href="#_schema_per_tenant">12.4. Schema Per Tenant</a></li>
<li><a href="#_partitioned_multi_tenancy">12.5. Partitioned Multi-Tenancy</a></li>
<li><a href="#_understanding_tenant_resolvers">12.6. Understanding Tenant Resolvers</a></li>
</ul>
</li>
<li><a href="#constraints">13. Validation and Constraints</a>
<ul class="sectlevel2">
<li><a href="#_applying_constraints">13.1. Applying Constraints</a></li>
<li><a href="#_referencing_instances_in_constraints">13.2. Referencing Instances in Constraints</a></li>
<li><a href="#_cascade_constraints_validation">13.3. Cascade constraints validation</a></li>
<li><a href="#_constraints_reference">13.4. Constraints Reference</a></li>
<li><a href="#_constraints_and_database_mapping">13.5. Constraints and Database Mapping</a></li>
</ul>
</li>
<li><a href="#testing">14. GORM and Testing</a>
<ul class="sectlevel2">
<li><a href="#_unit_testing_with_spock">14.1. Unit Testing with Spock</a></li>
<li><a href="#_unit_testing_with_junit">14.2. Unit Testing with JUnit</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GORM is a data access framework with multiple backend implementations that allows you to rapidly write data access code with little effort for your favourite database.</p>
</div>
<div class="paragraph">
<p>There are currently several implementations of GORM. This documentation covers the original implementation of GORM which is based on the Hibernate ORM. Below you can find links to the other implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://gorm.grails.org/latest/mongodb/manual">GORM for MongoDB</a></p>
</li>
<li>
<p><a href="https://gorm.grails.org/latest/neo4j/manual">GORM for Neo4j</a></p>
</li>
<li>
<p><a href="https://gorm.grails.org/latest/cassandra/manual">GORM for Cassandra</a></p>
</li>
<li>
<p><a href="https://gorm.grails.org/latest/rx/manual">RxGORM for MongoDB</a></p>
</li>
<li>
<p><a href="https://gorm.grails.org/latest/rx/rest-client/manual">RxGORM for REST</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As mentioned, GORM for Hibernate is the original implementation of GORM and has evolved dramatically over the years from a few meta-programming functions into a complete data access framework with multiple implementations for different datastores relational and NoSQL.</p>
</div>
<div class="sect2">
<h3 id="releaseHistory">1.1. Release History</h3>
<div class="sect3">
<h4 id="_gorm_7_1">1.1.1. GORM 7.1</h4>
<div class="ulist">
<ul>
<li>
<p>GORM 7.1 brings support for Apache Groovy 3</p>
</li>
<li>
<p>Default autowire the bean by type in the Data Service</p>
</li>
<li>
<p>Support for Java 14</p>
</li>
<li>
<p>Spring 5.3</p>
</li>
<li>
<p>Spring Boot 2.5</p>
</li>
<li>
<p>Hibernate 5.5</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_7_0">1.1.2. GORM 7.0</h4>
<div class="paragraph">
<p>GORM 7.0 brings support for the latest versions of key dependencies including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java 8 minimum (Java 11 supported)</p>
</li>
<li>
<p>Hibernate 5.3 minimum</p>
</li>
<li>
<p>Spring 5.2 minimum</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_6_1">1.1.3. GORM 6.1</h4>
<div class="paragraph">
<p>GORM 6.1 includes a variety of enhancements to GORM 6.0 including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GORM Data Services</p>
</li>
<li>
<p>Multi-Tenancy Transformations</p>
</li>
<li>
<p>Support for Bean Validation API</p>
</li>
<li>
<p>Built-in Package Scanning</p>
</li>
<li>
<p>JPA Annotation Mapping Support</p>
</li>
<li>
<p>Hibernate transformations for dirty checking, managed entities and so on</p>
</li>
<li>
<p>HQL &amp; SQL query escaping for GString queries</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the <a href="https://gorm.grails.org/6.1.x/whatsNew/manual">What&#8217;s New in GORM 6.1</a> guide for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_6_0">1.1.4. GORM 6.0</h4>
<div class="paragraph">
<p>GORM 6.0 continues to evolve the new trait based model and includes the following new features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Support for MongoDB 3.2.x drivers</p>
</li>
<li>
<p>Support for Neo4j 3.x drivers</p>
</li>
<li>
<p>Unified configuration model across all implementations</p>
</li>
<li>
<p>Unified Multiple Data Sources support for Hibernate, MongoDB and Neo4j</p>
</li>
<li>
<p>Multi Tenancy support for Hibernate, MongoDB and Neo4j</p>
</li>
<li>
<p>RxGORM for MongoDB built on MongoDB Rx drivers</p>
</li>
<li>
<p>RxGORM for REST built on RxNetty</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_5_0">1.1.5. GORM 5.0</h4>
<div class="paragraph">
<p>GORM 5.0 replaced the majority of the custom AST transformations that power GORM with <a href="https://docs.groovy-lang.org/next/html/documentation/core-traits.html">Groovy Traits</a>.</p>
</div>
<div class="paragraph">
<p>Support for the MongoDB 3.x drivers, Neo4j 2.3.x and Hibernate 5.x was added.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_4_0">1.1.6. GORM 4.0</h4>
<div class="paragraph">
<p>GORM 4.0 continued to separate the GORM API from the Grails core APIs and was the first version to be support standalone execution outside of Grails.</p>
</div>
<div class="paragraph">
<p>GORM 4.0 was released in conjunction with Grails 3.0 and also featured auto configuration starters for Spring Boot.</p>
</div>
<div class="paragraph">
<p>Support was introduced for MongoDB 2.x drivers, Neo4j 2.2.x and Hibernate 4.3.x.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_3_0">1.1.7. GORM 3.0</h4>
<div class="paragraph">
<p>GORM 3.0 was the first release of GORM that was released separately to the Grails framework itself and was introduced in Grails 2.1.</p>
</div>
<div class="paragraph">
<p>More of the metaprogramming functions were refactored and replaced with AST transformations and APIs introduced that allowed GORM to operate against multiple database implementations including MongoDB.</p>
</div>
<div class="paragraph">
<p>The GORM API was separated from Hibernate and an SDK and TCK released for building compatible implementations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_2_0">1.1.8. GORM 2.0</h4>
<div class="paragraph">
<p>GORM 2.0 evolved as part of Grails 2.0 and re-engineered some of the metaprogramming logic that relied on ExpandoMetaClass into a set of <a href="https://groovy-lang.org/metaprogramming.html#_compile_time_metaprogramming">Groovy AST transformations</a>.</p>
</div>
<div class="paragraph">
<p>These AST transformations relied on the Grails 2.x compiler infrastructure and hence this version of GORM was also only usable from within Grails.</p>
</div>
</div>
<div class="sect3">
<h4 id="_gorm_1_0">1.1.9. GORM 1.0</h4>
<div class="paragraph">
<p>The first version of GORM was a series of meta-programming functions that built on the capabilities of Groovy&#8217;s <a href="https://groovy-lang.org/metaprogramming.html#metaprogramming_emc">ExpandoMetaClass</a>.</p>
</div>
<div class="paragraph">
<p>It was purely dynamic and integrated into the <a href="https://grails.org">Grails framework</a> and not usable without Grails and hence no actual distribution exists for this version and it is only available as part of Grails.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="upgradeNotes">1.2. Upgrade Notes</h3>
<div class="sect3">
<h4 id="_dependency_upgrades">1.2.1. Dependency Upgrades</h4>
<div class="paragraph">
<p>GORM 7.1 supports Apache Groovy 3 and Java 14 Hibernate 5.5.x and Spring 5.3.x.</p>
</div>
<div class="paragraph">
<p>Each of these underlying components may have changes that require altering your application. These changes are beyond the scope of this documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_default_autowire_by_type_inside_gorm_data_services">1.2.2. Default Autowire By Type inside GORM Data Services</h4>
<div class="paragraph">
<p>A Grails Service (or a bean) inside GORM DataService will default to autowire by-type, For example:</p>
</div>
<div class="paragraph">
<p><em>./grails-app/services/example/BookService.groovy</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>package example

import grails.gorm.services.Service

@Service(Book)
abstract class BookService {

    TestService testRepo

    abstract Book save(String title, String author)

    void doSomething() {
        assert testRepo != null
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note that with autowire by-type as the default, when multiple beans for same type are found the application with throw Exception. Use the Spring `@Qualifier annotation for <a href="https://docs.spring.io/spring-framework/docs/5.3.10/reference/html/core.html#beans-autowired-annotation-qualifiers">Fine-tuning Annotation Based Autowiring with Qualifiers</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gettingStarted">2. Getting Started</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use GORM 8.0.2 for Hibernate in Grails 3 you can specify the following configuration in <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    compile "org.grails.plugins:hibernate5:8.0.2"
    compile "org.hibernate:hibernate-ehcache"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are using a version of Grails 3 earlier than 3.3 then you may need to enforce the GORM version. If you are using Grails 3.2.7 or above this can be done by modifying the <code>gormVersion</code> setting in <code>gradle.properties</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">gormVersion=8.0.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise if you are using an earlier version of Grails you can force the GORM version by adding the following block directly above the <code>dependencies</code> block:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">configurations.all {
    resolutionStrategy.eachDependency { DependencyResolveDetails details ->
        if( details.requested.group == 'org.grails' &&
            details.requested.name.startsWith('grails-datastore')) {
            details.useVersion("8.0.2")
        }
    }
}
dependencies {
    ...
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_common_problems">2.1. Common Problems</h3>
<div class="paragraph">
<p>If you receive an error that indicates a failure to resolve the <code>grails-datastore-simple</code> dependency you may need to add the following to <code>build.gradle</code> directly above the <code>dependencies</code> block:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">configurations.all {
    exclude <span class="key">module</span>:<span class="string"><span class="delimiter">'</span><span class="content">grails-datastore-simple</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hibernateVersions">2.2. Configuring Different Hibernate Versions</h3>
<div class="paragraph">
<p>There are various changes you have to make to your build depending on the version of Grails when using GORM 8.0.2.</p>
</div>
<div class="sect3">
<h4 id="_grails_3_2_x_and_above_with_hibernate_4">2.2.1. Grails 3.2.x and above with Hibernate 4</h4>
<div class="paragraph">
<p>Grails 3.2.x is based on Spring Boot 1.4.x which enforces Hibernate 5.0.x as the default version. If you want to continue to use Hibernate 4 you must explicitly declare the Hibernate 4 dependences in <code>build.gradle</code>.</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:hibernate4</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate:hibernate-core:4.3.10.Final</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate:hibernate-ehcache:4.3.10.Final</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grails_3_1_x_and_below_with_hibernate_5">2.2.2. Grails 3.1.x and below with Hibernate 5</h4>
<div class="paragraph">
<p>Grails 3.1.x and below are based on Spring Boot 1.3.x which enforces Hibernate 4 as the default version of Hibernate, hence you have to use explicit versions to depend on Hibernate 5:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.grails.plugins:hibernate5</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate:hibernate-core:5.1.0.Final</span><span class="delimiter">&quot;</span></span>
    compile <span class="string"><span class="delimiter">&quot;</span><span class="content">org.hibernate:hibernate-ehcache:5.1.0.Final</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_grails_3_0_x_spring_version_conflicts">2.2.3. Grails 3.0.x Spring Version Conflicts</h4>
<div class="paragraph">
<p>Grails 3.0.x enforces Spring 4.1.x as the Spring version, so if you want to use Hibernate 5 you must force an upgrade to Spring 4.2.x in <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// the below is unnecessary in Grails 3.1 and above, but required in Grails 3.0.x</span>
configurations.all {
    resolutionStrategy {
        eachDependency { DependencyResolveDetails details -&gt;
            <span class="keyword">if</span>(details.requested.group == <span class="string"><span class="delimiter">'</span><span class="content">org.springframework</span><span class="delimiter">'</span></span>) {
                details.useVersion(<span class="string"><span class="delimiter">'</span><span class="content">4.2.3.RELEASE</span><span class="delimiter">'</span></span>)
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>resolutionStrategy</code> is needed to enforce an upgrade to Spring 4.2.x which is required by Hibernate 5 support. This block is not needed if you are using Grails 3.1 or above.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="springBoot">2.3. Using GORM in Spring Boot</h3>
<div class="paragraph">
<p>To use GORM for Hibernate in Spring Boot add the necessary dependencies to your Boot application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">compile("org.grails:gorm-hibernate5-spring-boot:8.0.2")
compile "org.hibernate:hibernate-core"
compile "org.hibernate:hibernate-ehcache"
runtime "com.h2database:h2:1.4.192"
// for MySQL
// runtime "mysql:mysql-connector-java"

// for connection pooling
runtime "org.apache.tomcat:tomcat-jdbc:8.5.0"
runtime "org.apache.tomcat.embed:tomcat-embed-logging-log4j:8.5.0"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then ensure you have configured a <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-sql.html">datasource and Hibernate as per the Spring Boot guide</a>. For example in the case of MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">hibernate</span>:
    <span class="key">hbm2ddl</span>:
        <span class="key">auto</span>: <span class="string"><span class="content">update</span></span>
    <span class="key">dialect</span>: <span class="string"><span class="content">org.hibernate.dialect.MySQL5InnoDBDialect</span></span>
<span class="key">spring</span>:
    <span class="key">datasource</span>:
        <span class="key">driverClassName</span>: <span class="string"><span class="content">com.mysql.jdbc.Driver</span></span>
        <span class="key">url</span>:   <span class="string"><span class="content">jdbc:mysql://127.0.0.1:3306/gorm</span></span>
        <span class="key">username</span>: <span class="string"><span class="content">root</span></span>
        <span class="key">password</span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If if you prefer to use the Grails way of configuring the <code>DataSource</code> (with <code>dataSource.url</code> etc.) then you can add <code>@EnableAutoConfiguration(exclude = DataSourceAutoConfiguration)</code> to your <code>Application</code> class, which will allow GORM to take over configuring the data source.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ensure your Boot <code>Application</code> class is annotated with <code>ComponentScan</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.springframework.boot.SpringApplication</span>
<span class="keyword">import</span> <span class="include">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>
<span class="keyword">import</span> <span class="include">org.springframework.context.annotation.*</span>

<span class="annotation">@Configuration</span>
<span class="annotation">@EnableAutoConfiguration</span>
<span class="annotation">@ComponentScan</span>
<span class="type">class</span> <span class="class">Application</span> {
    <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span><span class="type">[]</span> args) {
        SpringApplication.run Application, args
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Using <code>ComponentScan</code> without a value results in Boot scanning for classes in the same package or any package nested within the <code>Application</code> class package.
If your GORM entities are in a different package specify the package name as the value of the <code>ComponentScan</code> annotation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally create your GORM entities and ensure they are annotated with <code>grails.persistence.Entity</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.persistence.*</span>

<span class="annotation">@Entity</span>
<span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that Spring Boot does not include any kind of OpenSessionInView interceptor so if you try and invoke GORM methods in a Spring <code>@Controller</code> you may encounter a session not found error. To eliminate this problem make sure your <code>@Controller</code> methods are annotated with <code>@Transactional</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.springframework.transaction.annotation.Transactional</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RequestMapping</span>
<span class="keyword">import</span> <span class="include">org.springframework.web.bind.annotation.RestController</span>

<span class="annotation">@RestController</span>
<span class="type">class</span> <span class="class">PersonController</span> {

    <span class="annotation">@RequestMapping</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">/people</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Transactional</span>(readOnly = <span class="predefined-constant">true</span>)
    <span class="directive">public</span> <span class="predefined-type">List</span>&lt;<span class="predefined-type">String</span>&gt; people() {
        Person.list().collect { Person p -&gt;
            <span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>p</span><span class="content">.firstName </span><span class="inline"><span class="inline-delimiter">$</span>p</span><span class="content">.lastName</span><span class="delimiter">&quot;</span></span>.toString()
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition, if you wish to return a GORM instance from a Spring <code>@Controller</code>, it should be noted that Spring uses Jackson for JSON marshalling, and Jackson will attempt to marshal the entire object to JSON, which can present an issue since GORM adds additional persistence related properties to your domain instance. To resolve this issue you should use <code>@JsonIgnoreProperties</code> on your GORM entity class to ignore any properties added by GORM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.persistence.*</span>
<span class="keyword">import</span> <span class="include">com.fasterxml.jackson.annotation.JsonIgnoreProperties</span>

<span class="annotation">@Entity</span>
<span class="annotation">@JsonIgnoreProperties</span>([<span class="string"><span class="delimiter">'</span><span class="content">dirtyPropertyNames</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">errors</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">dirty</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">attached</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">version</span><span class="delimiter">'</span></span>])
<span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="outsideGrails">2.4. Using GORM for Hibernate Outside Grails</h3>
<div class="paragraph">
<p>If you wish to use GORM for Hibernate outside of a Grails application you should declare the necessary dependencies for GORM and the database you are using, for example in Gradle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">compile "org.grails:grails-datastore-gorm-hibernate5:8.0.2"
runtime "com.h2database:h2:1.4.192"
runtime "org.apache.tomcat:tomcat-jdbc:8.5.0"
runtime "org.apache.tomcat.embed:tomcat-embed-logging-log4j:8.5.0"
runtime "org.slf4j:slf4j-api:1.7.10"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The above example also uses the <a href="https://www.h2database.com">H2 Database</a> and Tomcat connection pool.
However other pool implementations are supported including <code>commons-dbcp</code>, <code>tomcat pool</code> or <code>hikari</code>.
If a connection pool is not specified <code>org.springframework.jdbc.datasource.DriverManagerDataSource</code> is used,
which creates a new connection to the database each time you request a connect.
The latter will probably cause issues with an H2 in-memory database in that it will create a new in-memory
database each time a connection is requested, losing previously created tables.
Normal databases (<code>MySql</code>, <code>Postgres</code> or even file-based <code>H2</code>) are not affected.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then create your entities in the <code>src/main/groovy</code> directory and annotate them with the <code>grails.gorm.annotation.Entity</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Entity</span>
<span class="type">class</span> <span class="class">Person</span> <span class="directive">implements</span> GormEntity&lt;Person&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName
    <span class="directive">static</span> constraints = {
        firstName <span class="key">blank</span>:<span class="predefined-constant">false</span>
        lastName <span class="key">blank</span>:<span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use of <code>GormEntity</code> is merely to aid IDE support outside of Grails.
When used inside a Grails context, some IDEs will use the
<code>grails-app/domain</code> location as a hint to enable code completion.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then you need to place the bootstrap logic somewhere in your application which uses <code>HibernateDatastore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.grails.orm.hibernate.HibernateDatastore</span>
<span class="predefined-type">Map</span> configuration = [
    <span class="string"><span class="delimiter">'</span><span class="content">hibernate.hbm2ddl.auto</span><span class="delimiter">'</span></span>:<span class="string"><span class="delimiter">'</span><span class="content">create-drop</span><span class="delimiter">'</span></span>,
    <span class="string"><span class="delimiter">'</span><span class="content">dataSource.url</span><span class="delimiter">'</span></span>:<span class="string"><span class="delimiter">'</span><span class="content">jdbc:h2:mem:myDB</span><span class="delimiter">'</span></span>
]
HibernateDatastore datastore = <span class="keyword">new</span> HibernateDatastore( configuration, Person)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on how to configure GORM see the <a href="#configuration">Configuration</a> section.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quickStartGuide">3. Quick Start Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A domain class can be created with the <code>create-domain-class</code> command if you are using Grails, or if you are not using Grails you can just create the <code>.groovy</code> file manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails create-domain-<span class="type">class</span> <span class="class">helloworld</span>.Person</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create a class at the location <code>grails-app/domain/helloworld/Person.groovy</code> such as the one below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> helloworld

<span class="type">class</span> <span class="class">Person</span> {
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you have the configured the <code>dataSource.dbCreate</code> property and set it to "update", "create" or "create-drop", GORM will automatically generate/modify the database tables for you.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can customize the class by adding properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> name
    <span class="predefined-type">Integer</span> age
    <span class="predefined-type">Date</span> lastVisit
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have a domain class try and manipulate it with <code>console</code> command in Grails by typing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails console</code></pre>
</div>
</div>
<div class="paragraph">
<p>This loads an interactive GUI where you can run Groovy commands with access to the Spring ApplicationContext, GORM, etc.</p>
</div>
<div class="paragraph">
<p>Or if you are not using Grails here is a unit test template (using <a href="https://docs.spockframework.org">Spock</a>) that can be run to test out the examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">spock.lang.*</span>
<span class="keyword">import</span> <span class="include">grails.gorm.annotation.Entity</span>
<span class="keyword">import</span> <span class="include">grails.transaction.Rollback</span>
<span class="keyword">import</span> <span class="include">org.grails.orm.hibernate.HibernateDatastore</span>
<span class="keyword">import</span> <span class="include">org.springframework.transaction.PlatformTransactionManager</span>

<span class="type">class</span> <span class="class">ExampleSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Shared</span> <span class="annotation">@AutoCleanup</span> HibernateDatastore hibernateDatastore
    <span class="annotation">@Shared</span> PlatformTransactionManager transactionManager

    <span class="type">void</span> setupSpec() {
       hibernateDatastore = <span class="keyword">new</span> HibernateDatastore(Person)
       transactionManager = hibernateDatastore.getTransactionManager()
    }

    <span class="annotation">@Rollback</span>
    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test execute GORM standalone in a unit test</span><span class="delimiter">&quot;</span></span>() {
       <span class="comment">// your logic here</span>
    }
}

<span class="annotation">@Entity</span>
<span class="type">class</span> <span class="class">Person</span> {
    ...
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="basicCRUD">3.1. Basic CRUD</h3>
<div class="paragraph">
<p>Try performing some basic CRUD (Create/Read/Update/Delete) operations.</p>
</div>
<div class="sect3">
<h4 id="_create">3.1.1. Create</h4>
<div class="paragraph">
<p>To create a domain class use Map constructor to set its properties and call the <code>save()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = <span class="keyword">new</span> Person(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>, <span class="key">age</span>: <span class="integer">40</span>, <span class="key">lastVisit</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>())
p.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="../api/org/grails/datastore/gorm/GormEntity.html#save()">save()</a> method will persist your class to the database using the underlying Hibernate ORM layer.</p>
</div>
<div class="paragraph">
<p>The <code>save()</code> method is defined by the <a href="../api/org/grails/datastore/gorm/GormEntity.html">GormEntity</a> trait.</p>
</div>
</div>
<div class="sect3">
<h4 id="_read">3.1.2. Read</h4>
<div class="paragraph">
<p>GORM transparently adds an implicit <code>id</code> property to your domain class which you can use for retrieval:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
<span class="keyword">assert</span> <span class="integer">1</span> == p.id</code></pre>
</div>
</div>
<div class="paragraph">
<p>This uses the static <a href="../api/org/grails/datastore/gorm/GormEntity.html#get(java.io.Serializable)">get(id)</a> method that expects a database identifier to read the <code>Person</code> object back from the database.</p>
</div>
<div class="paragraph">
<p>You can also load an object in a read-only state by using the <code>read(id)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.read(<span class="integer">1</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the underlying Hibernate engine will not do any dirty checking and the object will not be persisted. Note that if you explicitly call the <code>save()</code> method then the object is placed back into a read-write state.</p>
</div>
<div class="paragraph">
<p>In addition, you can also load a proxy for an instance by using the <code>load(id)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def p = Person.load(<span class="integer">1</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This incurs no database access until a method other than getId() is called. Hibernate then initializes the proxied instance, or
throws an exception if no record is found for the specified id.</p>
</div>
</div>
<div class="sect3">
<h4 id="_update">3.1.3. Update</h4>
<div class="paragraph">
<p>To update an instance, change some properties and then call <code>save()</code> again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
p.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Bob</span><span class="delimiter">&quot;</span></span>
p.save()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delete">3.1.4. Delete</h4>
<div class="paragraph">
<p>To delete an instance use the <a href="../api/org/grails/datastore/gorm/GormEntity.html#delete()">delete()</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
p.delete()</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">4. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GORM for Hibernate can be configured with the <code>grails-app/conf/application.yml</code> file when using Grails, the <code>src/main/resources/application.yml</code> file when using Spring Boot or by passing a <code>Map</code> or instanceof the <code>PropertyResolver</code> interface to the <code>org.grails.orm.hibernate.HibernateDatastore</code> class when used standalone.</p>
</div>
<div class="paragraph">
<p>All configuration options are read and materialized into an instance of <a href="../api/org/grails/orm/hibernate/connections/HibernateConnectionSourceSettings.html">HibernateConnectionSourceSettings</a>.</p>
</div>
<div class="sect2">
<h3 id="_configuration_example">4.1. Configuration Example</h3>
<div class="paragraph">
<p>If you are using Grails or Spring Boot, the following is an example of configuration specified in <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">dataSource</span>:
    <span class="key">pooled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">dbCreate</span>: <span class="string"><span class="content">create-drop</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:devDb</span></span>
    <span class="key">driverClassName</span>: <span class="string"><span class="content">org.h2.Driver</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">sa</span></span>
    <span class="key">password</span>:
<span class="key">hibernate</span>:
    <span class="key">cache</span>:
        <span class="key">queries</span>: <span class="string"><span class="content">false</span></span>
        <span class="key">use_second_level_cache</span>: <span class="string"><span class="content">true</span></span>
        <span class="key">use_query_cache</span>: <span class="string"><span class="content">false</span></span>
        <span class="key">region.factory_class</span>: <span class="string"><span class="content">org.hibernate.cache.ehcache.EhCacheRegionFactory</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each one of the settings under the <code>dataSource</code> block is set on the <a href="../api/org/grails/datastore/gorm/jdbc/connections/DataSourceSettings.html">DataSourceSettings</a> property of <code>HibernateConnectionSourceSettings</code>.</p>
</div>
<div class="paragraph">
<p>Whilst each setting under the <code>hibernate</code> block is set on the <a href="../api/org/grails/orm/hibernate/connections/HibernateConnectionSourceSettings.HibernateSettings.html">HibernateSettings</a> property.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_reference">4.2. Configuration Reference</h3>
<div class="paragraph">
<p>You can refer to the <a href="../api/org/grails/orm/hibernate/connections/HibernateConnectionSourceSettings.html">HibernateConnectionSourceSettings</a> class for all available configuration options, but below is a table of the common ones:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">name</th>
<th class="tableblock halign-left valign-top">description</th>
<th class="tableblock halign-left valign-top">default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grails.gorm.flushMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The flush mode to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COMMIT</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grails.gorm.failOnError</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to throw an exception on validation error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grails.gorm.default.mapping</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default mapping to apply to all classes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grails.gorm.default.constraints</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The default constraints to apply to all classes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grails.gorm.multiTenancy.mode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The multi tenancy mode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following are common configuration options for the SQL connection:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">name</th>
<th class="tableblock halign-left valign-top">description</th>
<th class="tableblock halign-left valign-top">default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JDBC url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jdbc:h2:mem:grailsDB</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.driverClassName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The class of the JDBC driver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">detected from URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.username</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JDBC username</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.password</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The JDBC password</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.jndiName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the JNDI resource for the <code>DataSource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.pooled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the connection is pooled</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.lazy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether a <code>LazyConnectionDataSourceProxy</code> should be used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.transactionAware</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether a <code>TransactionAwareDataSourceProxy</code> should be used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.readOnly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the DataSource is read-only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>dataSource.options</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A map of options to pass to the underlying JDBC driver</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>null</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And the following are common configuration options for Hibernate:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">name</th>
<th class="tableblock halign-left valign-top">description</th>
<th class="tableblock halign-left valign-top">default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.dialect</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hibernate dialect to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">detected automatically from DataSource</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.readOnly</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether Hibernate should be read-only</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.configClass</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The configuration class to use</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HibernateMappingContextConfiguration</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.hbm2ddl.auto</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to create the tables on startup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.use_second_level_cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to use the second level cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.queries</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to cache queries (see Caching Queries)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.cache.use_query_cache</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enables the query cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.configLocations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Location of additional Hibernate XML configuration files</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>hibernate.packagesToScan</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In addition, any additional settings that start with <code>hibernate.</code> are passed through to Hibernate, so if there is any specific feature of Hibernate you wish to configure that is possible.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The above table covers the common configuration options. For all configuration refer to properties of the <a href="../api/org/grails/orm/hibernate/connections/HibernateConnectionSourceSettings.html">HibernateConnectionSourceSettings</a> class.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_the_default_mapping_constraints">4.3. The Default Mapping &amp; Constraints</h3>
<div class="paragraph">
<p>The <code>grails.gorm.default.mapping</code> and <code>grails.gorm.default.constraints</code> settings deserve special mention. These define the default <a href="#ormdsl">ORM mapping</a> and the default <a href="#constraints">Validation Constraints</a> used by each entity.</p>
</div>
<div class="sect3">
<h4 id="_altering_the_default_database_mapping">4.3.1. Altering the Default Database Mapping</h4>
<div class="paragraph">
<p>You may have reason to want to change how all domain classes map to the database. For example, by default GORM uses the <code>native</code> id generation strategy of the database, whether that be an auto-increment column or a sequence.</p>
</div>
<div class="paragraph">
<p>If you wish to globally change all domain classes to use a <code>uuid</code> strategy then you can specify that in the default mapping:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails.gorm.default.mapping = {
        cache <span class="predefined-constant">true</span>
        id <span class="key">generator</span>:<span class="string"><span class="delimiter">'</span><span class="content">uuid</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see you can assign a closure that is equivalent to the <code>mapping</code> block used to <a href="#ormdsl">customize how a domain class maps to a database table</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because the setting is Groovy configuration it must go into a Groovy-aware configuration format. This can be <code>grails-app/conf/application.groovy</code> in Grails, or <code>src/main/resources/application.groovy</code> in Spring Boot.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_altering_the_default_constraints">4.3.2. Altering the Default Constraints</h4>
<div class="paragraph">
<p>For validation, GORM applies a default set of <a href="#constraints">constraints</a> to all domain classes.</p>
</div>
<div class="paragraph">
<p>For example, by default all properties of GORM classes are not nullable by default. This means a value has to be supplied for each property, otherwise you will get a validation error.</p>
</div>
<div class="paragraph">
<p>In most cases this is what you want, but if you are dealing with a large number of columns, it may prove inconvinient.</p>
</div>
<div class="paragraph">
<p>You can alter the default constraints using Groovy configuration using the <code>grails.gorm.default.constraints</code> setting:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails.gorm.default.constraints = {
    <span class="string"><span class="delimiter">'</span><span class="content">*</span><span class="delimiter">'</span></span>(<span class="key">nullable</span>: <span class="predefined-constant">true</span>, <span class="key">size</span>: <span class="integer">1</span>..<span class="integer">20</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, all properties are allowed to be <code>nullable</code> by default, but limited to a size of between 1 and 20.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hibernate_customization">4.4. Hibernate Customization</h3>
<div class="paragraph">
<p>If you want to hook into GORM and customize how Hibernate is configured there are a variety of ways to achieve that when using GORM.</p>
</div>
<div class="paragraph">
<p>Firstly, as mentioned previously, any configuration you specify when configuring GORM for Hibernate will be passed through to Hibernate so you can configure any setting of Hibernate itself.</p>
</div>
<div class="paragraph">
<p>For more advanced configuration you may want to configure or supply a new <a href="../api/org/grails/orm/hibernate/connections/HibernateConnectionSourceFactory.html">HibernateConnectionSourceFactory</a> instance or a <a href="../api/org/grails/orm/hibernate/cfg/HibernateMappingContextConfiguration.html">HibernateMappingContextConfiguration</a> or both.</p>
</div>
<div class="sect3">
<h4 id="_the_hibernateconnectionsourcefactory">4.4.1. The HibernateConnectionSourceFactory</h4>
<div class="paragraph">
<p>The <code>HibernateConnectionSourceFactory</code> is used to create a new Hibernate <code>SessionFactory</code> on startup.</p>
</div>
<div class="paragraph">
<p>If you are using Spring, it is registered as a Spring bean using the name <code>hibernateConnectionSourceFactory</code> and therefore can be overridden.</p>
</div>
<div class="paragraph">
<p>If you are not using Spring it can be passed to the constructor of the <code>HibernateDatastore</code> class on instantiation.</p>
</div>
<div class="paragraph">
<p>The <code>HibernateConnectionSourceFactory</code> has a few useful setters that allow you to specify a Hibernate <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/Interceptor.html">Interceptor</a> or <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/boot/spi/MetadataContributor.html">MetadataContributor</a> (Hibernate 5+ only).</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_hibernatemappingcontextconfiguration">4.4.2. The HibernateMappingContextConfiguration</h4>
<div class="paragraph">
<p><a href="../api/org/grails/orm/hibernate/cfg/HibernateMappingContextConfiguration.html">HibernateMappingContextConfiguration</a> is built by the <code>HibernateConnectionSourceFactory</code>, but a customized version can be specified using the <code>hibernate.configClass</code> setting in your configuration:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.yml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">hibernate</span>:
<span class="error">        </span><span class="key">configClass</span>: <span class="string"><span class="content">com.example.MyHibernateMappingContextConfiguration</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The customized version should extend <code>HibernateMappingContextConfiguration</code> and using this class you can add additional classes, packages, <code>hbm.cfg.xml</code> files and so on.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domainClasses">5. Domain Modelling in GORM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When building applications you have to consider the problem domain you are trying to solve. For example if you were building an <a href="https://www.amazon.com/">Amazon</a>-style bookstore you would be thinking about books, authors, customers and publishers to name a few.</p>
</div>
<div class="paragraph">
<p>These are modeled in GORM as Groovy classes, so a <code>Book</code> class may have a title, a release date, an ISBN number and so on. The next few sections show how to model the domain in GORM.</p>
</div>
<div class="paragraph">
<p>Consider the following domain class:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/domain/org/bookstore/Book.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> org.bookstore

<span class="type">class</span> <span class="class">Book</span> {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This class will map automatically to a table in the database called <code>book</code> (the same name as the class).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This behaviour is customizable through the <a href="#ormdsl">ORM Domain Specific Language</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now that you have a domain class you can define its properties as Java types. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> org.bookstore

<span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> title
    <span class="predefined-type">Date</span> releaseDate
    <span class="predefined-type">String</span> ISBN
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each property is mapped to a column in the database, where the convention for column names is all lower case separated by underscores. For example <code>releaseDate</code> maps onto a column <code>release_date</code>. The SQL types are auto-detected from the Java types, but can be customized with <a href="#constraints">Constraints</a> or the <a href="#ormdsl">ORM DSL</a>.</p>
</div>
<div class="sect2">
<h3 id="gormAssociation">5.1. Association in GORM</h3>
<div class="paragraph">
<p>Relationships define how domain classes interact with each other. Unless specified explicitly at both ends, a relationship exists only in the direction it is defined.</p>
</div>
<div class="sect3">
<h4 id="manyToOneAndOneToOne">5.1.1. Many-to-one and one-to-one</h4>
<div class="paragraph">
<p>A many-to-one relationship is the simplest kind, and is defined with a property of the type of another domain class. Consider this example:</p>
</div>
<div class="sect4">
<h5 id="_example_a">Example A</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Face</span> {
    Nose nose
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Nose</span> {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we have a unidirectional many-to-one relationship from <code>Face</code> to <code>Nose</code>. To make this relationship bidirectional define the other side as follows (and see the section on controlling the ends of the association just below):</p>
</div>
</div>
<div class="sect4">
<h5 id="_example_b">Example B</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Face</span> {
    Nose nose
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Nose</span> {
    <span class="directive">static</span> belongsTo = [<span class="key">face</span>:Face]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we use the <code>belongsTo</code> setting to say that <code>Nose</code> "belongs to" <code>Face</code>. The result of this is that we can create a <code>Face</code>, attach a <code>Nose</code> instance to it and when we save or delete the <code>Face</code> instance, GORM will save or delete the <code>Nose</code>. In other words, saves and deletes will cascade from <code>Face</code> to the associated <code>Nose</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> Face(<span class="key">nose</span>:<span class="keyword">new</span> Nose()).save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above will save both face and nose. Note that the inverse <em>is not</em> true and will result in an error due to a transient <code>Face</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> Nose(<span class="key">face</span>:<span class="keyword">new</span> Face()).save() <span class="comment">// will cause an error</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if we delete the <code>Face</code> instance, the <code>Nose</code> will go too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> f = Face.get(<span class="integer">1</span>)
f.delete() <span class="comment">// both Face and Nose deleted</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To make the relationship a true one-to-one, use the <code>hasOne</code> property on the owning side, e.g. <code>Face</code>:</p>
</div>
</div>
<div class="sect4">
<h5 id="_example_c">Example C</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Face</span> {
    <span class="directive">static</span> hasOne = [<span class="key">nose</span>:Nose]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Nose</span> {
    Face face
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that using this property puts the foreign key on the inverse table to the example A, so in this case the foreign key column is stored in the <code>nose</code> table inside a column called <code>face_id</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>hasOne</code> only works with bidirectional relationships.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally, it&#8217;s a good idea to add a unique constraint on one side of the one-to-one relationship:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Face</span> {
    <span class="directive">static</span> hasOne = [<span class="key">nose</span>:Nose]

    <span class="directive">static</span> constraints = {
        nose <span class="key">unique</span>: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Nose</span> {
    Face face
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_controlling_the_ends_of_the_association">Controlling the ends of the association</h5>
<div class="paragraph">
<p>Occasionally you may find yourself with domain classes that have multiple properties of the same type. They may even be self-referential, i.e. the association property has the same type as the domain class it&#8217;s in. Such situations can cause problems because GORM may guess incorrectly the type of the association. Consider this simple class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> name
    Person parent

    <span class="directive">static</span> belongsTo = [ <span class="key">supervisor</span>: Person ]

    <span class="directive">static</span> constraints = { supervisor <span class="key">nullable</span>: <span class="predefined-constant">true</span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As far as GORM is concerned, the <code>parent</code> and <code>supervisor</code> properties are two directions of the same association. So when you set the <code>parent</code> property on a <code>Person</code> instance, GORM will automatically set the <code>supervisor</code> property on the other <code>Person</code> instance. This may be what you want, but if you look at the class, what we in fact have are two unidirectional relationships.</p>
</div>
<div class="paragraph">
<p>To guide GORM to the correct mapping, you can tell it that a particular association is unidirectional through the <code>mappedBy</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> name
    Person parent

    <span class="directive">static</span> belongsTo = [ <span class="key">supervisor</span>: Person ]

    <span class="directive">static</span> mappedBy = [ <span class="key">supervisor</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span>, <span class="key">parent</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span> ]

    <span class="directive">static</span> constraints = { supervisor <span class="key">nullable</span>: <span class="predefined-constant">true</span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also replace "none" with any property name of the target class. And of course this works for normal domain classes too, not just self-referential ones. Nor is the <code>mappedBy</code> property limited to many-to-one and one-to-one associations: it also works for one-to-many and many-to-many associations as you&#8217;ll see in the next section.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have a property called "none" on your domain class, this approach won&#8217;t work currently! The "none" property will be treated as the reverse direction of the association (or the "back reference"). Fortunately, "none" is not a common domain class property name.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_replacing_a_many_to_one_collection">Replacing a many-to-one collection</h5>
<div class="paragraph">
<p>Given these GORM entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> name
    <span class="directive">static</span> hasMany = [<span class="key">reviews</span>: Review]
}
<span class="type">class</span> <span class="class">Review</span> {
    <span class="predefined-type">String</span> author
    <span class="predefined-type">String</span> quote
    <span class="directive">static</span> belongsTo = [<span class="key">book</span>: <span class="predefined-type">Book</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Imagine you have a book with two reviews:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">name</span>: <span class="string"><span class="delimiter">'</span><span class="content">Daemon</span><span class="delimiter">'</span></span>)
                .addToReviews(<span class="keyword">new</span> Review(<span class="key">quote</span>: <span class="string"><span class="delimiter">'</span><span class="content">Daemon does for surfing the Web what Jaws did for swimming in the ocean.</span><span class="delimiter">'</span></span>, <span class="key">author</span>: <span class="string"><span class="delimiter">'</span><span class="content">Chicago Sun-Times</span><span class="delimiter">'</span></span>))
                .addToReviews(<span class="keyword">new</span> Review(<span class="key">quote</span>: <span class="string"><span class="delimiter">'</span><span class="content">Daemon is wet-yourself scary, tech-savvy, mind-blowing!</span><span class="delimiter">'</span></span>, <span class="key">author</span>: <span class="string"><span class="delimiter">'</span><span class="content">Paste Magazine</span><span class="delimiter">'</span></span>))
                .save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could create a method to replace the <code>reviews</code> collection as illustrated next:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Book</span> replaceReviews(<span class="predefined-type">Serializable</span> idParam, <span class="predefined-type">List</span>&lt;Review&gt; newReviews) {
    <span class="predefined-type">Book</span> book = <span class="predefined-type">Book</span>.where { id == idParam }.join(<span class="string"><span class="delimiter">'</span><span class="content">reviews</span><span class="delimiter">'</span></span>).get()
    clearReviews(book)
    newReviews.each { book.addToReviews(<span class="local-variable">it</span>) }
    book.save()
}

<span class="type">void</span> clearReviews(<span class="predefined-type">Book</span> book) {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Serializable</span>&gt; ids = <span class="type">[]</span>
    book.reviews.collect().each {
        book.removeFromReviews(<span class="local-variable">it</span>)
        ids &lt;&lt; <span class="local-variable">it</span>.id
    }
    Review.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete Review r where r.id in :ids</span><span class="delimiter">&quot;</span></span>, [<span class="key">ids</span>: ids])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively you could leverage <a href="https://docs.grails.org/latest/ref/Database%20Mapping/cascade.html">cascade</a> behaviour.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> name
    <span class="directive">static</span> hasMany = [<span class="key">reviews</span>: Review]
    <span class="directive">static</span> mappping = {
        reviews <span class="key">cascade</span>: <span class="string"><span class="delimiter">'</span><span class="content">all-delete-orphan</span><span class="delimiter">'</span></span>
    }
}
<span class="type">class</span> <span class="class">Review</span> {
    <span class="predefined-type">String</span> author
    <span class="predefined-type">String</span> quote
    <span class="directive">static</span> belongsTo = [<span class="key">book</span>: <span class="predefined-type">Book</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cascade behaviour takes cares of deleting every orphan <code>Review</code>. Thus, invoking <code>.clear()</code> suffices to remove the book&#8217;s previous reviews.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Book</span> replaceReviews(<span class="predefined-type">Serializable</span> idParam, <span class="predefined-type">List</span>&lt;Review&gt; newReviews) {
    <span class="predefined-type">Book</span> book = <span class="predefined-type">Book</span>.where { id == idParam }.join(<span class="string"><span class="delimiter">'</span><span class="content">reviews</span><span class="delimiter">'</span></span>).get()
    book.reviews.clear()
    newReviews.each { book.addToReviews(<span class="local-variable">it</span>) }
    book.save()
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="oneToMany">5.1.2. One-to-many</h4>
<div class="paragraph">
<p>A one-to-many relationship is when one class, example <code>Author</code>, has many instances of another class, example <code>Book</code>. With GORM you define such a relationship with the <code>hasMany</code> setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="directive">static</span> hasMany = [<span class="key">books</span>: <span class="predefined-type">Book</span>]

    <span class="predefined-type">String</span> name
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> title
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we have a unidirectional one-to-many. GORM will, by default, map this kind of relationship with a join table.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <a href="#ormdsl">ORM DSL</a> allows mapping unidirectional relationships using a foreign key association instead
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>GORM will automatically inject a property of type <code>java.util.Set</code> into the domain class based on the <code>hasMany</code> setting. This can be used to iterate over the collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> a = Author.get(<span class="integer">1</span>)

<span class="keyword">for</span> (book <span class="keyword">in</span> a.books) {
    println book.title
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The default fetch strategy used by GORM is "lazy", which means that the collection will be lazily initialized on first access. This can lead to the N+1 if you are not careful.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you need "eager" fetching you can use the <a href="#ormdsl">ORM DSL</a> or specify eager fetching as part of a <a href="#querying">query</a></p>
</div>
<div class="paragraph">
<p>The default cascading behaviour is to cascade saves and updates, but not deletes unless a <code>belongsTo</code> is also specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="directive">static</span> hasMany = [<span class="key">books</span>: <span class="predefined-type">Book</span>]

    <span class="predefined-type">String</span> name
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {
    <span class="directive">static</span> belongsTo = [<span class="key">author</span>: Author]
    <span class="predefined-type">String</span> title
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you have two properties of the same type on the many side of a one-to-many you have to use <code>mappedBy</code> to specify which the collection is mapped:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Airport</span> {
    <span class="directive">static</span> hasMany = [<span class="key">flights</span>: Flight]
    <span class="directive">static</span> mappedBy = [<span class="key">flights</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">departureAirport</span><span class="delimiter">&quot;</span></span>]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Flight</span> {
    Airport departureAirport
    Airport destinationAirport
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is also true if you have multiple collections that map to different properties on the many side:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Airport</span> {
    <span class="directive">static</span> hasMany = [<span class="key">outboundFlights</span>: Flight, <span class="key">inboundFlights</span>: Flight]
    <span class="directive">static</span> mappedBy = [<span class="key">outboundFlights</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">departureAirport</span><span class="delimiter">&quot;</span></span>,
                       <span class="key">inboundFlights</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationAirport</span><span class="delimiter">&quot;</span></span>]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Flight</span> {
    Airport departureAirport
    Airport destinationAirport
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="manyToMany">5.1.3. Many-to-many</h4>
<div class="paragraph">
<p>GORM supports many-to-many relationships by defining a <code>hasMany</code> on both sides of the relationship and having a <code>belongsTo</code> on the owned side of the relationship:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {
    <span class="directive">static</span> belongsTo = Author
    <span class="directive">static</span> hasMany = [<span class="key">authors</span>:Author]
    <span class="predefined-type">String</span> title
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="directive">static</span> hasMany = [<span class="key">books</span>:<span class="predefined-type">Book</span>]
    <span class="predefined-type">String</span> name
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>GORM maps a many-to-many using a join table at the database level. The owning side of the relationship, in this case <code>Author</code>, takes responsibility for persisting the relationship and is the only side that can cascade saves across.</p>
</div>
<div class="paragraph">
<p>For example this will work and cascade saves:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> Author(<span class="key">name</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Stephen King</span><span class="delimiter">&quot;</span></span>)
        .addToBooks(<span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>))
        .addToBooks(<span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">The Shining</span><span class="delimiter">&quot;</span></span>))
        .save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>However this will only save the <code>Book</code> and not the authors!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">name</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Groovy in Action</span><span class="delimiter">&quot;</span></span>)
        .addToAuthors(<span class="keyword">new</span> Author(<span class="key">name</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Dierk Koenig</span><span class="delimiter">&quot;</span></span>))
        .addToAuthors(<span class="keyword">new</span> Author(<span class="key">name</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Guillaume Laforge</span><span class="delimiter">&quot;</span></span>))
        .save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the expected behaviour as, just like Hibernate, only one side of a many-to-many can take responsibility for managing the relationship.</p>
</div>
</div>
<div class="sect3">
<h4 id="basicCollectionTypes">5.1.4. Basic Collection Types</h4>
<div class="paragraph">
<p>As well as associations between different domain classes, GORM also supports mapping of basic collection types.
For example, the following class creates a <code>nicknames</code> association that is a <code>Set</code> of <code>String</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    <span class="directive">static</span> hasMany = [nicknames: <span class="predefined-type">String</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>GORM will map an association like the above using a join table. You can alter various aspects of how the join table is mapped using the <code>joinTable</code> argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="directive">static</span> hasMany = [nicknames: <span class="predefined-type">String</span>]

    <span class="directive">static</span> mapping = {
       nicknames joinTable: [name: <span class="string"><span class="delimiter">'</span><span class="content">bunch_o_nicknames</span><span class="delimiter">'</span></span>,
                           key: <span class="string"><span class="delimiter">'</span><span class="content">person_id</span><span class="delimiter">'</span></span>,
                           column: <span class="string"><span class="delimiter">'</span><span class="content">nickname</span><span class="delimiter">'</span></span>,
                           type: <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above will map to a table that looks like the following:</p>
</div>
<div class="paragraph">
<p><strong>bunch_o_nicknames Table</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">---------------------------------------------
| person_id         |     nickname          |
---------------------------------------------
|   <span class="integer">1</span>               |      Fred             |
---------------------------------------------</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="gormComposition">5.2. Composition in GORM</h3>
<div class="paragraph">
<p>As well as <a href="#gormAssociation">associations</a>, GORM supports the notion of composition. In this case instead of mapping classes onto separate tables a class can be "embedded" within the current table. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Person</span> {
    Address homeAddress
    Address workAddress
    <span class="directive">static</span> embedded = [<span class="string"><span class="delimiter">'</span><span class="content">homeAddress</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">workAddress</span><span class="delimiter">'</span></span>]
}

<span class="type">class</span> <span class="class">Address</span> {
    <span class="predefined-type">String</span> number
    <span class="predefined-type">String</span> code
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting mapping would looking like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/5.2.2-composition.jpg" alt="5.2.2 composition">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you define the <code>Address</code> class in a separate Groovy file in the <code>grails-app/domain</code> directory you will also get an <code>address</code> table. If you don&#8217;t want this to happen use Groovy&#8217;s ability to define multiple classes per file and include the <code>Address</code> class below the <code>Person</code> class in the <code>grails-app/domain/Person.groovy</code> file. Another option is to define the <code>Address</code> class in <code>src/main/groovy/Address.groovy</code> and annotate it with <code>grails.gorm.annotation.Entity</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="inheritanceInGORM">5.3. Inheritance in GORM</h3>
<div class="paragraph">
<p>GORM supports inheritance both from abstract base classes and concrete persistent GORM entities. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Content</span> {
     <span class="predefined-type">String</span> author
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">BlogEntry</span> <span class="directive">extends</span> Content {
    <span class="predefined-type">URL</span> url
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> <span class="directive">extends</span> Content {
    <span class="predefined-type">String</span> ISBN
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">PodCast</span> <span class="directive">extends</span> Content {
    <span class="type">byte</span><span class="type">[]</span> audioStream
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example we have a parent <code>Content</code> class and then various child classes with more specific behaviour.</p>
</div>
<div class="sect3">
<h4 id="_considerations">5.3.1. Considerations</h4>
<div class="paragraph">
<p>At the database level GORM by default uses table-per-hierarchy mapping with a discriminator column called <code>class</code> so the parent class (<code>Content</code>) and its subclasses (<code>BlogEntry</code>, <code>Book</code> etc.), share the <strong>same</strong> table.</p>
</div>
<div class="paragraph">
<p>Table-per-hierarchy mapping has a down side in that you <strong>cannot</strong> have non-nullable properties with inheritance mapping. An alternative is to use table-per-subclass which can be enabled with the <a href="#ormdsl">ORM DSL</a></p>
</div>
<div class="paragraph">
<p>However, excessive use of inheritance and table-per-subclass can result in poor query performance due to the use of outer join queries. In general our advice is if you&#8217;re going to use inheritance, don&#8217;t abuse it and don&#8217;t make your inheritance hierarchy too deep.</p>
</div>
</div>
<div class="sect3">
<h4 id="_polymorphic_queries">5.3.2. Polymorphic Queries</h4>
<div class="paragraph">
<p>The upshot of inheritance is that you get the ability to polymorphically query. For example using the <a href="../api/org/grails/datastore/gorm/GormEntity.html#list()">list()</a> method on the <code>Content</code> super class will return all subclasses of <code>Content</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> content = Content.list() <span class="comment">// list all blog entries, books and podcasts</span>
content = Content.findAllByAuthor(<span class="string"><span class="delimiter">'</span><span class="content">Joe Bloggs</span><span class="delimiter">'</span></span>) <span class="comment">// find all by author</span>

<span class="keyword">def</span> podCasts = PodCast.list() <span class="comment">// list only podcasts</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sets">5.4. Sets, Lists and Maps</h3>
<div class="sect3">
<h4 id="_sets_of_objects">5.4.1. Sets of Objects</h4>
<div class="paragraph">
<p>By default when you define a relationship with GORM it is a <code>java.util.Set</code> which is an unordered collection that cannot contain duplicates. In other words when you have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="directive">static</span> hasMany = [<span class="key">books</span>: <span class="predefined-type">Book</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The books property that GORM injects is a <code>java.util.Set</code>. Sets guarantee uniqueness but not order, which may not be what you want. To have custom ordering you configure the Set as a <code>SortedSet</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {

    <span class="predefined-type">SortedSet</span> books

    <span class="directive">static</span> hasMany = [<span class="key">books</span>: <span class="predefined-type">Book</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case a <code>java.util.SortedSet</code> implementation is used which means you must implement <code>java.lang.Comparable</code> in your Book class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> <span class="directive">implements</span> <span class="predefined-type">Comparable</span> {

    <span class="predefined-type">String</span> title
    <span class="predefined-type">Date</span> releaseDate = <span class="keyword">new</span> <span class="predefined-type">Date</span>()

    <span class="type">int</span> compareTo(obj) {
        releaseDate.compareTo(obj.releaseDate)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of the above class is that the Book instances in the books collection of the Author class will be ordered by their release date.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lists_of_objects">5.4.2. Lists of Objects</h4>
<div class="paragraph">
<p>To keep objects in the order which they were added and to be able to reference them by index like an array you can define your collection type as a <code>List</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {

    <span class="predefined-type">List</span> books

    <span class="directive">static</span> hasMany = [<span class="key">books</span>: <span class="predefined-type">Book</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case when you add new elements to the books collection the order is retained in a sequential list indexed from 0 so you can do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">author.books&lt;&lt;<span class="integer">0</span>&gt;&gt; <span class="comment">// get the first book</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The way this works at the database level is Hibernate creates a <code>books_idx</code> column where it saves the index of the elements in the collection to retain this order at the database level.</p>
</div>
<div class="paragraph">
<p>When using a <code>List</code>, elements must be added to the collection before being saved, otherwise Hibernate will throw an exception (<code>org.hibernate.HibernateException</code>: null index column for collection):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// This won't work!</span>
<span class="keyword">def</span> book = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>: <span class="string"><span class="delimiter">'</span><span class="content">The Shining</span><span class="delimiter">'</span></span>)
book.save()
author.addToBooks(book)

<span class="comment">// Do it this way instead.</span>
<span class="keyword">def</span> book = <span class="keyword">new</span> <span class="predefined-type">Book</span>(<span class="key">title</span>: <span class="string"><span class="delimiter">'</span><span class="content">Misery</span><span class="delimiter">'</span></span>)
author.addToBooks(book)
author.save()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bags_of_objects">5.4.3. Bags of Objects</h4>
<div class="paragraph">
<p>If ordering and uniqueness aren&#8217;t a concern (or if you manage these explicitly) then you can use the Hibernate <a href="https://docs.jboss.org/hibernate/core/3.6/reference/en-US/html/collections.html">Bag</a> type to represent mapped collections.</p>
</div>
<div class="paragraph">
<p>The only change required for this is to define the collection type as a <code>Collection</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {

   <span class="predefined-type">Collection</span> books

   <span class="directive">static</span> hasMany = [<span class="key">books</span>: <span class="predefined-type">Book</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since uniqueness and order aren&#8217;t managed by Hibernate, adding to or removing from collections mapped as a Bag don&#8217;t trigger a load of all existing instances from the database, so this approach will perform better and require less memory than using a <code>Set</code> or a <code>List</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_maps_of_objects">5.4.4. Maps of Objects</h4>
<div class="paragraph">
<p>If you want a simple map of string/value pairs GORM can map this with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="predefined-type">Map</span> books <span class="comment">// map of ISBN:book names</span>
}

<span class="keyword">def</span> a = <span class="keyword">new</span> Author()
a.books = [<span class="string"><span class="delimiter">'</span><span class="content">1590597583</span><span class="delimiter">'</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">My Book</span><span class="delimiter">&quot;</span></span>]
a.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the key and value of the map MUST be strings.</p>
</div>
<div class="paragraph">
<p>If you want a Map of objects then you can do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {

    <span class="predefined-type">Map</span> authors

    <span class="directive">static</span> hasMany = [<span class="key">authors</span>: Author]
}

<span class="keyword">def</span> a = <span class="keyword">new</span> Author(<span class="key">name</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Stephen King</span><span class="delimiter">&quot;</span></span>)

<span class="keyword">def</span> book = <span class="keyword">new</span> <span class="predefined-type">Book</span>()
book.authors = [<span class="key">stephen</span>:a]
book.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The static <code>hasMany</code> property defines the type of the elements within the Map. The keys for the map <strong>must</strong> be strings.</p>
</div>
</div>
<div class="sect3">
<h4 id="_a_note_on_collection_types_and_performance">5.4.5. A Note on Collection Types and Performance</h4>
<div class="paragraph">
<p>The Java <code>Set</code> type doesn&#8217;t allow duplicates. To ensure uniqueness when adding an entry to a <code>Set</code> association Hibernate has to load the entire associations from the database. If you have a large numbers of entries in the association this can be costly in terms of performance.</p>
</div>
<div class="paragraph">
<p>The same behavior is required for <code>List</code> types, since Hibernate needs to load the entire association to maintain order. Therefore it is recommended that if you anticipate a large numbers of records in the association that you make the association bidirectional so that the link can be created on the inverse side. For example consider the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def book = <span class="keyword">new</span> <span class="predefined-type">Book</span>(title:<span class="string"><span class="delimiter">&quot;</span><span class="content">New Grails Book</span><span class="delimiter">&quot;</span></span>)
def author = Author.get(<span class="integer">1</span>)
book.author = author
book.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example the association link is being created by the child (Book) and hence it is not necessary to manipulate the collection directly resulting in fewer queries and more efficient code. Given an <code>Author</code> with a large number of associated <code>Book</code> instances if you were to write code like the following you would see an impact on performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def book = <span class="keyword">new</span> <span class="predefined-type">Book</span>(title:<span class="string"><span class="delimiter">&quot;</span><span class="content">New Grails Book</span><span class="delimiter">&quot;</span></span>)
def author = Author.get(<span class="integer">1</span>)
author.addToBooks(book)
author.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also model the collection as a Hibernate Bag as described above.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistenceBasics">6. Persistence Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A key thing to remember about GORM is that under the surface GORM is using <a href="https://www.hibernate.org/">Hibernate</a> for persistence. If you are coming from a background of using <a href="https://api.rubyonrails.org/classes/ActiveRecord/Base.html">ActiveRecord</a> or <a href="https://www.mybatis.org/">iBatis/MyBatis</a>, Hibernate&#8217;s "session" model may feel a little strange.</p>
</div>
<div class="paragraph">
<p>If you are using Grails, then Grails automatically binds a Hibernate session to the currently executing request. This lets you use the <code>save()</code> and <code>delete</code> methods as well as other GORM methods transparently.</p>
</div>
<div class="paragraph">
<p>If you are not using Grails then you have to make sure that a session is bound to the current request. One way to to achieve that is with the <a href="../api/org/grails/datastore/gorm/GormEntity.html#withNewSession(groovy.lang.Closure)">withNewSession(Closure)</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Book</span>.withNewSession {
        <span class="comment">// your logic here</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to bind a transaction using the <a href="../api/org/grails/datastore/gorm/GormEntity.html#withTransaction(groovy.lang.Closure)">withTransaction(Closure)</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Book</span>.withTransaction {
        <span class="comment">// your logic here</span>
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_transactional_write_behind">6.1. Transactional Write-Behind</h4>
<div class="paragraph">
<p>A useful feature of Hibernate over direct JDBC calls and even other frameworks is that when you call <a href="../api/org/grails/datastore/gorm/GormEntity.html#save()">save()</a> or <a href="../api/org/grails/datastore/gorm/GormEntity.html#delete()">delete()</a> it does not necessarily perform any SQL operations <strong>at that point</strong>. Hibernate batches up SQL statements and executes them as late as possible, often at the end of the request when flushing and closing the session.</p>
</div>
<div class="paragraph">
<p>If you are using Grails this typically done for you automatically, which manages your Hibernate session. If you are using GORM outside of Grails then you may need to manually flush the session at the end of your operation.</p>
</div>
<div class="paragraph">
<p>Hibernate caches database updates where possible, only actually pushing the changes when it knows that a flush is required, or when a flush is triggered programmatically. One common case where Hibernate will flush cached updates is when performing queries since the cached information might be included in the query results. But as long as you&#8217;re doing non-conflicting saves, updates, and deletes, they&#8217;ll be batched until the session is flushed. This can be a significant performance boost for applications that do a lot of database writes.</p>
</div>
<div class="paragraph">
<p>Note that flushing is not the same as committing a transaction. If your actions are performed in the context of a transaction, flushing will execute SQL updates but the database will save the changes in its transaction queue and only finalize the updates when the transaction commits.</p>
</div>
</div>
<div class="sect2">
<h3 id="savingAndUpdating">6.2. Saving and Updating</h3>
<div class="paragraph">
<p>An example of using the <a href="../api/org/grails/datastore/gorm/GormEntity.html#save()">save()</a> method can be seen below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
p.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This save will be not be pushed to the database immediately - it will be pushed when the next flush occurs. But there are occasions when you want to control when those statements are executed or, in Hibernate terminology, when the session is "flushed". To do so you can use the flush argument to the save method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
p.save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in this case <em>all</em> pending SQL statements including previous saves, deletes, etc. will be synchronized with the database. This also lets you catch any exceptions, which is typically useful in highly concurrent scenarios involving <a href="#locking">optimistic locking</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
<span class="keyword">try</span> {
    p.save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
}
<span class="keyword">catch</span> (org.springframework.dao.DataIntegrityViolationException e) {
    <span class="comment">// deal with exception</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another thing to bear in mind is that GORM validates a domain instance every time you save it. If that validation fails the domain instance will <em>not</em> be persisted to the database. By default, <code>save()</code> will simply return <code>null</code> in this case, but if you would prefer it to throw an exception you can use the <code>failOnError</code> argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
<span class="keyword">try</span> {
    p.save(<span class="key">failOnError</span>: <span class="predefined-constant">true</span>)
}
<span class="keyword">catch</span> (ValidationException e) {
    <span class="comment">// deal with exception</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can even change the default behaviour with a setting in <code>application.groovy</code>, as described in the <a href="#configuration">section on configuration</a>. Just remember that when you are saving domain instances that have been bound with data provided by the user, the likelihood of validation exceptions is quite high and you won&#8217;t want those exceptions propagating to the end user.</p>
</div>
</div>
<div class="sect2">
<h3 id="deletingObjects">6.3. Deleting Objects</h3>
<div class="paragraph">
<p>An example of the <a href="../api/org/grails/datastore/gorm/GormEntity.html#delete()">delete()</a> method can be seen below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
p.delete()</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with saves, Hibernate will use transactional write-behind to perform the delete; to perform the delete in-place you can use the <code>flush</code> argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> p = Person.get(<span class="integer">1</span>)
p.delete(<span class="key">flush</span>: <span class="predefined-constant">true</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>flush</code> argument lets you catch any errors that occur during a delete. A common error that may occur is if you violate a database constraint, although this is normally down to a programming or schema error. The following example shows how to catch a <code>DataIntegrityViolationException</code> that is thrown when you violate the database constraints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.springframework.dao</span>.*

<span class="include">def</span> <span class="include">p</span> = <span class="include">Person.get</span>(<span class="integer">1</span>)

<span class="include">try</span> {
    <span class="include">p.delete</span>(<span class="include">flush</span>: <span class="include">true</span>)
}
<span class="include">catch</span> (<span class="include">DataIntegrityViolationException</span> <span class="include">e</span>) {
    <span class="comment">// handle the error</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to perform a batch delete there are a couple of ways to achieve that. One way is to use a <a href="#whereQueries">Where Query</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Person.where {
        name == <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>
}.deleteAll()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another alternative is to use an HQL statement within the <a href="../api/org/grails/datastore/gorm/GormEntity.html#executeUpdate(java.lang.String)">executeUpdate(&#8230;&#8203;)</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Customer.executeUpdate(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete Customer c where c.name = :oldName</span><span class="delimiter">&quot;</span></span>,
                       [<span class="key">oldName</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cascades">6.4. Understanding Cascading Updates and Deletes</h3>
<div class="paragraph">
<p>It is critical that you understand how cascading updates and deletes work when using GORM. The key part to remember is the <code>belongsTo</code> setting which controls which class "owns" a relationship.</p>
</div>
<div class="paragraph">
<p>Whether it is a one-to-one, one-to-many or many-to-many, defining <code>belongsTo</code> will result in updates cascading from the owning class to its dependant (the other side of the relationship), and for many-/one-to-one and one-to-many relationships deletes will also cascade.</p>
</div>
<div class="paragraph">
<p>If you <em>do not</em> define <code>belongsTo</code> then no cascades will happen and you will have to manually save each object (except in the case of the one-to-many, in which case saves will cascade automatically if a new instance is in a <code>hasMany</code> collection).</p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Airport</span> {
    <span class="predefined-type">String</span> name
    <span class="directive">static</span> hasMany = [<span class="key">flights</span>: Flight]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Flight</span> {
    <span class="predefined-type">String</span> number
    <span class="directive">static</span> belongsTo = [<span class="key">airport</span>: Airport]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If I now create an <code>Airport</code> and add some ``Flight``s to it I can save the <code>Airport</code> and have the updates cascaded down to each flight, hence saving the whole object graph:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">new</span> Airport(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Gatwick</span><span class="delimiter">&quot;</span></span>)
        .addToFlights(<span class="keyword">new</span> Flight(<span class="key">number</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">BA3430</span><span class="delimiter">&quot;</span></span>))
        .addToFlights(<span class="keyword">new</span> Flight(<span class="key">number</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">EZ0938</span><span class="delimiter">&quot;</span></span>))
        .save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Conversely if I later delete the <code>Airport</code> all <code>Flight</code> instances associated with it will also be deleted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.findByName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Gatwick</span><span class="delimiter">&quot;</span></span>)
airport.delete()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above examples are called transitive persistence and are controlled via the <code>belongsTo</code> and the cascade policy. If I were to remove <code>belongsTo</code> then the above cascading deletion code <strong>would not work</strong>.</p>
</div>
<div class="sect4">
<h5 id="_unidirectional_many_to_one_without_belongsto">Unidirectional Many-To-One without belongsTo</h5>
<div class="paragraph">
<p>For example, consider the following domain model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Location</span> {
    <span class="predefined-type">String</span> city
}

<span class="type">class</span> <span class="class">Author</span> {
    <span class="predefined-type">String</span> name
    Location location
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks simple, right? And it is. Just set the location property to a Location instance and you have linked an author to a location. But see what happens when we run the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> a = <span class="keyword">new</span> Author(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Niall Ferguson</span><span class="delimiter">&quot;</span></span>, <span class="key">location</span>: <span class="keyword">new</span> Location(<span class="key">city</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston</span><span class="delimiter">&quot;</span></span>))
a.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>An exception is thrown. If you look at the ultimate “caused by” exception, you’ll see the message <code>“not-null property references a null or transient value: Author.location”</code>. What’s going on?</p>
</div>
<div class="paragraph">
<p>A transient instance is one that isn’t attached to a Hibernate session. As you can see from the code, we are setting the Author.location property to a new Location instance, not one retrieved from the database. Hence the instance is transient. The obvious fix is to make the Location instance persistent by saving it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> l = <span class="keyword">new</span> Location(<span class="key">city</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Boston</span><span class="delimiter">&quot;</span></span>)
l.save()

<span class="keyword">def</span> a = <span class="keyword">new</span> Author(<span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Niall Ferguson</span><span class="delimiter">&quot;</span></span>, <span class="key">location</span>: l)
a.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another option is to alter the cascade policy for the association. There are two ways to do that. One way is to define <code>belongsTo</code> on the <code>Location</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Location</span> {
    <span class="predefined-type">String</span> city

    <span class="directive">static</span> belongsTo = Author
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this above syntax does not make the association bidirectional since no property is defined. A bidirectional example would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Location</span> {
    <span class="predefined-type">String</span> city

    <span class="directive">static</span> belongsTo = [<span class="key">author</span>:Author]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively if you prefer that the <code>Location</code> class has nothing to do with the <code>Author</code> class you can define the cascade policy in <code>Author</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="predefined-type">String</span> name
    Location location

    <span class="directive">static</span> mapping = {
        location <span class="key">cascade</span>:<span class="string"><span class="delimiter">'</span><span class="content">save-update</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will configure the cascade policy to cascade saves and updates, but not deletes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_bidirectional_one_to_many_with_belongsto">Bidirectional one-to-many with belongsTo</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">A</span> { <span class="directive">static</span> hasMany = [<span class="key">bees</span>: B] }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">B</span> { <span class="directive">static</span> belongsTo = [<span class="key">a</span>: A] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of a bidirectional one-to-many where the many side defines a <code>belongsTo</code> then the cascade strategy is set to "ALL" for the one side and "NONE" for the many side.</p>
</div>
<div class="paragraph">
<p>What this means is that whenever an instance of <code>A</code> is saved or updated. So will any instances of <code>B</code>. And, critically, whenever any instance of <code>A</code> is <strong>deleted</strong> so will all the associated instances of <code>B</code>!</p>
</div>
</div>
<div class="sect4">
<h5 id="_unidirectional_one_to_many">Unidirectional One-to-Many</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">A</span> { <span class="directive">static</span> hasMany = [<span class="key">bees</span>: B] }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">B</span> {  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of a unidirectional one-to-many where the many side defines no belongsTo then the cascade strategy is set to "SAVE-UPDATE".</p>
</div>
<div class="paragraph">
<p>Since the <code>belongsTo</code> is not defined, this means that saves and updates will be cascaded from <code>A</code> to <code>B</code>, however deletes <strong>will not</strong> cascade!</p>
</div>
<div class="paragraph">
<p>Only when you define <code>belongsTo</code> in <code>B</code> or alter the cascading strategy of <code>A</code> will deletes be cascaded.</p>
</div>
</div>
<div class="sect4">
<h5 id="_bidirectional_one_to_many_no_belongsto">Bidirectional One-to-Many, no belongsTo</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">A</span> { <span class="directive">static</span> hasMany = [<span class="key">bees</span>: B] }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">B</span> { A a }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of a bidirectional one-to-many where the many side does not define a <code>belongsTo</code> then the cascade strategy is set to "SAVE-UPDATE" for the one side and "NONE" for the many side.</p>
</div>
<div class="paragraph">
<p>So exactly like the previous case of a undirectional One-to-Many, without <code>belongsTo</code> definition no delete operations will be cascaded, but crucially saves and updates will by default. If you do not want saves and updates to cacade then <strong>you must</strong> alter the cascade policy of <code>A</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">A</span> {
    <span class="directive">static</span> hasMany = [<span class="key">bees</span>: B]
    <span class="directive">static</span> mapping = {
        bees <span class="key">cascade</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_unidirectional_many_to_one_with_belongsto">Unidirectional Many-to-One with belongsTo</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">A</span> {  }</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">B</span> { <span class="directive">static</span> belongsTo = [<span class="key">a</span>: A] }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the case of a unidirectional many-to-one association that defines a <code>belongsTo</code> then the cascade strategy is set to "ALL" for the owning side of the relationship (A&#8594;B) and "NONE" from the side that defines the <code>belongsTo</code> (B&#8594;A)</p>
</div>
<div class="paragraph">
<p>You may be wondering why this association is a many-to-one and not a one-to-one. The reason is because it is possible to have multiple instances of <code>B</code> associated to the same instance of <code>A</code>. If you wish to define this association as a true one-to-one association a <code>unique</code> constraint is required:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">B</span> {
    <span class="directive">static</span> belongsTo = [<span class="key">a</span>: A]
    <span class="directive">static</span> constraints = {
        a <span class="key">unique</span>:<span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if you need further control over cascading behaviour, you can use the <a href="#ormdsl">ORM DSL</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fetching">6.5. Eager and Lazy Fetching</h3>
<div class="paragraph">
<p>Associations in GORM are by default lazy. This is best explained by example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Airport</span> {
    <span class="predefined-type">String</span> name
    <span class="directive">static</span> hasMany = [<span class="key">flights</span>: Flight]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Flight</span> {
    <span class="predefined-type">String</span> number
    Location destination
    <span class="directive">static</span> belongsTo = [<span class="key">airport</span>: Airport]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Location</span> {
    <span class="predefined-type">String</span> city
    <span class="predefined-type">String</span> country
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the above domain classes and the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.findByName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Gatwick</span><span class="delimiter">&quot;</span></span>)
<span class="keyword">for</span> (flight <span class="keyword">in</span> airport.flights) {
    println flight.destination.city
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>GORM will execute a single SQL query to fetch the <code>Airport</code> instance, another to get its flights, and then 1 extra query for <em>each iteration</em> over the <code>flights</code> association to get the current flight&#8217;s destination. In other words you get N+1 queries (if you exclude the original one to get the airport).</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_eager_fetching">6.6. Configuring Eager Fetching</h3>
<div class="paragraph">
<p>An alternative approach that avoids the N+1 queries is to use eager fetching, which can be specified as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Airport</span> {
    <span class="predefined-type">String</span> name
    <span class="directive">static</span> hasMany = [<span class="key">flights</span>: Flight]
    <span class="directive">static</span> mapping = {
        flights <span class="key">lazy</span>: <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the <code>flights</code> association will be loaded at the same time as its <code>Airport</code> instance, although a second query will be executed to fetch the collection. You can also use <code>fetch: 'join'</code> instead of <code>lazy: false</code> , in which case GORM will only execute a single query to get the airports and their flights. This works well for single-ended associations, but you need to be careful with one-to-manys. Queries will work as you&#8217;d expect right up to the moment you add a limit to the number of results you want. At that point, you will likely end up with fewer results than you were expecting. The reason for this is quite technical but ultimately the problem arises from GORM using a left outer join.</p>
</div>
<div class="paragraph">
<p>So, the recommendation is currently to use <code>fetch: 'join'</code> for single-ended associations and <code>lazy: false</code> for one-to-manys.</p>
</div>
<div class="paragraph">
<p>Be careful how and where you use eager loading because you could load your entire database into memory with too many eager associations. You can find more information on the mapping options in the <a href="#fetchingDSL">section on the ORM DSL</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_altering_fetch_strategy_for_a_query">6.7. Altering Fetch Strategy for a Query</h3>
<div class="paragraph">
<p>Rather than configuring join fetching as the default for an association, it may be better to alter the join strategy only for the queries that require it. This can be done using the <code>fetch</code> argument to most GORM methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// Using the list method</span>
Author.list(<span class="key">fetch</span>: [<span class="key">location</span>: <span class="string"><span class="delimiter">'</span><span class="content">join</span><span class="delimiter">'</span></span>]).each { a -&gt;
    println a.location.city
}
<span class="comment">// Using a dynamic finder</span>
Author.findAllByNameLike(<span class="string"><span class="delimiter">&quot;</span><span class="content">John%</span><span class="delimiter">&quot;</span></span>, [ <span class="key">sort</span>: <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="key">order</span>: <span class="string"><span class="delimiter">'</span><span class="content">asc</span><span class="delimiter">'</span></span>, <span class="key">fetch</span>: [<span class="key">location</span>: <span class="string"><span class="delimiter">'</span><span class="content">join</span><span class="delimiter">'</span></span>] ]).each { a-&gt;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or using the <code>join</code> method when using <a href="#whereQueries">Where Queries</a> or criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Author.where {
    name == <span class="string"><span class="delimiter">&quot;</span><span class="content">Stephen King</span><span class="delimiter">&quot;</span></span>
}.join(<span class="string"><span class="delimiter">'</span><span class="content">location</span><span class="delimiter">'</span></span>)
 .list()</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_batch_fetching">6.8. Using Batch Fetching</h3>
<div class="paragraph">
<p>Although eager fetching is appropriate for some cases, it is not always desirable. If you made everything eager you could quite possibly load your entire database into memory resulting in performance and memory problems. An alternative to eager fetching is to use batch fetching. You can configure Hibernate to lazily fetch results in "batches". For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Airport</span> {
    <span class="predefined-type">String</span> name
    <span class="directive">static</span> hasMany = [flights: Flight]
    <span class="directive">static</span> mapping = {
        flights batchSize: <span class="integer">10</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, due to the <code>batchSize</code> argument, when you iterate over the <code>flights</code> association, Hibernate will fetch results in batches of 10. For example if you had an <code>Airport</code> that had 30 flights, if you didn&#8217;t configure batch fetching you would get 1 query to fetch the <code>Airport</code> and then <code>30</code> queries to fetch each flight. With batch fetching you get 1 query to fetch the <code>Airport</code> and 3 queries to fetch each <code>Flight</code> in batches of 10. In other words, batch fetching is an optimization of the lazy fetching strategy. Batch fetching can also be configured at the class level as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Flight</span> {
    ...
    static mapping = {
        batchSize <span class="integer">10</span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="locking">6.9. Pessimistic and Optimistic Locking</h3>
<div class="sect3">
<h4 id="_optimistic_locking">6.9.1. Optimistic Locking</h4>
<div class="paragraph">
<p>By default GORM classes are configured for optimistic locking. Optimistic locking is a feature of Hibernate which involves storing a version value in a special <code>version</code> column in the database that is incremented after each update.</p>
</div>
<div class="paragraph">
<p>The <code>version</code> column gets read into a <code>version</code> property that contains the current versioned state of persistent instance which you can access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)

println airport.version</code></pre>
</div>
</div>
<div class="paragraph">
<p>When you perform updates Hibernate will automatically check the version property against the  version column in the database and if they differ will throw a <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/StaleObjectStateException.html">StaleObjectException</a>. This will roll back the transaction if one is active.</p>
</div>
<div class="paragraph">
<p>This is useful as it allows a certain level of atomicity without resorting to pessimistic locking that has an inherit performance penalty. The downside is that you have to deal with this exception if you have highly concurrent writes. This requires flushing the session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)

<span class="keyword">try</span> {
    airport.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Heathrow</span><span class="delimiter">&quot;</span></span>
    airport.save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
}
<span class="keyword">catch</span> (org.springframework.dao.OptimisticLockingFailureException e) {
    <span class="comment">// deal with exception</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The way you deal with the exception depends on the application. You could attempt a programmatic merge of the data or go back to the user and ask them to resolve the conflict.</p>
</div>
<div class="paragraph">
<p>Alternatively, if it becomes a problem you can resort to pessimistic locking.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>version</code> will only be updated after flushing the session.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_pessimistic_locking">6.9.2. Pessimistic Locking</h4>
<div class="paragraph">
<p>Pessimistic locking is equivalent to doing a SQL "SELECT * FOR UPDATE" statement and locking a row in the database. This has the implication that other read operations will be blocking until the lock is released.</p>
</div>
<div class="paragraph">
<p>In GORM pessimistic locking is performed on an existing instance with the <a href="../api/org/grails/datastore/gorm/GormEntity.html#lock()">lock()</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)
airport.lock() <span class="comment">// lock for update</span>
airport.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Heathrow</span><span class="delimiter">&quot;</span></span>
airport.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>GORM will automatically deal with releasing the lock for you once the transaction has been committed.</p>
</div>
<div class="paragraph">
<p>However, in the above case what we are doing is "upgrading" from a regular SELECT to a SELECT..FOR UPDATE and another thread could still have updated the record in between the call to <code>get()</code> and the call to <code>lock()</code>.</p>
</div>
<div class="paragraph">
<p>To get around this problem you can use the static <a href="../api/org/grails/datastore/gorm/GormEntity.html#lock(java.io.Serializable)">lock(id)</a> method that takes an id just like <a href="../api/org/grails/datastore/gorm/GormEntity.html#get(java.io.Serializable)">get(id)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.lock(<span class="integer">10</span>) <span class="comment">// lock for update</span>
airport.name = <span class="string"><span class="delimiter">&quot;</span><span class="content">Heathrow</span><span class="delimiter">&quot;</span></span>
airport.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case only SELECT..FOR UPDATE is issued.</p>
</div>
<div class="paragraph">
<p>As well as the <a href="../api/org/grails/datastore/gorm/GormEntity.html#lock(java.io.Serializable)">lock(id)</a> method you can also obtain a pessimistic locking using queries. For example using a dynamic finder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def airport = Airport.findByName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Heathrow</span><span class="delimiter">&quot;</span></span>, [lock: <span class="predefined-constant">true</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or using criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def airport = Airport.createCriteria().get {
    eq(<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Heathrow</span><span class="delimiter">'</span></span>)
    lock <span class="predefined-constant">true</span>
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modificationChecking">6.10. Modification Checking</h3>
<div class="paragraph">
<p>Once you have loaded and possibly modified a persistent domain class instance, it isn&#8217;t straightforward to retrieve the original values. If you try to reload the instance using <a href="../api/org/grails/datastore/gorm/GormEntity.html#get(java.io.Serializable)">get(id)</a> Hibernate will return the current modified instance from its Session cache.</p>
</div>
<div class="paragraph">
<p>Reloading using another query would trigger a flush which could cause problems if your data isn&#8217;t ready to be flushed yet. So GORM provides some methods to retrieve the original values that Hibernate caches when it loads the instance (which it uses for dirty checking).</p>
</div>
<div class="sect3">
<h4 id="_isdirty">6.10.1. isDirty</h4>
<div class="paragraph">
<p>You can use the <a href="../api/org/grails/datastore/gorm/GormEntity.html#isDirty(java.lang.String)">isDirty()</a> method to check if any field has been modified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)
<span class="keyword">assert</span> !airport.isDirty()

airport.properties = params
<span class="keyword">if</span> (airport.isDirty()) {
   <span class="comment">// do something based on changed state</span>
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>isDirty()</code> does not currently check collection associations, but it does check all other persistent properties and associations.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also check if individual fields have been modified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)
<span class="keyword">assert</span> !airport.isDirty()

airport.properties = params
<span class="keyword">if</span> (airport.isDirty(<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>)) {
   <span class="comment">// do something based on changed name</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_isdirty_and_proxies">6.10.2. isDirty and Proxies</h4>
<div class="paragraph">
<p>Dirty checking uses the <code>equals()</code> method to determine if a property has changed. In the case of associations, it is important to recognize that if the association is a proxy, comparing properties on the domain that are not related to the identifier will initialize the proxy, causing another database query.</p>
</div>
<div class="paragraph">
<p>If the association does not define <code>equals()</code> method, then the default Groovy behavior of verifying the instances are the same will be used. Because proxies are not the same instance as an instance loaded from the database, which can cause confusing behavior. It is recommended to implement the <code>equals()</code> method if you need to check the dirtiness of an association. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="predefined-type">Long</span> id
    <span class="predefined-type">String</span> name

     <span class="comment">/**
     * This ensures that if either or both of the instances
     * have a null id (new instances), they are not equal.
     */</span>
    <span class="annotation">@Override</span>
    <span class="type">boolean</span> equals(o) {
        <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> Author)) <span class="keyword">return</span> <span class="predefined-constant">false</span>
        <span class="keyword">if</span> (<span class="local-variable">this</span>.is(o)) <span class="keyword">return</span> <span class="predefined-constant">true</span>
        Author that = (Author) o
        <span class="keyword">if</span> (id !=<span class="predefined-constant">null</span> &amp;&amp; that.id !=<span class="predefined-constant">null</span>) <span class="keyword">return</span> id == that.id
        <span class="keyword">return</span> <span class="predefined-constant">false</span>
    }
}

<span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">Long</span> id
    <span class="predefined-type">String</span> title
    Author author
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getdirtypropertynames">6.10.3. getDirtyPropertyNames</h4>
<div class="paragraph">
<p>You can use the <a href="../api/org/grails/datastore/gorm/GormEntity.html#getDirtyPropertyNames()">getDirtyPropertyNames()</a> method to retrieve the names of modified fields; this may be empty but will not be null:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)
<span class="keyword">assert</span> !airport.isDirty()

airport.properties = params
<span class="keyword">def</span> modifiedFieldNames = airport.getDirtyPropertyNames()
<span class="keyword">for</span> (fieldName <span class="keyword">in</span> modifiedFieldNames) {
   <span class="comment">// do something based on changed value</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getpersistentvalue">6.10.4. getPersistentValue</h4>
<div class="paragraph">
<p>You can use the <a href="../api/org/grails/datastore/gorm/GormEntity.html#getPersistentValue(java.lang.String)">getPersistentValue(fieldName)</a> method to retrieve the value of a modified field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> airport = Airport.get(<span class="integer">10</span>)
<span class="keyword">assert</span> !airport.isDirty()

airport.properties = params
<span class="keyword">def</span> modifiedFieldNames = airport.getDirtyPropertyNames()
<span class="keyword">for</span> (fieldName <span class="keyword">in</span> modifiedFieldNames) {
    <span class="keyword">def</span> currentValue = airport.<span class="string"><span class="delimiter">&quot;</span><span class="inline"><span class="inline-delimiter">$</span>fieldName</span><span class="delimiter">&quot;</span></span>
    <span class="keyword">def</span> originalValue = airport.getPersistentValue(fieldName)
    <span class="keyword">if</span> (currentValue != originalValue) {
        <span class="comment">// do something based on changed value</span>
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="querying">7. Querying with GORM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GORM supports a number of powerful ways to query from dynamic finders, to criteria to Hibernate&#8217;s object oriented query language HQL. Depending on the complexity of the query you have the following options in order of flexibility and power:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dynamic Finders</p>
</li>
<li>
<p>Where Queries</p>
</li>
<li>
<p>Criteria Queries</p>
</li>
<li>
<p>Hibernate Query Language (HQL)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In addition, Groovy&#8217;s ability to manipulate collections with <a href="https://groovy.codehaus.org/GPath">GPath</a> and methods like sort, findAll and so on combined with GORM results in a powerful combination.</p>
</div>
<div class="paragraph">
<p>However, let&#8217;s start with the basics.</p>
</div>
<div class="sect3">
<h4 id="_listing_instances">7.1. Listing instances</h4>
<div class="paragraph">
<p>Use the <a href="../api/org/grails/datastore/gorm/GormEntity.html#list()">list()</a> method to obtain all instances of a given class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="../api/org/grails/datastore/gorm/GormEntity.html#list(java.util.Map)">list()</a> method supports arguments to perform pagination:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.list(<span class="key">offset</span>:<span class="integer">10</span>, <span class="key">max</span>:<span class="integer">20</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>as well as sorting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.list(<span class="key">sort</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="key">order</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">asc</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>sort</code> argument is the name of the domain class property that you wish to sort on, and the <code>order</code> argument is either <code>asc</code> for *asc*ending or <code>desc</code> for *desc*ending.</p>
</div>
</div>
<div class="sect3">
<h4 id="_retrieval_by_database_identifier">7.2. Retrieval by Database  Identifier</h4>
<div class="paragraph">
<p>The second basic form of retrieval is by database identifier using the <a href="../api/org/grails/datastore/gorm/GormEntity.html#get(java.io.Serializable)">get(id)</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> book = <span class="predefined-type">Book</span>.get(<span class="integer">23</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also obtain a list of instances for a set of identifiers using <a href="../api/org/grails/datastore/gorm/GormEntity.html#getAll(java.io.Serializable)">getAll()</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.getAll(<span class="integer">23</span>, <span class="integer">93</span>, <span class="integer">81</span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="finders">7.3. Dynamic Finders</h3>
<div class="paragraph">
<p>GORM supports the concept of <strong>dynamic finders</strong>. A dynamic finder looks like a static method invocation, but the methods themselves don&#8217;t actually exist in any form at the code level.</p>
</div>
<div class="paragraph">
<p>Instead, a method is auto-magically generated using code synthesis at runtime, based on the properties of a given class. Take for example the <code>Book</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {
    <span class="predefined-type">String</span> title
    <span class="predefined-type">Date</span> releaseDate
    Author author
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="predefined-type">String</span> name
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Book</code> class has properties such as <code>title</code>, <code>releaseDate</code> and <code>author</code>. These can be used by the <code>findBy*</code> and <code>findAllBy*</code> methods in the form of "method expressions":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> book = <span class="predefined-type">Book</span>.findByTitle(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>)

book = <span class="predefined-type">Book</span>.findByTitleLike(<span class="string"><span class="delimiter">&quot;</span><span class="content">Harry Pot%</span><span class="delimiter">&quot;</span></span>)

book = <span class="predefined-type">Book</span>.findByReleaseDateBetween(firstDate, secondDate)

book = <span class="predefined-type">Book</span>.findByReleaseDateGreaterThan(someDate)

book = <span class="predefined-type">Book</span>.findByTitleLikeOrReleaseDateLessThan(<span class="string"><span class="delimiter">&quot;</span><span class="content">%Something%</span><span class="delimiter">&quot;</span></span>, someDate)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_method_expressions">7.3.1. Method Expressions</h4>
<div class="paragraph">
<p>A method expression in GORM is made up of the prefix such as <code>findBy*</code> followed by an expression that combines one or more properties. The basic form is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Book</span>.findBy(&lt;&lt;Property&gt;&gt;&lt;&lt;<span class="predefined-type">Comparator</span>&gt;&gt;&lt;&lt;<span class="predefined-type">Boolean</span> Operator&gt;&gt;)?&lt;&lt;Property&gt;&gt;&lt;&lt;<span class="predefined-type">Comparator</span>&gt;&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The tokens marked with a <em>?</em> are optional. Each comparator changes the nature of the query. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> book = <span class="predefined-type">Book</span>.findByTitle(<span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>)

book =  <span class="predefined-type">Book</span>.findByTitleLike(<span class="string"><span class="delimiter">&quot;</span><span class="content">Harry Pot%</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the first query is equivalent to equality whilst the latter, due to the <code>Like</code> comparator, is equivalent to a SQL <code>like</code> expression.</p>
</div>
<div class="paragraph">
<p>The possible comparators include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>InList</code> - In the list of given values</p>
</li>
<li>
<p><code>LessThan</code> - less than a given value</p>
</li>
<li>
<p><code>LessThanEquals</code> - less than or equal a give value</p>
</li>
<li>
<p><code>GreaterThan</code> - greater than a given value</p>
</li>
<li>
<p><code>GreaterThanEquals</code> - greater than or equal a given value</p>
</li>
<li>
<p><code>Like</code> - Equivalent to a SQL like expression</p>
</li>
<li>
<p><code>Ilike</code> - Similar to a <code>Like</code>, except case insensitive</p>
</li>
<li>
<p><code>NotEqual</code> - Negates equality</p>
</li>
<li>
<p><code>InRange</code> - Between the <code>from</code> and <code>to</code> values of a Groovy Range</p>
</li>
<li>
<p><code>Rlike</code> - Performs a Regexp LIKE in MySQL or Oracle otherwise falls back to <code>Like</code></p>
</li>
<li>
<p><code>Between</code> - Between two values (requires two arguments)</p>
</li>
<li>
<p><code>IsNotNull</code> - Not a null value (doesn&#8217;t take an argument)</p>
</li>
<li>
<p><code>IsNull</code> - Is a null value (doesn&#8217;t take an argument)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Notice that the last three require different numbers of method arguments compared to the rest, as demonstrated in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> now = <span class="keyword">new</span> <span class="predefined-type">Date</span>()
<span class="keyword">def</span> lastWeek = now - <span class="integer">7</span>
<span class="keyword">def</span> book = <span class="predefined-type">Book</span>.findByReleaseDateBetween(lastWeek, now)

books = <span class="predefined-type">Book</span>.findAllByReleaseDateIsNull()
books = <span class="predefined-type">Book</span>.findAllByReleaseDateIsNotNull()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_boolean_logic_andor">7.3.2. Boolean logic (AND/OR)</h4>
<div class="paragraph">
<p>Method expressions can also use a boolean operator to combine two or more criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.findAllByTitleLikeAndReleaseDateGreaterThan(
                      <span class="string"><span class="delimiter">&quot;</span><span class="content">%Java%</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">30</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we&#8217;re using <code>And</code> in the middle of the query to make sure both conditions are satisfied, but you could equally use <code>Or</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.findAllByTitleLikeOrReleaseDateGreaterThan(
                      <span class="string"><span class="delimiter">&quot;</span><span class="content">%Java%</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">30</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can combine as many criteria as you like, but they must all be combined with <code>And</code> or all <code>Or</code>. If you need to combine <code>And</code> and <code>Or</code> or if the number of criteria creates a very long method name, just convert the query to a <a href="#criteria">Criteria</a> or <a href="#hql">HQL</a> query.</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_associations">7.3.3. Querying Associations</h4>
<div class="paragraph">
<p>Associations can also be used within queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> author = Author.findByName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Stephen King</span><span class="delimiter">&quot;</span></span>)

<span class="keyword">def</span> books = author ? <span class="predefined-type">Book</span>.findAllByAuthor(author) : <span class="type">[]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case if the <code>Author</code> instance is not null we use it in a query to obtain all the <code>Book</code> instances for the given <code>Author</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_pagination_and_sorting">7.3.4. Pagination and Sorting</h4>
<div class="paragraph">
<p>The same pagination and sorting parameters available on the <a href="../api/org/grails/datastore/gorm/GormEntity.html#list()">list()</a> method can also be used with dynamic finders by supplying a map as the final parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> books = <span class="predefined-type">Book</span>.findAllByTitleLike(<span class="string"><span class="delimiter">&quot;</span><span class="content">Harry Pot%</span><span class="delimiter">&quot;</span></span>,
               [<span class="key">max</span>: <span class="integer">3</span>, <span class="key">offset</span>: <span class="integer">2</span>, <span class="key">sort</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">title</span><span class="delimiter">&quot;</span></span>, <span class="key">order</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="whereQueries">7.4. Where Queries</h3>
<div class="paragraph">
<p>The <a href="../api/org/grails/datastore/gorm/GormEntity.html#where(groovy.lang.Closure)">where()</a> method builds on the support for <a href="#detachedCriteria">Detached Criteria</a> by providing an enhanced, compile-time checked query DSL for common queries. The <code>where</code> method is more flexible than dynamic finders, less verbose than criteria and provides a powerful mechanism to compose queries.</p>
</div>
<div class="sect3">
<h4 id="_basic_querying">7.4.1. Basic Querying</h4>
<div class="paragraph">
<p>The <a href="../api/org/grails/datastore/gorm/GormEntity.html#where(groovy.lang.Closure)">where()</a> method accepts a closure that looks very similar to Groovy&#8217;s regular collection methods. The closure should define the logical criteria in regular Groovy syntax, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
   firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Bart</span><span class="delimiter">&quot;</span></span>
}
Person bart = query.find()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The returned object is a <a href="../api/grails/gorm/DetachedCriteria.html">DetachedCriteria</a> instance, which means it is not associated with any particular database connection or session. This means you can use the <code>where</code> method to define common queries at the class level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.*</span>

<span class="type">class</span> <span class="class">Person</span> {
    <span class="directive">static</span> DetachedCriteria&lt;Person&gt; simpsons = where {
         lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span>
    }
    ...
}
...
Person.simpsons.each { Person p -&gt;
    println p.firstname
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Query execution is lazy and only happens upon usage of the <a href="#detachedCriteria">DetachedCriteria</a> instance. If you want to execute a where-style query immediately there are variations of the <code>findAll</code> and <code>find</code> methods to accomplish this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.findAll {
     lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span>
}
<span class="keyword">def</span> results = Person.findAll(<span class="key">sort</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>) {
     lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span>
}
Person p = Person.find { firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Bart</span><span class="delimiter">&quot;</span></span> }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each Groovy operator maps onto a regular criteria method. The following table provides a map of Groovy operators to methods:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Criteria Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>==</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>!=</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ne</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>&gt;</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>&lt;</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>&gt;=</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than or equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>&lt;=</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">le</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than or equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>in</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">inList</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Contained within the given list</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>==~</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">like</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Like a given string</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><code>=~</code></strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ilike</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Case insensitive like</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It is possible use regular Groovy comparison operators and logic to formulate complex queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
    (lastName != <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span> &amp;&amp; firstName != <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>) || (firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Bart</span><span class="delimiter">&quot;</span></span> &amp;&amp; age &gt; <span class="integer">9</span>)
}
<span class="keyword">def</span> results = query.list(<span class="key">sort</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Groovy regex matching operators map onto like and ilike queries unless the expression on the right hand side is a <code>Pattern</code> object, in which case they map onto an <code>rlike</code> query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
     firstName ==~ ~<span class="regexp"><span class="delimiter">/</span><span class="content">B.+</span><span class="delimiter">/</span></span>
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that <code>rlike</code> queries are only supported if the underlying database supports regular expressions
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A <code>between</code> criteria query can be done by combining the <code>in</code> keyword with a range:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
     age <span class="keyword">in</span> <span class="integer">18</span>..<span class="integer">65</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you can do <code>isNull</code> and <code>isNotNull</code> style queries by using <code>null</code> with regular comparison operators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
     middleName == <span class="predefined-constant">null</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_query_composition">7.4.2. Query Composition</h4>
<div class="paragraph">
<p>Since the return value of the <code>where</code> method is a <a href="#detachedCriteria">DetachedCriteria</a> instance you can compose new queries from the original query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">DetachedCriteria&lt;Person&gt; query = Person.where {
     lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span>
}
DetachedCriteria&lt;Person&gt; bartQuery = query.where {
     firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Bart</span><span class="delimiter">&quot;</span></span>
}
Person p = bartQuery.find()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you cannot pass a closure defined as a variable into the <code>where</code> method unless it has been explicitly cast to a <code>DetachedCriteria</code> instance. In other words the following will produce an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> callable = {
    lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span>
}
<span class="keyword">def</span> query = Person.where(callable)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above must be written as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.DetachedCriteria</span>

<span class="keyword">def</span> callable = {
    lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span>
} <span class="keyword">as</span> DetachedCriteria&lt;Person&gt;
<span class="keyword">def</span> query = Person.where(callable)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see the closure definition is cast (using the Groovy <code>as</code> keyword) to a <a href="#detachedCriteria">DetachedCriteria</a> instance targeted at the <code>Person</code> class.</p>
</div>
</div>
<div class="sect3">
<h4 id="_conjunction_disjunction_and_negation">7.4.3. Conjunction, Disjunction and Negation</h4>
<div class="paragraph">
<p>As mentioned previously you can combine regular Groovy logical operators (<code>||</code> and <code>&amp;&amp;</code>) to form conjunctions and disjunctions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
    (lastName != <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span> &amp;&amp; firstName != <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>) || (firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Bart</span><span class="delimiter">&quot;</span></span> &amp;&amp; age &gt; <span class="integer">9</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also negate a logical comparison using <code>!</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
    firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> &amp;&amp; !(lastName == <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_property_comparison_queries">7.4.4. Property Comparison Queries</h4>
<div class="paragraph">
<p>If you use a property name on both the left hand and right side of a comparison expression then the appropriate property comparison criteria is automatically used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
   firstName == lastName
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table described how each comparison operator maps onto each criteria property comparison method:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Criteria Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>==</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">eqProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>!=</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">neProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&gt;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gtProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&lt;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ltProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&gt;=</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">geProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Greater than or equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&#8656;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">leProperty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than or equal to</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_querying_associations_2">7.4.5. Querying Associations</h4>
<div class="paragraph">
<p>Associations can be queried by using the dot operator to specify the property name of the association to be queried:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Pet.where {
    owner.firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> || owner.firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can group multiple criterion inside a closure method call where the name of the method matches the association name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
    pets { name == <span class="string"><span class="delimiter">&quot;</span><span class="content">Jack</span><span class="delimiter">&quot;</span></span> || name == <span class="string"><span class="delimiter">&quot;</span><span class="content">Joe</span><span class="delimiter">&quot;</span></span> }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This technique can be combined with other top-level criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
     pets { name == <span class="string"><span class="delimiter">&quot;</span><span class="content">Jack</span><span class="delimiter">&quot;</span></span> } || firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Ed</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For collection associations it is possible to apply queries to the size of the collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
       pets.size() == <span class="integer">2</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table shows which operator maps onto which criteria method for each size() comparison:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Operator</th>
<th class="tableblock halign-left valign-top">Criteria Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>==</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeEq</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection size is equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>!=</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeNe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection size is not equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&gt;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeGt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection size is greater than</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&lt;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeLt</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection size is less than</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&gt;=</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeGe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection size is greater than or equal to</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>&#8656;</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sizeLe</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The collection size is less than or equal to</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_query_aliases_and_sorting">7.4.6. Query Aliases and Sorting</h4>
<div class="paragraph">
<p>If you define a query for an association an alias is automatically generated for the query. For example the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Pet.where {
    owner.firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will generate an alias for the <code>owner</code> association such as <code>owner_alias_0</code>. These generated aliases are fine for most cases, but are not useful if you want to later sort or use a projection on the results. For example the following query will fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">// fails because a dynamic alias is used</span>
Pet.where {
    owner.firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>
}.list(<span class="key">sort</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">owner.lastName</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you plan to sort the results then an explicit alias should be used and these can be defined by simply declaring a variable in the <code>where</code> query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Pet.where {
    <span class="keyword">def</span> o1 = owner <i class="conum" data-value="1"></i><b>(1)</b>
    o1.firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
}.list(<span class="key">sort</span>:<span class="string"><span class="delimiter">'</span><span class="content">o1.lastName</span><span class="delimiter">'</span></span>) <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Define an alias called <code>o1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use the alias in the query itself</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use the alias to sort the results</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By assigning the name of an association to a local variable it will automatically become an alias usable within the query itself and also for the purposes of sorting or projecting the results.</p>
</div>
</div>
<div class="sect3">
<h4 id="_subqueries">7.4.7. Subqueries</h4>
<div class="paragraph">
<p>It is possible to execute subqueries within where queries. For example to find all the people older than the average age the following query can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">final</span> query = Person.where {
  age &gt; avg(age)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table lists the possible subqueries:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>avg</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The average of all values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>sum</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The sum of all values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>max</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>min</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>count</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The count of all values</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>property</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Retrieves a property of the resulting entities</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can apply additional criteria to any subquery by using the <code>of</code> method and passing in a closure containing the criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
  age &gt; avg(age).of { lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span> } &amp;&amp; firstName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Homer</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the <code>property</code> subquery returns multiple results, the criterion used compares all results. For example the following query will find all people younger than people with the surname "Simpson":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Person.where {
    age &lt; property(age).of { lastName == <span class="string"><span class="delimiter">&quot;</span><span class="content">Simpson</span><span class="delimiter">&quot;</span></span> }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_more_advanced_subqueries_in_gorm">7.4.8. More Advanced Subqueries in GORM</h4>
<div class="paragraph">
<p>The support for subqueries has been extended. You can now use in  with nested subqueries</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.where {
    firstName <span class="keyword">in</span> where { age &lt; <span class="integer">18</span> }.firstName
}.list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Criteria and where queries can be seamlessly mixed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.withCriteria {
    notIn <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>, Person.where { age &lt; <span class="integer">18</span> }.firstName
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Subqueries can be used with projections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.where {
    age &gt; where { age &gt; <span class="integer">18</span> }.avg(<span class="string"><span class="delimiter">'</span><span class="content">age</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Correlated queries that span two domain classes can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> employees = Employee.where {
    region.continent <span class="keyword">in</span> [<span class="string"><span class="delimiter">'</span><span class="content">APAC</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EMEA</span><span class="delimiter">&quot;</span></span>]
    }.id()
    <span class="keyword">def</span> results = Sale.where {
    employee <span class="keyword">in</span> employees &amp;&amp; total &gt; <span class="integer">100000</span>
    }.employee.list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>And support for aliases (cross query references) using simple variable declarations has been added to where queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Employee.where {
    <span class="keyword">def</span> em1 = Employee
    exists Sale.where {
        <span class="keyword">def</span> s1 = Sale
        <span class="keyword">def</span> em2 = employee
        <span class="keyword">return</span> em2.id == em1.id
    }.id()
}
<span class="keyword">def</span> results = query.list()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_functions">7.4.9. Other Functions</h4>
<div class="paragraph">
<p>There are several functions available to you within the context of a query. These are summarized in the table below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>second</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The second of a date property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>minute</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minute of a date property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>hour</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The hour of a date property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>day</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The day of the month of a date property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>month</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The month of a date property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>year</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The year of a date property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>lower</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a string property to lower case</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>upper</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Converts a string property to upper case</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>length</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The length of a string property</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>trim</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Trims a string property</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Currently functions can only be applied to properties or associations of domain classes. You cannot, for example, use a function on a result of a subquery.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For example the following query can be used to find all pet&#8217;s born in 2011:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Pet.where {
    year(birthDate) == <span class="integer">2011</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also apply functions to associations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> query = Person.where {
    year(pets.birthDate) == <span class="integer">2009</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_batch_updates_and_deletes">7.4.10. Batch Updates and Deletes</h4>
<div class="paragraph">
<p>Since each <code>where</code> method call returns a <a href="#detachedCriteria">DetachedCriteria</a> instance, you can use <code>where</code> queries to execute batch operations such as batch updates and deletes. For example, the following query will update all people with the surname "Simpson" to have the surname "Bloggs":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">DetachedCriteria&lt;Person&gt; query = Person.where {
    lastName == <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="type">int</span> total = query.updateAll(<span class="key">lastName</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Bloggs</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that one limitation with regards to batch operations is that join queries (queries that query associations) are not allowed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To batch delete records you can use the <code>deleteAll</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">DetachedCriteria&lt;Person&gt; query = Person.where {
    lastName == <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="type">int</span> total = query.deleteAll()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="criteria">7.5. Criteria</h3>
<div class="paragraph">
<p>Criteria is an advanced way to query that uses a Groovy builder to construct potentially complex queries. It is a much better approach than building up query strings using a <code>StringBuilder</code>.</p>
</div>
<div class="paragraph">
<p>Criteria can be used either with the <a href="../api/org/grails/datastore/gorm/GormEntity.html#createCriteria()">createCriteria()</a> or <a href="../api/org/grails/datastore/gorm/GormEntity.html#withCriteria(groovy.lang.Closure)">withCriteria(closure)</a> methods.</p>
</div>
<div class="paragraph">
<p>The builder uses Hibernate&#8217;s Criteria API. The nodes on this builder map the static methods found in the <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/criterion/Restrictions.html">Restrictions</a> class of the Hibernate Criteria API. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> c = Account.createCriteria()
<span class="keyword">def</span> results = c {
    between(<span class="string"><span class="delimiter">&quot;</span><span class="content">balance</span><span class="delimiter">&quot;</span></span>, <span class="integer">500</span>, <span class="integer">1000</span>)
    eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">branch</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">London</span><span class="delimiter">&quot;</span></span>)
    or {
        like(<span class="string"><span class="delimiter">&quot;</span><span class="content">holderFirstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred%</span><span class="delimiter">&quot;</span></span>)
        like(<span class="string"><span class="delimiter">&quot;</span><span class="content">holderFirstName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Barney%</span><span class="delimiter">&quot;</span></span>)
    }
    maxResults(<span class="integer">10</span>)
    order(<span class="string"><span class="delimiter">&quot;</span><span class="content">holderLastName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This criteria will select up to 10 <code>Account</code> objects in a List matching the following criteria:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>balance</code> is between 500 and 1000</p>
</li>
<li>
<p><code>branch</code> is <em>London</em></p>
</li>
<li>
<p><code>holderFirstName</code> starts with <em>Fred</em> or <em>Barney</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The results will be sorted in descending order by <code>holderLastName</code>.</p>
</div>
<div class="paragraph">
<p>If no records are found with the above criteria, an empty List is returned.</p>
</div>
<div class="sect3">
<h4 id="_conjunctions_and_disjunctions">7.5.1. Conjunctions and Disjunctions</h4>
<div class="paragraph">
<p>As demonstrated in the previous example you can group criteria in a logical OR using an <code>or { }</code> block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">or {
    between(<span class="string"><span class="delimiter">&quot;</span><span class="content">balance</span><span class="delimiter">&quot;</span></span>, <span class="integer">500</span>, <span class="integer">1000</span>)
    eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">branch</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">London</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also works with logical AND:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">and {
    between(<span class="string"><span class="delimiter">&quot;</span><span class="content">balance</span><span class="delimiter">&quot;</span></span>, <span class="integer">500</span>, <span class="integer">1000</span>)
    eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">branch</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">London</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you can also negate using logical NOT:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">not {
    between(<span class="string"><span class="delimiter">&quot;</span><span class="content">balance</span><span class="delimiter">&quot;</span></span>, <span class="integer">500</span>, <span class="integer">1000</span>)
    eq(<span class="string"><span class="delimiter">&quot;</span><span class="content">branch</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">London</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All top level conditions are implied to be AND&#8217;d together.</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_associations_3">7.5.2. Querying Associations</h4>
<div class="paragraph">
<p>Associations can be queried by having a node that matches the property name. For example say the <code>Account</code> class had many <code>Transaction</code> objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Account</span> {
    ...
    static hasMany = [<span class="key">transactions</span>: Transaction]
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can query this association by using the property name <code>transactions</code> as a builder node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Account.createCriteria()
def now = <span class="keyword">new</span> <span class="predefined-type">Date</span>()
def results = c.list {
    transactions {
        between(<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>, now - <span class="integer">10</span>, now)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above code will find all the <code>Account</code> instances that have performed <code>transactions</code> within the last 10 days.
You can also nest such association queries within logical blocks:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Account.createCriteria()
def now = <span class="keyword">new</span> <span class="predefined-type">Date</span>()
def results = c.list {
    or {
        between(<span class="string"><span class="delimiter">'</span><span class="content">created</span><span class="delimiter">'</span></span>, now - <span class="integer">10</span>, now)
        transactions {
            between(<span class="string"><span class="delimiter">'</span><span class="content">date</span><span class="delimiter">'</span></span>, now - <span class="integer">10</span>, now)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we find all accounts that have either performed transactions in the last 10 days OR have been recently created in the last 10 days.</p>
</div>
</div>
<div class="sect3">
<h4 id="_querying_with_projections">7.5.3. Querying with Projections</h4>
<div class="paragraph">
<p>Projections may be used to customise the results. Define a "projections" node within the criteria builder tree to use projections. There are equivalent methods within the projections node to the methods found in the Hibernate <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/criterion/Projections.html">Projections</a> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Account.createCriteria()

def numberOfBranches = c.get {
    projections {
        countDistinct(<span class="string"><span class="delimiter">'</span><span class="content">branch</span><span class="delimiter">'</span></span>)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When multiple fields are specified in the projection, a List of values will be returned. A single value will be returned otherwise.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transforming_projection_results">7.5.4. Transforming Projection Results</h4>
<div class="paragraph">
<p>If the raw value or simple object array returned by the criteria method doesn&#8217;t suit your needs, the result can be transformed with a <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/transform/ResultTransformer.html">ResultTransformer</a>. Let&#8217;s say we want to transform the criteria results into a Map so that we can easily reference values by key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Account.createCriteria()

def accountsOverview = c.get {
    resultTransformer(CriteriaSpecification.ALIAS_TO_ENTITY_MAP)
    projections {
        sum(<span class="string"><span class="delimiter">'</span><span class="content">balance</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">allBalances</span><span class="delimiter">'</span></span>)
        countDistinct(<span class="string"><span class="delimiter">'</span><span class="content">holderLastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lastNames</span><span class="delimiter">'</span></span>)
    }
}

<span class="comment">// accountsOverview.allBalances</span>
<span class="comment">// accountsOverview.lastNames</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we&#8217;ve added an alias to each projection as an additional parameter to be used as the key. For this to work, all projections must have aliases defined, otherwise the corresponding map entry will not be built.</p>
</div>
<div class="paragraph">
<p>We can also transform the result into an object of our choosing via the <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/transform/Transformers.html#aliasToBean-java.lang.Class-">Transformers.aliasToBean()</a> method. In this case, we&#8217;ll transform it into an <code>AccountsOverview</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">AccountsOverview</span> {
    <span class="predefined-type">Number</span> allBalances
    <span class="predefined-type">Number</span> lastNames
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Account.createCriteria()

def accountsOverview = c.get {
    resultTransformer(Transformers.aliasToBean(AccountsOverview))
    projections {
        sum(<span class="string"><span class="delimiter">'</span><span class="content">balance</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">allBalances</span><span class="delimiter">'</span></span>)
        countDistinct(<span class="string"><span class="delimiter">'</span><span class="content">holderLastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lastNames</span><span class="delimiter">'</span></span>)
    }
}

<span class="comment">// accountsOverview instanceof AccountsOverview</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each alias must have a corresponding property or explicit setter on the bean otherwise an exception will be thrown.</p>
</div>
</div>
<div class="sect3">
<h4 id="_sql_projections">7.5.5. SQL Projections</h4>
<div class="paragraph">
<p>The criteria DSL provides access to Hibernate&#8217;s SQL projection API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Box is a domain class...</span>
<span class="type">class</span> <span class="class">Box</span> {
    <span class="type">int</span> width
    <span class="type">int</span> height
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Use SQL projections to retrieve the perimeter and area of all of the Box instances...</span>
def c = <span class="predefined-type">Box</span>.createCriteria()

def results = c.list {
    projections {
      sqlProjection <span class="string"><span class="delimiter">'</span><span class="content">(2 * (width + height)) as perimeter, (width * height) as area</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">perimeter</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">area</span><span class="delimiter">'</span></span>], [INTEGER, INTEGER]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument to the <code>sqlProjection</code> method is the SQL which defines the projections.  The second argument is a list of
Strings which represent column aliases corresponding to the projected values expressed in the SQL.  The third argument
is a list of <code>org.hibernate.type.Type</code> instances which correspond to the projected values expressed in the SQL.  The API
supports all <code>org.hibernate.type.Type</code> objects but constants like INTEGER, LONG, FLOAT etc. are provided by the DSL which
correspond to all of the types defined in <code>org.hibernate.type.StandardBasicTypes</code>.</p>
</div>
<div class="paragraph">
<p>Consider that the following table represents the data in the
<code>BOX</code> table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">width</th>
<th class="tableblock halign-left valign-top">height</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">9</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The query above would return results like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">[[<span class="integer">18</span>, <span class="integer">14</span>], [<span class="integer">20</span>, <span class="integer">16</span>], [<span class="integer">22</span>, <span class="integer">18</span>], [<span class="integer">26</span>, <span class="integer">36</span>]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the inner lists contains the 2 projected values for each <code>Box</code>, perimeter and area.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that if there are other references in scope wherever your criteria query is expressed that have names that conflict
with any of the type constants described above, the code in your criteria will refer to those references, not the type
constants provided by the DSL.  In the unlikely event of that happening you can disambiguate the conflict by referring
to the fully qualified Hibernate type.  For example <code>StandardBasicTypes.INTEGER</code> instead of <code>INTEGER</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If only 1 value is being projected, the alias and the type do not need to be included in a list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results = c.list {
    projections {
      sqlProjection <span class="string"><span class="delimiter">'</span><span class="content">sum(width * height) as totalArea</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">totalArea</span><span class="delimiter">'</span></span>, INTEGER
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>That query would return a single result with the value of 84 as the total area of all of the <code>Box</code> instances.</p>
</div>
<div class="paragraph">
<p>The DSL supports grouped projections with the <code>sqlGroupProjection</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results = c.list {
    projections {
        sqlGroupProjection <span class="string"><span class="delimiter">'</span><span class="content">width, sum(height) as combinedHeightsForThisWidth</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">width</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">width</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">combinedHeightsForThisWidth</span><span class="delimiter">'</span></span>], [INTEGER, INTEGER]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument to the <code>sqlGroupProjection</code> method is the SQL which defines the projections.  The second argument represents the
group by clause that should be part of the query.  That string may be single column name or a comma separated list of column
names.  The third argument is a list of
Strings which represent column aliases corresponding to the projected values expressed in the SQL.  The fourth argument
is a list of <code>org.hibernate.type.Type</code> instances which correspond to the projected values expressed in the SQL.</p>
</div>
<div class="paragraph">
<p>The query above is projecting the combined heights of boxes grouped by width and would return results that look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">[[<span class="integer">2</span>, <span class="integer">24</span>], [<span class="integer">4</span>, <span class="integer">9</span>]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the inner lists contains 2 values.  The first value is a box width and the second value is the sum of the heights
of all of the boxes which have that width.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_sql_restrictions">7.5.6. Using SQL Restrictions</h4>
<div class="paragraph">
<p>You can access Hibernate&#8217;s SQL Restrictions capabilities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Person.createCriteria()

def peopleWithShortFirstNames = c.list {
    sqlRestriction <span class="string"><span class="delimiter">&quot;</span><span class="content">char_length(first_name) &lt;= 4</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>SQL Restrictions may be parameterized to deal with SQL injection vulnerabilities related to dynamic restrictions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def c = Person.createCriteria()

def peopleWithShortFirstNames = c.list {
    sqlRestriction <span class="string"><span class="delimiter">&quot;</span><span class="content">char_length(first_name) &lt; ? AND char_length(first_name) &gt; ?</span><span class="delimiter">&quot;</span></span>, [maxValue, minValue]
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that the parameter there is SQL. The <code>first_name</code> attribute referenced in the example refers to the persistence model, not the object model like in HQL queries. The <code>Person</code> property named <code>firstName</code> is mapped to the <code>first_name</code> column in the database and you must refer to that in the <code>sqlRestriction</code> string.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Also note that the SQL used here is not necessarily portable across databases.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_scrollable_results">7.5.7. Using Scrollable Results</h4>
<div class="paragraph">
<p>You can use Hibernate&#8217;s <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/ScrollableResults.html">ScrollableResults</a> feature by calling the scroll method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results = crit.scroll {
    maxResults(<span class="integer">10</span>)
}
def f = results.first()
def l = results.last()
def n = results.next()
def p = results.previous()

def future = results.scroll(<span class="integer">10</span>)
def accountNumber = results.getLong(<span class="string"><span class="delimiter">'</span><span class="content">number</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To quote the documentation of Hibernate ScrollableResults:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A result iterator that allows moving around within the results by arbitrary increments. The Query / ScrollableResults pattern is very similar to the JDBC PreparedStatement / ResultSet pattern and the semantics of methods of this interface are similar to the similarly named methods on ResultSet.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Contrary to JDBC, columns of results are numbered from zero.</p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_properties_in_the_criteria_instance">7.5.8. Setting properties in the Criteria instance</h4>
<div class="paragraph">
<p>If a node within the builder tree doesn&#8217;t match a particular criterion it will attempt to set a property on the Criteria object itself. This allows full access to all the properties in this class. This example calls <code>setMaxResults</code> and <code>setFirstResult</code> on the <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/Criteria.html">Criteria</a> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.hibernate.FetchMode</span> <span class="include">as</span> <span class="include">FM</span>
...
<span class="include">def</span> <span class="include">results</span> = <span class="include">c.list</span> {
    <span class="include">maxResults</span>(<span class="integer">10</span>)
    <span class="include">firstResult</span>(<span class="integer">50</span>)
    <span class="include">fetchMode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">aRelationship</span><span class="delimiter">&quot;</span></span>, <span class="include">FM.JOIN</span>)
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_querying_with_eager_fetching">7.5.9. Querying with Eager Fetching</h4>
<div class="paragraph">
<p>In the section on <a href="#fetching">Eager and Lazy Fetching</a> we discussed how to declaratively specify fetching to avoid the N+1 SELECT problem. However, this can also be achieved using a criteria query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def criteria = Task.createCriteria()
def tasks = criteria.list{
    eq <span class="string"><span class="delimiter">&quot;</span><span class="content">assignee.id</span><span class="delimiter">&quot;</span></span>, task.assignee.id
    join <span class="string"><span class="delimiter">'</span><span class="content">assignee</span><span class="delimiter">'</span></span>
    join <span class="string"><span class="delimiter">'</span><span class="content">project</span><span class="delimiter">'</span></span>
    order <span class="string"><span class="delimiter">'</span><span class="content">priority</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">asc</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the usage of the <code>join</code> method: it tells the criteria API to use a <code>JOIN</code> to fetch the named associations with the <code>Task</code> instances. It&#8217;s probably best not to use this for one-to-many associations though, because you will most likely end up with duplicate results. Instead, use the <em>select</em> fetch mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.hibernate.FetchMode</span> <span class="keyword">as</span> <span class="class">FM</span>
...
def results = Airport.withCriteria {
    eq <span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EMEA</span><span class="delimiter">&quot;</span></span>
    fetchMode <span class="string"><span class="delimiter">&quot;</span><span class="content">flights</span><span class="delimiter">&quot;</span></span>, FM.SELECT
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although this approach triggers a second query to get the <code>flights</code> association, you will get reliable results  - even with the <code>maxResults</code> option.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>fetchMode</code> and <code>join</code> are general settings of the query and can only be specified at the top-level, i.e. you cannot use them inside projections or association constraints.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An important point to bear in mind is that if you include associations in the query constraints, those associations will automatically be eagerly loaded. For example, in this query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Airport.withCriteria {
    eq <span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EMEA</span><span class="delimiter">&quot;</span></span>
    flights {
        like <span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">BA%</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>the <code>flights</code> collection would be loaded eagerly via a join even though the fetch mode has not been explicitly set.</p>
</div>
</div>
<div class="sect3">
<h4 id="_method_reference">7.5.10. Method Reference</h4>
<div class="paragraph">
<p>If you invoke the builder with no method name such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">c { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The build defaults to listing all the results and hence the above is equivalent to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">c.list { ... }</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>list</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is the default method. It returns all matching rows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns a unique result set i.e. just one row. The criteria has to be formed in a way that it only queries one row. This method is not to be confused with a limit to just the first row.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>scroll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns a scrollable result set.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>listDistinct</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If subqueries or associations are used one may end up with the same row multiple times in the result set. This allows listing only distinct entities and is equivalent to <code>DISTINCT_ROOT_ENTITY</code> of the <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/criterion/CriteriaSpecification.html">CriteriaSpecification</a> class.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>count</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the number of matching rows.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_combining_criteria">7.5.11. Combining Criteria</h4>
<div class="paragraph">
<p>You can combine multiple criteria closures in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def emeaCriteria = {
    eq <span class="string"><span class="delimiter">&quot;</span><span class="content">region</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">EMEA</span><span class="delimiter">&quot;</span></span>
}

def results = Airport.withCriteria {
    emeaCriteria.delegate = delegate
    emeaCriteria()
    flights {
        like <span class="string"><span class="delimiter">&quot;</span><span class="content">number</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">BA%</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This technique requires that each criteria must refer to the same domain class (i.e. <code>Airport</code>).
A more flexible approach is to use Detached Criteria, as described in the following section.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="detachedCriteria">7.6. Detached Criteria</h3>
<div class="paragraph">
<p>Detached Criteria are criteria queries that are not associated with any given database session/connection. Supported since Grails 2.0, Detached Criteria queries have many uses including allowing you to create common reusable criteria queries, execute subqueries and execute batch updates/deletes.</p>
</div>
<div class="sect3">
<h4 id="_building_detached_criteria_queries">7.6.1. Building Detached Criteria Queries</h4>
<div class="paragraph">
<p>The primary point of entry for using the Detached Criteria is the <a href="../api/grails/gorm/DetachedCriteria.html">DetachedCriteria</a> class which accepts a domain class as the only argument to its constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.*</span>
...
def criteria = <span class="keyword">new</span> DetachedCriteria(Person)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have obtained a reference to a detached criteria instance you can execute <a href="#whereQueries">where</a> queries or criteria queries to build up the appropriate query. To build a normal criteria query you can use the <code>build</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that methods on the <a href="../api/grails/gorm/DetachedCriteria.html">DetachedCriteria</a> instance <strong>do not</strong> mutate the original object but instead return a new query. In other words, you have to use the return value of the <code>build</code> method to obtain the mutated criteria object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="keyword">def</span> bartQuery = criteria.build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">firstName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Bart</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_executing_detached_criteria_queries">7.6.2. Executing Detached Criteria Queries</h4>
<div class="paragraph">
<p>Unlike regular criteria, Detached Criteria are lazy, in that no query is executed at the point of definition. Once a Detached Criteria query has been constructed then there are a number of useful query methods which are summarized in the table below:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>list</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List all matching entities</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>get</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return a single matching result</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>count</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count all matching records</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>exists</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return true if any matching records exist</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>deleteAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete all matching records</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>updateAll(Map)</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update all matching records with the given properties</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As an example the following code will list the first 4 matching records sorted by the <code>firstName</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="keyword">def</span> results = criteria.list(<span class="key">max</span>:<span class="integer">4</span>, <span class="key">sort</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also supply additional criteria to the list method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = criteria.list(<span class="key">max</span>:<span class="integer">4</span>, <span class="key">sort</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>) {
    gt <span class="string"><span class="delimiter">'</span><span class="content">age</span><span class="delimiter">'</span></span>, <span class="integer">30</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To retrieve a single result you can use the <code>get</code> or <code>find</code> methods (which are synonyms):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">Person p = criteria.find() <span class="comment">// or criteria.get()</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>DetachedCriteria</code> class itself also implements the <code>Iterable</code> interface which means that it can be treated like a list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
criteria.each {
    println <span class="local-variable">it</span>.firstName
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the query is only executed when the <code>each</code> method is called. The same applies to all other Groovy collection iteration methods.</p>
</div>
<div class="paragraph">
<p>You can also execute dynamic finders on <code>DetachedCriteria</code> just like on domain classes. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="keyword">def</span> bart = criteria.findByFirstName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Bart</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_detached_criteria_for_subqueries">7.6.3. Using Detached Criteria for Subqueries</h4>
<div class="paragraph">
<p>Within the context of a regular criteria query you can use <code>DetachedCriteria</code> to execute subquery. For example if you want to find all people who are older than the average age the following query will accomplish that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.withCriteria {
     gt <span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> DetachedCriteria(Person).build {
         projections {
             avg <span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>
         }
     }
     order <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in this case the subquery class is the same as the original criteria query class (i.e. <code>Person</code>) and hence the query can be shortened to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.withCriteria {
     gt <span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>, {
         projections {
             avg <span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>
         }
     }
     order <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the subquery class differs from the original criteria query then you will have to use the original syntax.</p>
</div>
<div class="paragraph">
<p>In the previous example the projection ensured that only a single result was returned (the average age). If your subquery returns multiple results then there are different criteria methods that need to be used to compare the result. For example to find all the people older than the ages 18 to 65 a <code>gtAll</code> query can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = Person.withCriteria {
    gtAll <span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>, {
        projections {
            property <span class="string"><span class="delimiter">&quot;</span><span class="content">age</span><span class="delimiter">&quot;</span></span>
        }
        between <span class="string"><span class="delimiter">'</span><span class="content">age</span><span class="delimiter">'</span></span>, <span class="integer">18</span>, <span class="integer">65</span>
    }

    order <span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table summarizes criteria methods for operating on subqueries that return multiple results:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>gtAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">greater than all subquery results</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>geAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">greater than or equal to all subquery results</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>ltAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">less than all subquery results</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>leAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">less than or equal to all subquery results</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>eqAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">equal to all subquery results</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>neAll</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not equal to all subquery results</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_batch_operations_with_detached_criteria">7.6.4. Batch Operations with Detached Criteria</h4>
<div class="paragraph">
<p>The <a href="../api/grails/gorm/DetachedCriteria.html">DetachedCriteria</a> class can be used to execute batch operations such as batch updates and deletes. For example, the following query will update all people with the surname "Simpson" to have the surname "Bloggs":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="type">int</span> total = criteria.updateAll(<span class="key">lastName</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Bloggs</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that one limitation with regards to batch operations is that join queries (queries that query associations) are not allowed within the <code>DetachedCriteria</code> instance.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To batch delete records you can use the <code>deleteAll</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> criteria = <span class="keyword">new</span> DetachedCriteria(Person).build {
    eq <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Simpson</span><span class="delimiter">'</span></span>
}
<span class="type">int</span> total = criteria.deleteAll()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="hql">7.7. Hibernate Query Language (HQL)</h3>
<div class="paragraph">
<p>GORM classes also support Hibernate&#8217;s query language HQL, a very complete reference for which can be found <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#hql">in the Hibernate documentation</a> of the Hibernate documentation.</p>
</div>
<div class="paragraph">
<p>GORM provides a number of methods that work with HQL including <a href="../api/org/grails/datastore/gorm/GormEntity.html#find(java.lang.String)">find</a>, <a href="../api/org/grails/datastore/gorm/GormEntity.html#findAll(java.lang.String)">findAll</a> and <a href="../api/org/grails/datastore/gorm/GormEntity.html#executeQuery(java.lang.String)">executeQuery</a>.</p>
</div>
<div class="paragraph">
<p>An example of a query can be seen below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results =
      <span class="predefined-type">Book</span>.findAll(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Book as b where b.title like 'Lord of the%'</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_named_parameters">7.7.1. Named Parameters</h4>
<div class="paragraph">
<p>In this case the value passed to the query is hard coded, however you can equally use named parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results =
      <span class="predefined-type">Book</span>.findAll(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Book as b </span><span class="delimiter">&quot;</span></span> +
                   <span class="string"><span class="delimiter">&quot;</span><span class="content">where b.title like :search or b.author like :search</span><span class="delimiter">&quot;</span></span>,
                   [search: <span class="string"><span class="delimiter">&quot;</span><span class="content">The Shi%</span><span class="delimiter">&quot;</span></span>])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def author = Author.findByName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Stephen King</span><span class="delimiter">&quot;</span></span>)
def books = <span class="predefined-type">Book</span>.findAll(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Book as book where book.author = :author</span><span class="delimiter">&quot;</span></span>,
                         [author: author])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multiline_queries">7.7.2. Multiline Queries</h4>
<div class="paragraph">
<p>Use the triple quoted strings to separate the query across multiple lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results = <span class="predefined-type">Book</span>.findAll(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">
from Book as b,
     Author as a
where b.author = a and a.surname = :surname</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, [surname:<span class="string"><span class="delimiter">'</span><span class="content">Smith</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_pagination_and_sorting_2">7.7.3. Pagination and Sorting</h4>
<div class="paragraph">
<p>You can also perform pagination and sorting whilst using HQL queries. To do so simply specify the pagination options as a Map at the end of the method call and include an "ORDER BY" clause in the HQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def results =
      <span class="predefined-type">Book</span>.findAll(<span class="string"><span class="delimiter">&quot;</span><span class="content">from Book as b where </span><span class="delimiter">&quot;</span></span> +
                   <span class="string"><span class="delimiter">&quot;</span><span class="content">b.title like 'Lord of the%' </span><span class="delimiter">&quot;</span></span> +
                   <span class="string"><span class="delimiter">&quot;</span><span class="content">order by b.title asc</span><span class="delimiter">&quot;</span></span>,
                   [max: <span class="integer">10</span>, offset: <span class="integer">20</span>])</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advancedGORMFeatures">8. Advanced GORM Features</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following sections cover more advanced usages of GORM including caching, custom mapping and events.</p>
</div>
<div class="sect2">
<h3 id="eventsAutoTimestamping">8.1. Events and Auto Timestamping</h3>
<div class="paragraph">
<p>GORM supports the registration of events as methods that get fired when certain events occurs such as deletes, inserts and updates. The following is a list of supported events:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>beforeInsert</code> - Executed before an object is initially persisted to the database.  If you return false, the insert will be cancelled.</p>
</li>
<li>
<p><code>beforeUpdate</code> - Executed before an object is updated.  If you return false, the update will be cancelled.</p>
</li>
<li>
<p><code>beforeDelete</code> - Executed before an object is deleted.  If you return false, the operation delete will be cancelled.</p>
</li>
<li>
<p><code>beforeValidate</code> - Executed before an object is validated</p>
</li>
<li>
<p><code>afterInsert</code> - Executed after an object is persisted to the database</p>
</li>
<li>
<p><code>afterUpdate</code> - Executed after an object has been updated</p>
</li>
<li>
<p><code>afterDelete</code> - Executed after an object has been deleted</p>
</li>
<li>
<p><code>onLoad</code> - Executed when an object is loaded from the database</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To add an event simply register the relevant method with your domain class.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do not attempt to flush the session within an event (such as with obj.save(flush:true)). Since events are fired during flushing this will cause a StackOverflowError.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_the_beforeinsert_event">8.1.1. The beforeInsert event</h4>
<div class="paragraph">
<p>Fired before an object is saved to the database</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Date</span> NULL_DATE = <span class="keyword">new</span> <span class="predefined-type">Date</span>(<span class="integer">0</span>)

   <span class="predefined-type">String</span> firstName
   <span class="predefined-type">String</span> lastName
   <span class="predefined-type">Date</span> signupDate = NULL_DATE

   def beforeInsert() {
      <span class="keyword">if</span> (signupDate == NULL_DATE) {
         signupDate = <span class="keyword">new</span> <span class="predefined-type">Date</span>()
      }
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_beforeupdate_event">8.1.2. The beforeUpdate event</h4>
<div class="paragraph">
<p>Fired before an existing object is updated</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

   def securityService

   <span class="predefined-type">String</span> firstName
   <span class="predefined-type">String</span> lastName
   <span class="predefined-type">String</span> lastUpdatedBy

   <span class="directive">static</span> constraints = {
      lastUpdatedBy nullable: <span class="predefined-constant">true</span>
   }

   <span class="directive">static</span> mapping = {
      autowire <span class="predefined-constant">true</span>
   }

   def beforeUpdate() {
      lastUpdatedBy = securityService.currentAuthenticatedUsername()
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the usage of <code>autowire true</code> above. This is required for the bean <code>securityService</code> to be injected.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_beforedelete_event">8.1.3. The beforeDelete event</h4>
<div class="paragraph">
<p>Fired before an object is deleted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="predefined-type">String</span> name

   def beforeDelete() {
      ActivityTrace.withNewSession {
         <span class="keyword">new</span> ActivityTrace(eventName: <span class="string"><span class="delimiter">&quot;</span><span class="content">Person Deleted</span><span class="delimiter">&quot;</span></span>, data: name).save()
      }
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice the usage of <code>withNewSession</code> method above. Since events are triggered whilst Hibernate is flushing using persistence methods like <code>save()</code> and <code>delete()</code> won&#8217;t result in objects being saved unless you run your operations with a new <code>Session</code>.</p>
</div>
<div class="paragraph">
<p>Fortunately the <code>withNewSession</code> method lets you share the same transactional JDBC connection even though you&#8217;re using a different underlying <code>Session</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_beforevalidate_event">8.1.4. The beforeValidate event</h4>
<div class="paragraph">
<p>Fired before an object is validated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="predefined-type">String</span> name

   <span class="directive">static</span> constraints = {
       name size: <span class="integer">5</span>.<span class="float">.45</span>
   }

   def beforeValidate() {
       name = name?.trim()
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>beforeValidate</code> method is run before any validators are run.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Validation may run more often than you think. It is triggered by the <code>validate()</code> and <code>save()</code> methods as you&#8217;d expect, but it is also typically triggered just before the view is rendered as well. So when writing <code>beforeValidate()</code> implementations, make sure that they can handle being called multiple times with the same property values.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>GORM supports an overloaded version of <code>beforeValidate</code> which accepts a <code>List</code> parameter which may include
the names of the properties which are about to be validated.  This version of <code>beforeValidate</code> will be called
when the <code>validate</code> method has been invoked and passed a <code>List</code> of property names as an argument.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="predefined-type">String</span> name
   <span class="predefined-type">String</span> town
   <span class="predefined-type">Integer</span> age

   <span class="directive">static</span> constraints = {
       name size: <span class="integer">5</span>.<span class="float">.45</span>
       age range: <span class="integer">4</span>.<span class="float">.99</span>
   }

   def beforeValidate(<span class="predefined-type">List</span> propertiesBeingValidated) {
      <span class="comment">// do pre validation work based on propertiesBeingValidated</span>
   }
}

def p = <span class="keyword">new</span> Person(name: <span class="string"><span class="delimiter">'</span><span class="content">Jacob Brown</span><span class="delimiter">'</span></span>, age: <span class="integer">10</span>)
p.validate([<span class="string"><span class="delimiter">'</span><span class="content">age</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>])</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note that when <code>validate</code> is triggered indirectly because of a call to the <code>save</code> method that
the <code>validate</code> method is being invoked with no arguments, not a <code>List</code> that includes all of
the property names.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Either or both versions of <code>beforeValidate</code> may be defined in a domain class.  GORM will
prefer the <code>List</code> version if a <code>List</code> is passed to <code>validate</code> but will fall back on the
no-arg version if the <code>List</code> version does not exist.  Likewise, GORM will prefer the
no-arg version if no arguments are passed to <code>validate</code> but will fall back on the
<code>List</code> version if the no-arg version does not exist.  In that case, <code>null</code> is passed to <code>beforeValidate</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_onloadbeforeload_event">8.1.5. The onLoad/beforeLoad event</h4>
<div class="paragraph">
<p>Fired immediately before an object is loaded from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="predefined-type">String</span> name
   <span class="predefined-type">Date</span> dateCreated
   <span class="predefined-type">Date</span> lastUpdated

   def onLoad() {
      log.debug <span class="string"><span class="delimiter">&quot;</span><span class="content">Loading ${id}</span><span class="delimiter">&quot;</span></span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>beforeLoad()</code> is effectively a synonym for <code>onLoad()</code>, so only declare one or the other.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_afterload_event">8.1.6. The afterLoad event</h4>
<div class="paragraph">
<p>Fired immediately after an object is loaded from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="predefined-type">String</span> name
   <span class="predefined-type">Date</span> dateCreated
   <span class="predefined-type">Date</span> lastUpdated

   def afterLoad() {
      name = <span class="string"><span class="delimiter">&quot;</span><span class="content">I'm loaded</span><span class="delimiter">&quot;</span></span>
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_event_listeners">8.1.7. Custom Event Listeners</h4>
<div class="paragraph">
<p>To register a custom event listener you need to subclass <code>AbstractPersistenceEventListener</code> (in package <em>org.grails.datastore.mapping.engine.event</em>) and implement the methods <code>onPersistenceEvent</code> and <code>supportsEventType</code>. You also must provide a reference to the datastore to the listener.  The simplest possible implementation can be seen below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">public</span> MyPersistenceListener(<span class="directive">final</span> Datastore datastore) {
    <span class="local-variable">super</span>(datastore)
}

<span class="annotation">@Override</span>
<span class="directive">protected</span> <span class="type">void</span> onPersistenceEvent(<span class="directive">final</span> AbstractPersistenceEvent event) {
    <span class="keyword">switch</span>(event.eventType) {
        <span class="keyword">case</span> <span class="key">PreInsert</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">PRE INSERT </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>
        <span class="keyword">case</span> <span class="key">PostInsert</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">POST INSERT </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>
        <span class="keyword">case</span> <span class="key">PreUpdate</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">PRE UPDATE </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="key">PostUpdate</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">POST UPDATE </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="key">PreDelete</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">PRE DELETE </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="key">PostDelete</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">POST DELETE </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="key">PreLoad</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">PRE LOAD </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>;
        <span class="keyword">case</span> <span class="key">PostLoad</span>:
            println <span class="string"><span class="delimiter">&quot;</span><span class="content">POST LOAD </span><span class="char">\$</span><span class="content">{event.entityObject}</span><span class="delimiter">&quot;</span></span>
        <span class="keyword">break</span>;
    }
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">boolean</span> supportsEventType(<span class="predefined-type">Class</span>&lt;? <span class="directive">extends</span> ApplicationEvent&gt; eventType) {
    <span class="keyword">return</span> <span class="predefined-constant">true</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AbstractPersistenceEvent</code> class has many subclasses (<code>PreInsertEvent</code>, <code>PostInsertEvent</code> etc.) that provide further information specific to the event. A <code>cancel()</code> method is also provided on the event which allows you to veto an insert, update or delete operation.</p>
</div>
<div class="paragraph">
<p>Once you have created your event listener you need to register it. If you are using Spring this can be done via the <code>ApplicationContext</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">HibernateDatastore datastore = applicationContext.getBean(HibernateDatastore)
applicationContext.addApplicationListener <span class="keyword">new</span> MyPersistenceListener(datastore)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are not using Spring then you can register the event listener using the <code>getApplicationEventPublisher()</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">HibernateDatastore datastore = ... <span class="comment">// get a reference to the datastore</span>
datastore.getApplicationEventPublisher()
         .addApplicationListener <span class="keyword">new</span> MyPersistenceListener(datastore)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_hibernate_events">8.1.8. Hibernate Events</h4>
<div class="paragraph">
<p>It is generally encouraged to use the non-Hibernate specific API described above, but if you need access to more detailed Hibernate events then you can define custom Hibernate-specific event listeners.</p>
</div>
<div class="paragraph">
<p>You can also register event handler classes in an application&#8217;s <code>grails-app/conf/spring/resources.groovy</code> or in the <code>doWithSpring</code> closure in a plugin descriptor by registering a Spring bean named <code>hibernateEventListeners</code>. This bean has one property, <code>listenerMap</code> which specifies the listeners to register for various Hibernate events.</p>
</div>
<div class="paragraph">
<p>The values of the Map are instances of classes that implement one or more Hibernate listener interfaces. You can use one class that implements all of the required interfaces, or one concrete class per interface, or any combination. The valid Map keys and corresponding interfaces are listed here:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"><strong>Name</strong></th>
<th class="tableblock halign-left valign-top"><strong>Interface</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">auto-flush</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/AutoFlushEventListener.html">AutoFlushEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">merge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/MergeEventListener.html">MergeEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">create</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PersistEventListener.html">PersistEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">create-onflush</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PersistEventListener.html">PersistEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/DeleteEventListener.html">DeleteEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dirty-check</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/DirtyCheckEventListener.html">DirtyCheckEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">evict</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/EvictEventListener.html">EvictEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flush</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/FlushEventListener.html">FlushEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">flush-entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/FlushEntityEventListener.html">FlushEntityEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">load</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/LoadEventListener.html">LoadEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">load-collection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/InitializeCollectionEventListener.html">InitializeCollectionEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">lock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/LockEventListener.html">LockEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">refresh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/RefreshEventListener.html">RefreshEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">replicate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/ReplicateEventListener.html">ReplicateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">save-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/SaveOrUpdateEventListener.html">SaveOrUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">save</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/SaveOrUpdateEventListener.html">SaveOrUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/SaveOrUpdateEventListener.html">SaveOrUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-load</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreLoadEventListener.html">PreLoadEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreUpdateEventListener.html">PreUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreDeleteEventListener.html">PreDeleteEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-insert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreInsertEventListener.html">PreInsertEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-collection-recreate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreCollectionRecreateEventListener.html">PreCollectionRecreateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-collection-remove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreCollectionRemoveEventListener.html">PreCollectionRemoveEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pre-collection-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PreCollectionUpdateEventListener.html">PreCollectionUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-load</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostLoadEventListener.html">PostLoadEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostUpdateEventListener.html">PostUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostDeleteEventListener.html">PostDeleteEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-insert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostInsertEventListener.html">PostInsertEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-commit-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostUpdateEventListener.html">PostUpdateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-commit-delete</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostDeleteEventListener.html">PostDeleteEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-commit-insert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostInsertEventListener.html">PostInsertEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-collection-recreate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostCollectionRecreateEventListener.html">PostCollectionRecreateEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-collection-remove</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostCollectionRemoveEventListener.html">PostCollectionRemoveEventListener</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">post-collection-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/event/spi/PostCollectionUpdateEventListener.html">PostCollectionUpdateEventListener</a></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, you could register a class <code>AuditEventListener</code> which implements <code>PostInsertEventListener</code>, <code>PostUpdateEventListener</code>, and <code>PostDeleteEventListener</code> using the following in an application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">beans = {

   auditListener(AuditEventListener)

   hibernateEventListeners(HibernateEventListeners) {
      listenerMap = [<span class="string"><span class="delimiter">'</span><span class="content">post-insert</span><span class="delimiter">'</span></span>: auditListener,
                     <span class="string"><span class="delimiter">'</span><span class="content">post-update</span><span class="delimiter">'</span></span>: auditListener,
                     <span class="string"><span class="delimiter">'</span><span class="content">post-delete</span><span class="delimiter">'</span></span>: auditListener]
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or use this in a plugin:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> doWithSpring = {

   auditListener(AuditEventListener)

   hibernateEventListeners(HibernateEventListeners) {
      listenerMap = [<span class="string"><span class="delimiter">'</span><span class="content">post-insert</span><span class="delimiter">'</span></span>: auditListener,
                     <span class="string"><span class="delimiter">'</span><span class="content">post-update</span><span class="delimiter">'</span></span>: auditListener,
                     <span class="string"><span class="delimiter">'</span><span class="content">post-delete</span><span class="delimiter">'</span></span>: auditListener]
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_timestamping">8.1.9. Automatic timestamping</h4>
<div class="paragraph">
<p>If you define a <code>dateCreated</code> property it will be set to the current date for you when you create new instances. Likewise, if you define a <code>lastUpdated</code> property it will be automatically be updated for you when you change persistent instances.</p>
</div>
<div class="paragraph">
<p>If this is not the behaviour you want you can disable this feature with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
   <span class="predefined-type">Date</span> dateCreated
   <span class="predefined-type">Date</span> lastUpdated
   <span class="directive">static</span> mapping = {
      autoTimestamp <span class="predefined-constant">false</span>
   }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you have <code>nullable: false</code> constraints on either <code>dateCreated</code> or <code>lastUpdated</code>, your domain instances will fail validation - probably not what you want. Omit constraints from these properties unless you disable automatic timestamping.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is also possible to disable the automatic timestamping temporarily. This is most typically done in the case of a test where you need to define values for the <code>dateCreated</code> or <code>lastUpdated</code> in the past. It may also be useful for importing old data from other systems where you would like to keep the current values of the timestamps.</p>
</div>
<div class="paragraph">
<p>Timestamps can be temporarily disabled for all domains, a specified list of domains, or a single domain. To get started, you need to get a reference to the <code>AutoTimestampEventListener</code>. If you already have access to the datastore, you can execute the <code>getAutoTimestampEventListener</code> method. If you don&#8217;t have access to the datastore, inject the <code>autoTimestampEventListener</code> bean.</p>
</div>
<div class="paragraph">
<p>Once you have a reference to the event listener, you can execute <code>withoutDateCreated</code>, <code>withoutLastUpdated</code>, or <code>withoutTimestamps</code>. The <code>withoutTimestamps</code> method will temporarily disable both <code>dateCreated</code> and <code>lastUpdated</code>.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="comment">//Only the dateCreated property handling will be disabled for only the Foo domain</span>
autoTimestampEventListener.withoutDateCreated(Foo) {
    <span class="keyword">new</span> Foo(<span class="key">dateCreated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">1</span>).save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
}

<span class="comment">//Only the lastUpdated property handling will be disabled for only the Foo and Bar domains</span>
autoTimestampEventListener.withoutLastUpdated(Foo, Bar) {
    <span class="keyword">new</span> Foo(<span class="key">lastUpdated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">1</span>, <span class="key">bar</span>: <span class="keyword">new</span> Bar(<span class="key">lastUpdated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() + <span class="integer">1</span>)).save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
}

<span class="comment">//All timestamp property handling will be disabled for all domains</span>
autoTimestampEventListener.withoutTimestamps {
    <span class="keyword">new</span> Foo(<span class="key">dateCreated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">2</span>, <span class="key">lastUpdated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">1</span>).save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
    <span class="keyword">new</span> Bar(<span class="key">dateCreated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">2</span>, <span class="key">lastUpdated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">1</span>).save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
    <span class="keyword">new</span> FooBar(<span class="key">dateCreated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">2</span>, <span class="key">lastUpdated</span>: <span class="keyword">new</span> <span class="predefined-type">Date</span>() - <span class="integer">1</span>).save(<span class="key">flush</span>: <span class="predefined-constant">true</span>)
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Because the timestamp handling is only disabled for the duration of the closure, you must flush the session during the closure execution!
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ormdsl">8.2. Custom ORM Mapping</h3>
<div class="paragraph">
<p>GORM domain classes can be mapped onto many legacy schemas with an Object Relational Mapping DSL (domain specific language). The following sections takes you through what is possible with the ORM DSL.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
None of this is necessary if you are happy to stick to the conventions defined by GORM for table names, column names and so on. You only needs this functionality if you need to tailor the way GORM maps onto legacy schemas or configures caching
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Custom mappings are defined using a static <code>mapping</code> block defined within your domain class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        version <span class="predefined-constant">false</span>
        autoTimestamp <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also configure global mappings in <code>application.groovy</code> (or an external config file) using this setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">grails.gorm.default.mapping = {
    version <span class="predefined-constant">false</span>
    autoTimestamp <span class="predefined-constant">false</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It has the same syntax as the standard <code>mapping</code> block but it applies to all your domain classes! You can then override these defaults within the <code>mapping</code> block of a domain class.</p>
</div>
<div class="sect3">
<h4 id="tableAndColumnNames">8.2.1. Table and Column Names</h4>
<div class="sect4">
<h5 id="_table_names">Table names</h5>
<div class="paragraph">
<p>The database table name which the class maps to can be customized using the <code>table</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the class would be mapped to a table called <code>people</code> instead of the default name of <code>person</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_column_names">Column names</h5>
<div class="paragraph">
<p>It is also possible to customize the mapping for individual columns onto the database. For example to change the name you can do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName

    <span class="directive">static</span> mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        firstName column: <span class="string"><span class="delimiter">'</span><span class="content">First_Name</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>firstName</code> is a dynamic method within the <code>mapping</code> Closure that has a single Map parameter. Since its name corresponds to a domain class persistent field, the parameter values (in this case just <code>"column"</code>) are used to configure the mapping for that property.</p>
</div>
</div>
<div class="sect4">
<h5 id="_column_type">Column type</h5>
<div class="paragraph">
<p>GORM supports configuration of Hibernate types with the DSL using the type attribute. This includes specifying user types that implement the Hibernate <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/usertype/UserType.html">org.hibernate.usertype.UserType</a> interface, which allows complete customization of how a type is persisted. As an example if you had a <code>PostCodeType</code> you could use it as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Address</span> {

    <span class="predefined-type">String</span> number
    <span class="predefined-type">String</span> postCode

    <span class="directive">static</span> mapping = {
        postCode type: PostCodeType
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively if you just wanted to map it to one of Hibernate&#8217;s basic types other than the default chosen by GORM you could use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Address</span> {

    <span class="predefined-type">String</span> number
    <span class="predefined-type">String</span> postCode

    <span class="directive">static</span> mapping = {
        postCode type: <span class="string"><span class="delimiter">'</span><span class="content">text</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would make the <code>postCode</code> column map to the default large-text type for the database you&#8217;re using (for example TEXT or CLOB).</p>
</div>
<div class="paragraph">
<p>See the Hibernate documentation regarding <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#basic-explicit">Basic Types</a> for further information.</p>
</div>
</div>
<div class="sect4">
<h5 id="_many_to_oneone_to_one_mappings">Many-to-One/One-to-One Mappings</h5>
<div class="paragraph">
<p>In the case of associations it is also possible to configure the foreign keys used to map associations. In the case of a many-to-one or one-to-one association this is exactly the same as any regular column. For example consider the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName
    Address address

    <span class="directive">static</span> mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        firstName column: <span class="string"><span class="delimiter">'</span><span class="content">First_Name</span><span class="delimiter">'</span></span>
        address column: <span class="string"><span class="delimiter">'</span><span class="content">Person_Address_Id</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the <code>address</code> association would map to a foreign key column called <code>address_id</code>. By using the above mapping we have changed the name of the foreign key column to <code>Person_Adress_Id</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_one_to_many_mapping">One-to-Many Mapping</h5>
<div class="paragraph">
<p>With a bidirectional one-to-many you can change the foreign key column used by changing the column name on the many side of the association as per the example in the previous section on one-to-one associations. However, with unidirectional associations the foreign key needs to be specified on the association itself. For example given a unidirectional one-to-many relationship between <code>Person</code> and <code>Address</code> the following code will change the foreign key in the <code>address</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName

    <span class="directive">static</span> hasMany = [addresses: Address]

    <span class="directive">static</span> mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        firstName column: <span class="string"><span class="delimiter">'</span><span class="content">First_Name</span><span class="delimiter">'</span></span>
        addresses column: <span class="string"><span class="delimiter">'</span><span class="content">Person_Address_Id</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you don&#8217;t want the column to be in the <code>address</code> table, but instead some intermediate join table you can use the <code>joinTable</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName

    <span class="directive">static</span> hasMany = [addresses: Address]

    <span class="directive">static</span> mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        firstName column: <span class="string"><span class="delimiter">'</span><span class="content">First_Name</span><span class="delimiter">'</span></span>
        addresses joinTable: [name: <span class="string"><span class="delimiter">'</span><span class="content">Person_Addresses</span><span class="delimiter">'</span></span>,
                              key: <span class="string"><span class="delimiter">'</span><span class="content">Person_Id</span><span class="delimiter">'</span></span>,
                              column: <span class="string"><span class="delimiter">'</span><span class="content">Address_Id</span><span class="delimiter">'</span></span>]
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_many_to_many_mapping">Many-to-Many Mapping</h5>
<div class="paragraph">
<p>GORM, by default maps a many-to-many association using a join table. For example consider this many-to-many association:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Group</span> {
    ...
    static hasMany = [people: Person]
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static belongsTo = <span class="predefined-type">Group</span>
    <span class="directive">static</span> hasMany = [groups: <span class="predefined-type">Group</span>]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case GORM will create a join table called <code>group_person</code> containing foreign keys called <code>person_id</code> and <code>group_id</code> referencing the <code>person</code> and <code>group</code> tables. To change the column names you can specify a column within the mappings for each class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Group</span> {
   ...
   static mapping = {
       people column: <span class="string"><span class="delimiter">'</span><span class="content">Group_Person_Id</span><span class="delimiter">'</span></span>
   }
}
<span class="type">class</span> <span class="class">Person</span> {
   ...
   static mapping = {
       groups column: <span class="string"><span class="delimiter">'</span><span class="content">Group_Group_Id</span><span class="delimiter">'</span></span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify the name of the join table to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Group</span> {
   ...
   static mapping = {
       people column: <span class="string"><span class="delimiter">'</span><span class="content">Group_Person_Id</span><span class="delimiter">'</span></span>,
              joinTable: <span class="string"><span class="delimiter">'</span><span class="content">PERSON_GROUP_ASSOCIATIONS</span><span class="delimiter">'</span></span>
   }
}
<span class="type">class</span> <span class="class">Person</span> {
   ...
   static mapping = {
       groups column: <span class="string"><span class="delimiter">'</span><span class="content">Group_Group_Id</span><span class="delimiter">'</span></span>,
              joinTable: <span class="string"><span class="delimiter">'</span><span class="content">PERSON_GROUP_ASSOCIATIONS</span><span class="delimiter">'</span></span>
   }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="caching">8.2.2. Caching Strategy</h4>
<div class="sect4">
<h5 id="_setting_up_caching">Setting up caching</h5>
<div class="paragraph">
<p><a href="https://www.hibernate.org/">Hibernate</a> features a second-level cache with a customizable cache provider. This needs to be configured in the <code>grails-app/conf/application.yml</code> file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">hibernate</span>:
  <span class="key">cache</span>:
    <span class="key">use_second_level_cache</span>: <span class="predefined-constant">true</span>
    <span class="key">provider_class</span>: net.sf.ehcache.hibernate.EhCacheProvider
    <span class="key">region</span>:
       <span class="key">factory_class</span>: org.hibernate.cache.ehcache.EhCacheRegionFactory</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can customize any of these settings, for example to use a distributed caching mechanism.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For further reading on caching and in particular Hibernate&#8217;s second-level cache, refer to the <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#caching">Hibernate documentation</a> on the subject.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_caching_instances">Caching instances</h5>
<div class="paragraph">
<p>Call the <code>cache</code> method in your mapping block to enable caching with the default settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        cache <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will configure a <em>read-write</em> cache that includes both lazy and non-lazy properties. You can customize this further:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        cache usage: <span class="string"><span class="delimiter">'</span><span class="content">read-only</span><span class="delimiter">'</span></span>, include: <span class="string"><span class="delimiter">'</span><span class="content">non-lazy</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_caching_associations">Caching associations</h5>
<div class="paragraph">
<p>As well as the ability to use Hibernate&#8217;s second level cache to cache instances you can also cache collections (associations) of objects. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName

    <span class="directive">static</span> hasMany = [addresses: Address]

    <span class="directive">static</span> mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        version <span class="predefined-constant">false</span>
        addresses column: <span class="string"><span class="delimiter">'</span><span class="content">Address</span><span class="delimiter">'</span></span>, cache: <span class="predefined-constant">true</span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Address</span> {
    <span class="predefined-type">String</span> number
    <span class="predefined-type">String</span> postCode
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will enable a <em>read-write</em> caching mechanism on the <code>addresses</code> collection. You can also use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cache: <span class="string"><span class="delimiter">'</span><span class="content">read-write</span><span class="delimiter">'</span></span> <span class="comment">// or 'read-only' or 'transactional'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>to further configure the cache usage.</p>
</div>
</div>
<div class="sect4">
<h5 id="_caching_queries">Caching Queries</h5>
<div class="paragraph">
<p>In order for the results of queries to be cached, you must enable caching in your mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">hibernate</span>:
  <span class="key">cache</span>:
    <span class="key">use_query_cache</span>: <span class="predefined-constant">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable query caching for all queries created by dynamic finders, GORM etc. you can specify:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="key">hibernate</span>:
  <span class="key">cache</span>:
    <span class="key">queries</span>: <span class="predefined-constant">true</span>    <span class="error">#</span> This implicitly sets  <span class="error">`</span>use_query_cache=<span class="predefined-constant">true</span><span class="error">`</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can cache queries such as dynamic finders and criteria. To do so using a dynamic finder you can pass the <code>cache</code> argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def person = Person.findByFirstName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>, [cache: <span class="predefined-constant">true</span>])</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also cache criteria queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def people = Person.withCriteria {
    like(<span class="string"><span class="delimiter">'</span><span class="content">firstName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Fr%</span><span class="delimiter">'</span></span>)
    cache <span class="predefined-constant">true</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_cache_usages">Cache usages</h5>
<div class="paragraph">
<p>Below is a description of the different cache settings and their usages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>read-only</code> - If your application needs to read but never modify instances of a persistent class, a read-only cache may be used.</p>
</li>
<li>
<p><code>read-write</code> - If the application needs to update data, a read-write cache might be appropriate.</p>
</li>
<li>
<p><code>nonstrict-read-write</code> - If the application only occasionally needs to update data (i.e. if it is very unlikely that two transactions would try to update the same item simultaneously) and strict transaction isolation is not required, a <code>nonstrict-read-write</code> cache might be appropriate.</p>
</li>
<li>
<p><code>transactional</code> - The <code>transactional</code> cache strategy provides support for fully transactional cache providers such as JBoss TreeCache. Such a cache may only be used in a JTA environment and you must specify <code>hibernate.transaction.manager_lookup_class</code> in the <code>grails-app/conf/application.groovy</code> file&#8217;s <code>hibernate</code> config.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="inheritanceStrategies">8.2.3. Inheritance Strategies</h4>
<div class="paragraph">
<p>By default GORM classes use <code>table-per-hierarchy</code> inheritance mapping. This has the disadvantage that columns cannot have a <code>NOT-NULL</code> constraint applied to them at the database level. If you would prefer to use a <code>table-per-subclass</code> inheritance strategy you can do so as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Payment</span> {
    <span class="predefined-type">Integer</span> amount

    <span class="directive">static</span> mapping = {
        tablePerHierarchy <span class="predefined-constant">false</span>
    }
}

<span class="type">class</span> <span class="class">CreditCardPayment</span> <span class="directive">extends</span> Payment {
    <span class="predefined-type">String</span> cardNumber
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping of the root <code>Payment</code> class specifies that it will not be using <code>table-per-hierarchy</code> mapping for all child classes.</p>
</div>
</div>
<div class="sect3">
<h4 id="identity">8.2.4. Custom Database Identity</h4>
<div class="paragraph">
<p>You can customize how GORM generates identifiers for the database using the DSL. By default GORM relies on the native database mechanism for generating ids. This is by far the best approach, but there are still many schemas that have different approaches to identity.</p>
</div>
<div class="paragraph">
<p>To deal with this Hibernate defines the concept of an id generator. You can customize the id generator and the column it maps to as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        version <span class="predefined-constant">false</span>
        id generator: <span class="string"><span class="delimiter">'</span><span class="content">hilo</span><span class="delimiter">'</span></span>,
           params: [table: <span class="string"><span class="delimiter">'</span><span class="content">hi_value</span><span class="delimiter">'</span></span>,
                    column: <span class="string"><span class="delimiter">'</span><span class="content">next_value</span><span class="delimiter">'</span></span>,
                    max_lo: <span class="integer">100</span>]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case we&#8217;re using one of Hibernate&#8217;s built in <em>hilo</em> generators that uses a separate table to generate ids.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information on the different Hibernate generators refer to the <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators">Hibernate reference documentation</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Although you don&#8217;t typically specify the <code>id</code> field (GORM adds it for you) you can still configure its mapping like the other properties. For example to customise the column for the id property you can do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        version <span class="predefined-constant">false</span>
        id column: <span class="string"><span class="delimiter">'</span><span class="content">person_id</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="compositePrimaryKeys">8.2.5. Composite Primary Keys</h4>
<div class="paragraph">
<p>GORM supports the concept of composite identifiers (identifiers composed from 2 or more properties). It is not an approach we recommend, but is available to you if you need it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.apache.commons.lang.builder.HashCodeBuilder</span>

<span class="type">class</span> <span class="class">Person</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> lastName

    <span class="type">boolean</span> equals(other) {
        <span class="keyword">if</span> (!(other <span class="keyword">instanceof</span> Person)) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>
        }

        other.firstName == firstName &amp;&amp; other.lastName == lastName
    }

    <span class="type">int</span> hashCode() {
        <span class="keyword">def</span> builder = <span class="keyword">new</span> HashCodeBuilder()
        builder.append firstName
        builder.append lastName
        builder.toHashCode()
    }

    <span class="directive">static</span> mapping = {
        id <span class="key">composite</span>: [<span class="string"><span class="delimiter">'</span><span class="content">firstName</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lastName</span><span class="delimiter">'</span></span>]
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above will create a composite id of the <code>firstName</code> and <code>lastName</code> properties of the Person class. To retrieve an instance by id you use a prototype of the object itself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def p = Person.get(<span class="keyword">new</span> Person(firstName: <span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>, lastName: <span class="string"><span class="delimiter">&quot;</span><span class="content">Flintstone</span><span class="delimiter">&quot;</span></span>))
println p.firstName</code></pre>
</div>
</div>
<div class="paragraph">
<p>Domain classes mapped with composite primary keys must implement the <code>Serializable</code> interface and override the <code>equals</code> and <code>hashCode</code> methods, using the properties in the composite key for the calculations. The example above uses a <code>HashCodeBuilder</code> for convenience but it&#8217;s fine to implement it yourself.</p>
</div>
<div class="paragraph">
<p>Another important consideration when using composite primary keys is associations. If for example you have a many-to-one association where the foreign keys are stored in the associated table then 2 columns will be present in the associated table.</p>
</div>
<div class="paragraph">
<p>For example consider the following domain class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Address</span> {
    Person person
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the <code>address</code> table will have an additional two columns called <code>person_first_name</code> and <code>person_last_name</code>. If you wish the change the mapping of these columns then you can do so using the following technique:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Address</span> {
    Person person
    <span class="directive">static</span> mapping = {
        columns {
                    person {
                column <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">FirstName</span><span class="delimiter">&quot;</span></span>
                column <span class="key">name</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">LastName</span><span class="delimiter">&quot;</span></span>
                        }
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="databaseIndices">8.2.6. Database Indices</h4>
<div class="paragraph">
<p>To get the best performance out of your queries it is often necessary to tailor the table index definitions. How you tailor them is domain specific and a matter of monitoring usage patterns of your queries. With GORM&#8217;s DSL you can specify which columns are used in which indexes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> firstName
    <span class="predefined-type">String</span> address
    <span class="directive">static</span> mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        version <span class="predefined-constant">false</span>
        id column: <span class="string"><span class="delimiter">'</span><span class="content">person_id</span><span class="delimiter">'</span></span>
        firstName column: <span class="string"><span class="delimiter">'</span><span class="content">First_Name</span><span class="delimiter">'</span></span>, index: <span class="string"><span class="delimiter">'</span><span class="content">Name_Idx</span><span class="delimiter">'</span></span>
        address column: <span class="string"><span class="delimiter">'</span><span class="content">Address</span><span class="delimiter">'</span></span>, index: <span class="string"><span class="delimiter">'</span><span class="content">Name_Idx,Address_Index</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that you cannot have any spaces in the value of the <code>index</code> attribute; in this example <code>index:'Name_Idx, Address_Index'</code> will cause an error.</p>
</div>
</div>
<div class="sect3">
<h4 id="optimisticLockingAndVersioning">8.2.7. Optimistic Locking and Versioning</h4>
<div class="paragraph">
<p>As discussed in the section on <a href="#locking">Optimistic and Pessimistic Locking</a>, by default GORM uses optimistic locking and automatically injects a <code>version</code> property into every class which is in turn mapped to a <code>version</code> column at the database level.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re mapping to a legacy schema that doesn&#8217;t have version columns (or there&#8217;s some other reason why you don&#8217;t want/need this feature) you can disable this with the <code>version</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    ...
    static mapping = {
        table <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
        version <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you disable optimistic locking you are essentially on your own with regards to concurrent updates and are open to the risk of users losing data (due to data overriding) unless you use <a href="#locking">pessimistic locking</a>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_version_columns_types">Version columns types</h5>
<div class="paragraph">
<p>By default GORM maps the <code>version</code> property as a <code>Long</code> that gets incremented by one each time an instance is updated. But Hibernate also supports using a <code>Timestamp</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.sql.Timestamp</span>

<span class="include">class</span> <span class="include">Person</span> {

    ...
    <span class="include">Timestamp</span> <span class="include">version</span>

    <span class="include">static</span> <span class="include">mapping</span> = {
        <span class="include">table</span> <span class="string"><span class="delimiter">'</span><span class="content">people</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There&#8217;s a slight risk that two updates occurring at nearly the same time on a fast server can end up with the same timestamp value but this risk is very low. One benefit of using a <code>Timestamp</code> instead of a <code>Long</code> is that you combine the optimistic locking and last-updated semantics into a single column.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="fetchingDSL">8.2.8. Eager and Lazy Fetching</h4>
<div class="sect4">
<h5 id="_lazy_collections">Lazy Collections</h5>
<div class="paragraph">
<p>As discussed in the section on <a href="#fetching">Eager and Lazy fetching</a>, GORM collections are lazily loaded by default but you can change this behaviour with the ORM DSL. There are several options available to you, but the most common ones are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>lazy: false</p>
</li>
<li>
<p>fetch: <em>join</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and they&#8217;re used like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName
    Pet pet

    <span class="directive">static</span> hasMany = [addresses: Address]

    <span class="directive">static</span> mapping = {
        addresses lazy: <span class="predefined-constant">false</span>
        pet fetch: <span class="string"><span class="delimiter">'</span><span class="content">join</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Address</span> {
    <span class="predefined-type">String</span> street
    <span class="predefined-type">String</span> postCode
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Pet</span> {
    <span class="predefined-type">String</span> name
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first option, <code>lazy: false</code> , ensures that when a <code>Person</code> instance is loaded, its <code>addresses</code> collection is loaded at the same time with a second SELECT. The second option is basically the same, except the collection is loaded with a JOIN rather than another SELECT. Typically you want to reduce the number of queries, so <code>fetch: 'join'</code> is the more appropriate option. On the other hand, it could feasibly be the more expensive approach if your domain model and data result in more and larger results than would otherwise be necessary.</p>
</div>
<div class="paragraph">
<p>For more advanced users, the other settings available are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>batchSize: N</code></p>
</li>
<li>
<p><code>lazy: false, batchSize: N</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>where N is an integer. These let you fetch results in batches, with one query per batch. As a simple example, consider this mapping for <code>Person</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName
    Pet pet

    <span class="directive">static</span> mapping = {
        pet <span class="key">batchSize</span>: <span class="integer">5</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a query returns multiple <code>Person</code> instances, then when we access the first <code>pet</code> property, Hibernate will fetch that <code>Pet</code> plus the four next ones. You can get the same behaviour with eager loading by combining <code>batchSize</code> with the <code>lazy: false</code> option.</p>
</div>
<div class="paragraph">
<p>You can find out more about these options in the <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#fetching">Hibernate user guide</a>. Note that ORM DSL does not currently support the "subselect" fetching strategy.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lazy_single_ended_associations">Lazy Single-Ended Associations</h5>
<div class="paragraph">
<p>In GORM, one-to-one and many-to-one associations are by default lazy. Non-lazy single ended associations can be problematic when you load many entities because each non-lazy association will result in an extra SELECT statement. If the associated entities also have non-lazy associations, the number of queries grows significantly!</p>
</div>
<div class="paragraph">
<p>Use the same technique as for lazy collections to make a one-to-one or many-to-one association non-lazy/eager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> firstName
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Address</span> {

    <span class="predefined-type">String</span> street
    <span class="predefined-type">String</span> postCode

    <span class="directive">static</span> belongsTo = [person: Person]

    <span class="directive">static</span> mapping = {
        person lazy: <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we configure GORM to load the associated <code>Person</code> instance (through the <code>person</code> property) whenever an <code>Address</code> is loaded.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lazy_associations_and_proxies">Lazy Associations and Proxies</h5>
<div class="paragraph">
<p>Hibernate uses runtime-generated proxies to facilitate single-ended lazy associations; Hibernate dynamically subclasses the entity class to create the proxy.</p>
</div>
<div class="paragraph">
<p>Consider the previous example but with a lazily-loaded <code>person</code> association: Hibernate will set the <code>person</code> property to a proxy that is a subclass of <code>Person</code>. When you call any of the getters (except for the <code>id</code> property) or setters on that proxy, Hibernate will load the entity from the database.</p>
</div>
<div class="paragraph">
<p>Unfortunately this technique can produce surprising results. Consider the following example classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Pet</span> {
    <span class="predefined-type">String</span> name
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Dog</span> <span class="directive">extends</span> Pet {
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {
    <span class="predefined-type">String</span> name
    Pet pet
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Proxies can have confusing behavior when combined with inheritance. Because the proxy is only a subclass of the parent class, any attempt to cast or access data on the subclass will fail. Assuming we have a single <code>Person</code> instance with a <code>Dog</code> as the <code>pet</code>.</p>
</div>
<div class="paragraph">
<p>The code below will not fail because directly querying the <code>Pet</code> table does not require the resulting objects to be proxies because they are not lazy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> pet = Pet.get(<span class="integer">1</span>)
<span class="keyword">assert</span> pet <span class="keyword">instanceof</span> Dog</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code will fail because the association is lazy and the <code>pet</code> instance is a proxy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> person = Person.get(<span class="integer">1</span>)
<span class="keyword">assert</span> person.pet <span class="keyword">instanceof</span> Dog</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the only goal is to check if the proxy is an instance of a class, there is one helper method available to do so that works with proxies. Take special care in using it though because it does cause a call to the database to retrieve the association data.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> person = Person.get(<span class="integer">1</span>)
<span class="keyword">assert</span> person.pet.instanceOf(Dog)</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple of ways to approach this issue. The first rule of thumb is that if it is known ahead of time that the association data is required, join the data in the query of the <code>Person</code>. For example, the following assertion is true.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> person = Person.where { id == <span class="integer">1</span> }.join(<span class="string"><span class="delimiter">&quot;</span><span class="content">pet</span><span class="delimiter">&quot;</span></span>).get()
<span class="keyword">assert</span> person.pet <span class="keyword">instanceof</span> Dog</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the <code>pet</code> association is no longer lazy because it is being retrieved along with the <code>Person</code> and thus no proxies are necessary. There are cases when it makes sense for a proxy to be returned, mostly in the case where its impossible to know if the data will be used or not. For those cases in order to access properties of the subclasses, the proxy must be unwrapped. To unwrap a proxy inject an instance of <a href="../api/org/grails/datastore/mapping/proxy/ProxyHandler.html">ProxyHandler</a> and pass the proxy to the <code>unwrap</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> person = Person.get(<span class="integer">1</span>)
<span class="keyword">assert</span> proxyHandler.unwrap(person.pet) <span class="keyword">instanceof</span> Dog</code></pre>
</div>
</div>
<div class="paragraph">
<p>For cases where dependency injection is impractical or not available, a helper method <a href="../api/org/grails/orm/hibernate/cfg/GrailsHibernateUtil.html#unwrapIfProxy(java.lang.Object)">GrailsHibernateUtil.unwrapIfProxy(Object)</a> can be used instead.</p>
</div>
<div class="paragraph">
<p>Unwrapping a proxy is different than initializing it. Initializing a proxy simply populates the underlying instance with data from the database, however unwrapping a returns the inner target.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="customCascadeBehaviour">8.2.9. Custom Cascade Behaviour</h4>
<div class="paragraph">
<p>As described in the section on <a href="#cascades">cascading updates</a>, the primary mechanism to control the way updates and deletes cascade from one association to another is the static <a href="#ref-domain-classes-belongsTo">belongsTo</a> property.</p>
</div>
<div class="paragraph">
<p>However, the ORM DSL gives you complete access to Hibernate&#8217;s <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#associations">transitive persistence</a> capabilities using the <code>cascade</code> attribute.</p>
</div>
<div class="paragraph">
<p>Valid settings for the cascade attribute include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>merge</code> - merges the state of a detached association</p>
</li>
<li>
<p><code>save-update</code> - cascades only saves and updates to an association</p>
</li>
<li>
<p><code>delete</code> - cascades only deletes to an association</p>
</li>
<li>
<p><code>lock</code> - useful if a pessimistic lock should be cascaded to its associations</p>
</li>
<li>
<p><code>refresh</code> - cascades refreshes to an association</p>
</li>
<li>
<p><code>evict</code> - cascades evictions (equivalent to <code>discard()</code> in GORM) to associations if set</p>
</li>
<li>
<p><code>all</code> - cascade <em>all</em> operations to associations</p>
</li>
<li>
<p><code>all-delete-orphan</code> - Applies only to one-to-many associations and indicates that when a child is removed from an association then it should be automatically deleted. Children are also deleted when the parent is.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To specify the cascade attribute simply define one or more (comma-separated) of the aforementioned settings as its value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Person</span> {

    <span class="predefined-type">String</span> firstName

    <span class="directive">static</span> hasMany = [addresses: Address]

    <span class="directive">static</span> mapping = {
        addresses cascade: <span class="string"><span class="delimiter">&quot;</span><span class="content">all-delete-orphan</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Address</span> {
    <span class="predefined-type">String</span> street
    <span class="predefined-type">String</span> postCode
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="customHibernateTypes">8.2.10. Custom Hibernate Types</h4>
<div class="paragraph">
<p>You saw in an earlier section that you can use composition (with the <code>embedded</code> property) to break a table into multiple objects. You can achieve a similar effect with Hibernate&#8217;s custom user types. These are not domain classes themselves, but plain Java or Groovy classes. Each of these types also has a corresponding "meta-type" class that implements <a href="https://docs.jboss.org/hibernate/orm/5.6/javadocs/org/hibernate/usertype/UserType.html">org.hibernate.usertype.UserType</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#_custom_type">Hibernate reference manual</a> has some information on custom types, but here we will focus on how to map them in GORM. Let&#8217;s start by taking a look at a simple domain class that uses an old-fashioned (pre-Java 1.5) type-safe enum class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> {

    <span class="predefined-type">String</span> title
    <span class="predefined-type">String</span> author
    Rating rating

    <span class="directive">static</span> mapping = {
        rating <span class="key">type</span>: RatingUserType
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All we have done is declare the <code>rating</code> field the enum type and set the property&#8217;s type in the custom mapping to the corresponding <code>UserType</code> implementation. That&#8217;s all you have to do to start using your custom type. If you want, you can also use the other column settings such as "column" to change the column name and "index" to add it to an index.</p>
</div>
<div class="paragraph">
<p>Custom types aren&#8217;t limited to just a single column - they can be mapped to as many columns as you want. In such cases you explicitly define in the mapping what columns to use, since Hibernate can only use the property name for a single column. Fortunately, GORM lets you map multiple columns to a property using this syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Book</span> {

    <span class="predefined-type">String</span> title
    <span class="predefined-type">Name</span> author
    Rating rating

    <span class="directive">static</span> mapping = {
        author type: NameUserType, {
            column name: <span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>
            column name: <span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>
        }
        rating type: RatingUserType
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example will create "first_name" and "last_name" columns for the <code>author</code> property. You&#8217;ll be pleased to know that you can also use some of the normal column/property mapping attributes in the column definitions. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">column name: <span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, index: <span class="string"><span class="delimiter">&quot;</span><span class="content">my_idx</span><span class="delimiter">&quot;</span></span>, unique: <span class="predefined-constant">true</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The column definitions do <em>not</em> support the following attributes: <code>type</code>, <code>cascade</code>, <code>lazy</code>, <code>cache</code>, and <code>joinTable</code>.</p>
</div>
<div class="paragraph">
<p>One thing to bear in mind with custom types is that they define the <em>SQL types</em> for the corresponding database columns. That helps take the burden of configuring them yourself, but what happens if you have a legacy database that uses a different SQL type for one of the columns? In that case, override the column&#8217;s SQL type using the <code>sqlType</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Book</span> {

    <span class="predefined-type">String</span> title
    <span class="predefined-type">Name</span> author
    Rating rating

    <span class="directive">static</span> mapping = {
        author type: NameUserType, {
            column name: <span class="string"><span class="delimiter">&quot;</span><span class="content">first_name</span><span class="delimiter">&quot;</span></span>, sqlType: <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>
            column name: <span class="string"><span class="delimiter">&quot;</span><span class="content">last_name</span><span class="delimiter">&quot;</span></span>, sqlType: <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>
        }
        rating type: RatingUserType, sqlType: <span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mind you, the SQL type you specify needs to still work with the custom type. So overriding a default of "varchar" with "text" is fine, but overriding "text" with "yes_no" isn&#8217;t going to work.</p>
</div>
</div>
<div class="sect3">
<h4 id="derivedProperties">8.2.11. Derived Properties</h4>
<div class="paragraph">
<p>A derived property is one that takes its value from a SQL expression, often but not necessarily based on the value of one or more other persistent properties.  Consider a Product class like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Product</span> {
    <span class="predefined-type">Float</span> price
    <span class="predefined-type">Float</span> taxRate
    <span class="predefined-type">Float</span> tax
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the <code>tax</code> property is derived based on the value of <code>price</code> and <code>taxRate</code> properties then is probably no need to persist the <code>tax</code> property.  The SQL used to derive the value of a derived property may be expressed in the ORM DSL like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Product</span> {
    <span class="predefined-type">Float</span> price
    <span class="predefined-type">Float</span> taxRate
    <span class="predefined-type">Float</span> tax

    <span class="directive">static</span> mapping = {
        tax formula: <span class="string"><span class="delimiter">'</span><span class="content">PRICE * TAX_RATE</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the formula expressed in the ORM DSL is SQL so references to other properties should relate to the persistence model not the object model, which is why the example refers to <code>PRICE</code> and <code>TAX_RATE</code> instead of <code>price</code> and <code>taxRate</code>.</p>
</div>
<div class="paragraph">
<p>With that in place, when a Product is retrieved with something like <code>Product.get(42)</code>, the SQL that is generated to support that will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">select
    product0_.id <span class="keyword">as</span> id1_0_,
    product0_.version <span class="keyword">as</span> version1_0_,
    product0_.price <span class="keyword">as</span> price1_0_,
    product0_.tax_rate <span class="keyword">as</span> tax4_1_0_,
    product0_.PRICE * product0_.TAX_RATE <span class="keyword">as</span> formula1_0_
from
    product product0_
where
    product0_.id=?</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the <code>tax</code> property is derived at runtime and not stored in the database it might seem that the same effect could be achieved by adding a method like <code>getTax()</code> to the <code>Product</code> class that simply returns the product of the <code>taxRate</code> and <code>price</code> properties.  With an approach like that you would give up the ability query the database based on the value of the <code>tax</code> property.  Using a derived property allows exactly that.  To retrieve all <code>Product</code> objects that have a <code>tax</code> value greater than 21.12 you could execute a query like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Product.findAllByTaxGreaterThan(<span class="float">21.12</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Derived properties may be referenced in the Criteria API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Product.withCriteria {
    gt <span class="string"><span class="delimiter">'</span><span class="content">tax</span><span class="delimiter">'</span></span>, <span class="float">21.12f</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SQL that is generated to support either of those would look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">select
    this_.id <span class="keyword">as</span> id1_0_,
    this_.version <span class="keyword">as</span> version1_0_,
    this_.price <span class="keyword">as</span> price1_0_,
    this_.tax_rate <span class="keyword">as</span> tax4_1_0_,
    this_.PRICE * this_.TAX_RATE <span class="keyword">as</span> formula1_0_
from
    product this_
where
    this_.PRICE * this_.TAX_RATE&gt;?</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Because the value of a derived property is generated in the database and depends on the execution of SQL code, derived properties may not have GORM constraints applied to them.  If constraints are specified for a derived property, they will be ignored.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="customNamingStrategy">8.2.12. Custom Naming Strategy</h4>
<div class="paragraph">
<p>By default GORM uses Hibernate&#8217;s <code>ImprovedNamingStrategy</code> to convert domain class Class and field names to SQL table and column names by converting from camel-cased Strings to ones that use underscores as word separators. You can customize these on a per-class basis in the <code>mapping</code> closure but if there&#8217;s a consistent pattern you can specify a different <code>NamingStrategy</code> class to use.</p>
</div>
<div class="paragraph">
<p>Configure the class name to be used in <code>grails-app/conf/application.groovy</code> in the <code>hibernate</code> section, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">dataSource {
    pooled = <span class="predefined-constant">true</span>
    dbCreate = <span class="string"><span class="delimiter">&quot;</span><span class="content">create-drop</span><span class="delimiter">&quot;</span></span>
    ...
}

hibernate {
    cache.use_second_level_cache = <span class="predefined-constant">true</span>
    ...
    naming_strategy = com.myco.myproj.CustomNamingStrategy
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify the name of the class and it will be loaded for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">hibernate {
    ...
    naming_strategy = <span class="string"><span class="delimiter">'</span><span class="content">com.myco.myproj.CustomNamingStrategy</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A third option is to provide an instance if there is some configuration required beyond calling the default constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">hibernate {
    ...
    def strategy = <span class="keyword">new</span> com.myco.myproj.CustomNamingStrategy()
    <span class="comment">// configure as needed</span>
    naming_strategy = strategy
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use an existing class or write your own, for example one that prefixes table names and column names:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.myco.myproj</span>

<span class="namespace">import</span> <span class="namespace">org.hibernate.cfg.ImprovedNamingStrategy</span>
<span class="namespace">import</span> <span class="namespace">org.hibernate.util.StringHelper</span>

<span class="namespace">class</span> <span class="namespace">CustomNamingStrategy</span> <span class="namespace">extends</span> <span class="namespace">ImprovedNamingStrategy</span> {

    <span class="namespace">String</span> <span class="namespace">classToTableName</span>(<span class="namespace">String</span> <span class="namespace">className</span>) {
        <span class="string"><span class="delimiter">&quot;</span><span class="content">table_</span><span class="delimiter">&quot;</span></span> + <span class="namespace">StringHelper.unqualify</span>(<span class="namespace">className</span>)
    }

    <span class="namespace">String</span> <span class="namespace">propertyToColumnName</span>(<span class="namespace">String</span> <span class="namespace">propertyName</span>) {
        <span class="string"><span class="delimiter">&quot;</span><span class="content">col_</span><span class="delimiter">&quot;</span></span> + <span class="namespace">StringHelper.unqualify</span>(<span class="namespace">propertyName</span>)
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="defaultSortOrder">8.3. Default Sort Order</h3>
<div class="paragraph">
<p>You can sort objects using query arguments such as those found in the <a href="#ref-domain-classes-list">list</a> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def airports = Airport.list(sort:<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, you can also declare the default sort order for a collection in the mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Airport</span> {
    ...
    static mapping = {
        sort <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above means that all collections of <code>Airport</code> instances will by default be sorted by the airport name. If you also want to change the sort <em>order</em>, use this syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Airport</span> {
    ...
    static mapping = {
        sort name: <span class="string"><span class="delimiter">&quot;</span><span class="content">desc</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you can configure sorting at the association level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">Airport</span> {
    ...
    static hasMany = [flights: Flight]

    <span class="directive">static</span> mapping = {
        flights sort: <span class="string"><span class="delimiter">'</span><span class="content">number</span><span class="delimiter">'</span></span>, order: <span class="string"><span class="delimiter">'</span><span class="content">desc</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the <code>flights</code> collection will always be sorted in descending order of flight number.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
These mappings will not work for default unidirectional one-to-many or many-to-many relationships because they involve a join table. See <a href="#ref-orgbrowse-grails-4089-this issue">this issue</a> for more details. Consider using a <code>SortedSet</code> or queries with sort parameters to fetch the data you need.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="programmaticTransactions">9. Programmatic Transactions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GORM&#8217;s transaction management is built on Spring and uses Spring&#8217;s Transaction abstraction for dealing with programmatic transactions.</p>
</div>
<div class="paragraph">
<p>However, GORM classes have been enhanced to make this simpler with the <a href="../api/org/grails/datastore/gorm/GormEntity.html#withTransaction(groovy.lang.Closure)">withTransaction(Closure)</a>  method. This method has a single parameter, a Closure, which has a single parameter which is a Spring <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/TransactionStatus.html">TransactionStatus</a> instance.</p>
</div>
<div class="sect3">
<h4 id="_using_the_withtransaction_method">9.1. Using the withTransaction Method</h4>
<div class="paragraph">
<p>Here&#8217;s an example of using <code>withTransaction</code> in a controller methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def transferFunds() {
    Account.withTransaction { status -&gt;
        def source = Account.get(params.from)
        def dest = Account.get(params.to)

        def amount = params.amount.toInteger()
        <span class="keyword">if</span> (source.active) {
            <span class="keyword">if</span> (dest.active) {
                source.balance -= amount
                dest.amount += amount
            }
            <span class="keyword">else</span> {
                status.setRollbackOnly()
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we rollback the transaction if the destination account is not active.</p>
</div>
<div class="paragraph">
<p>Also, if an <code>Exception</code> (both checked or runtime exception) or <code>Error</code> is thrown during the process the transaction will automatically be rolled back..</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
GORM versions prior to 6.0.0 did not roll back transactions for a checked <code>Exception</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use "save points" to rollback a transaction to a particular point in time if you don&#8217;t want to rollback the entire transaction. This can be achieved through the use of Spring&#8217;s <a href="https://docs.spring.io/spring/docs/current/javadoc-api/org/springframework/transaction/SavepointManager.html">SavePointManager</a> interface.</p>
</div>
<div class="paragraph">
<p>The <code>withTransaction</code> method deals with the begin/commit/rollback logic for you within the scope of the block.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_transactionservice">9.2. Using TransactionService</h4>
<div class="paragraph">
<p>Since GORM 6.1, if you need more flexibility then instead you can instead take advantage of the <a href="../api/grails/gorm/transactions/TransactionService.html">TransactionService</a>, which can be obtained by looking it up from from the <code>HibernateDatastore</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.transactions.*</span>

TransactionService transactionService = datastore.getService(TransactionService)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or via dependency injection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.transactions.*</span>

<span class="annotation">@Autowired</span> TransactionService transactionService</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have an instance then there are various including <code>withTransaction</code>, <code>withRollback</code>, <code>withNewTransaction</code> etc. which helps with the construction of programmatic transactions.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dataServices">10. GORM Data Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Introduced in GORM 6.1, Data Services take the work out of implemented service layer logic by adding the ability to automatically implement abstract classes or interfaces using GORM logic.</p>
</div>
<div class="paragraph">
<p>To illustrate what GORM Data Services are about let&#8217;s walk through an example.</p>
</div>
<div class="sect2">
<h3 id="_data_service_basics">10.1. Data Service Basics</h3>
<div class="sect3">
<h4 id="_writing_a_simple_data_service">10.1.1. Writing a Simple Data Service</h4>
<div class="paragraph">
<p>In a Grails application you can create a Data Service in either <code>src/main/groovy</code> or <code>grails-app/services</code>. To write a Data Service you should create either an interface (although abstract classes can also be used, more about that later) and annotate it with the <code>grails.gorm.services.Service</code> annotation with the domain class the service applies to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">Book</span> getBook(<span class="predefined-type">Serializable</span> id)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Service</code> annotation is an AST transformation that will automatically implement the service for you. You can then obtain the service via Spring autowiring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Autowired</span> BookService bookService</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if you are using GORM standalone by looking it up from the <code>HibernateDatastore</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">BookService bookService = hibernateDatastore.getService(BookService)</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The above example also works in Spock unit tests that extend <code>HibernateSpec</code>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_how_does_it_work">10.1.2. How Does it Work?</h4>
<div class="paragraph">
<p>The <code>@Service</code> transformation will look at the the method signatures of the interface and make a best effort to find a way to implement each method.</p>
</div>
<div class="paragraph">
<p>If a method cannot be implemented then a compilation error will occur. At this point you have the option to use an abstract class instead and provide an implementation yourself.</p>
</div>
<div class="paragraph">
<p>The <code>@Service</code> transformation will also generate a <code>META-INF/services</code> file for the service so it can be discovered via the standard Java service loader. So no additional configuration is necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="_advantages_of_data_services">10.1.3. Advantages of Data Services</h4>
<div class="paragraph">
<p>There are several advantages to Data Services that make them worth considering to abstract your persistence logic.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Type Safety</strong> - Data service method signatures are compile time checked and compilation will fail if the types of any parameters don&#8217;t match up with properties in your domain class</p>
</li>
<li>
<p><strong>Testing</strong> - Since Data Services are interfaces this makes them easy to test via <a href="https://spockframework.org/spock/docs/1.0/interaction_based_testing.html">Spock Mocks</a></p>
</li>
<li>
<p><strong>Performance</strong> - The generated services are statically compiled and unlike competing technologies in the Java space no proxies are created so runtime performance doesn&#8217;t suffer</p>
</li>
<li>
<p><strong>Transaction Management</strong> - Each method in a Data Service is wrapped in an appropriate transaction (a read-only transaction in the case of read operations) that can be easily overridden.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_abstract_class_support">10.1.4. Abstract Class Support</h4>
<div class="paragraph">
<p>If you come across a method that GORM doesn&#8217;t know how to implement, then you can provide an implementation by using an abstract class.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">interface</span> IBookService {
    <span class="predefined-type">Book</span> getBook(<span class="predefined-type">Serializable</span> id)
    <span class="predefined-type">Date</span> someOtherMethod()
}
<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="directive">abstract</span> <span class="type">class</span> <span class="class">BookService</span> <span class="directive">implements</span> IBookService {

   <span class="annotation">@Override</span>
   <span class="predefined-type">Date</span> someOtherMethod() {
      <span class="comment">// impl</span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case GORM will implement the interface methods that have not been defined by the abstract class.</p>
</div>
<div class="paragraph">
<p>In addition, all <em>public</em> methods of the domain class will be automatically wrapped in the appropriate transaction handling.</p>
</div>
<div class="paragraph">
<p>What this means is that you can define protected abstract methods that are non-transactional in order to compose logic. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="directive">abstract</span> <span class="type">class</span> <span class="class">BookService</span>  {

   <span class="directive">protected</span> <span class="directive">abstract</span> <span class="predefined-type">Book</span> getBook(<span class="predefined-type">Serializable</span> id) <i class="conum" data-value="1"></i><b>(1)</b>

   <span class="directive">protected</span> <span class="directive">abstract</span> Author getAuthor(<span class="predefined-type">Serializable</span> id) <i class="conum" data-value="1"></i><b>(1)</b>

   <span class="predefined-type">Book</span> updateBook(<span class="predefined-type">Serializable</span> id, <span class="predefined-type">Serializable</span> authorId) { <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="predefined-type">Book</span> book = getBook(id)
      <span class="keyword">if</span>(book != <span class="predefined-constant">null</span>) {
          Author author = getAuthor(authorId)
          <span class="keyword">if</span>(author == <span class="predefined-constant">null</span>) {
              <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Author does not exist</span><span class="delimiter">&quot;</span></span>)
          }
          book.author = author
          book.save()
      }
      <span class="keyword">return</span> book
   }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Two <code>protected abstract</code> methods are defined that are not wrapped in transaction handling</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>updateBook</code> method uses the two methods that are implemented automatically by GORM and being <code>public</code> is automatically made transactional.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you have <code>public</code> methods that you do not wish to be transactional, then you can annotate them with <code>@NotTransactional</code>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_service_queries">10.2. Data Service Queries</h3>
<div class="paragraph">
<p>GORM Data Services will implement queries for you using a number of different strategies and conventions.</p>
</div>
<div class="paragraph">
<p>It does this by looking at the return type of a method and the method stem and picking the most appropriate implementation.</p>
</div>
<div class="paragraph">
<p>The following table summarizes the conventions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Data Service Conventions</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method Stem</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Possible Return Types</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>count*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Count the number of results</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subclass of <code>Number</code> or <code>Observable&lt;Number&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>countBy*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic Finder Count the number of results</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subclass of <code>Number</code> or <code>Observable&lt;Number&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete an instance for the given arguments</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code>, <code>void</code>, subclass of <code>Number</code> or <code>Observable&lt;Number&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>find*</code>, <code>get*</code>, <code>list*</code> or <code>retrieve*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Query for the given parameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code>, <code>Iterable&lt;T&gt;</code>, <code>T[]</code>, <code>List&lt;T&gt;</code>, <code>Observable&lt;T&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>findBy*</code>, <code>listBy*</code>, <code>findAllBy*</code> or <code>getBy*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dynamic finder query for given parameters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code>, <code>Iterable&lt;T&gt;</code>, <code>T[]</code>, <code>List&lt;T&gt;</code>, <code>Observable&lt;T&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>save*</code>, <code>store*</code>, or <code>persist*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Save a new instance</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code> or <code>Observable&lt;T&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update*</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Updates an existing instance. First parameter should be <code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>T</code> or <code>Observable&lt;T&gt;</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The conventions are extensible (more on that later), in terms of queries there are two distinct types.</p>
</div>
<div class="sect3">
<h4 id="_simple_queries">10.2.1. Simple Queries</h4>
<div class="paragraph">
<p>Simple queries are queries that use the arguments of the method. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">Book</span> findBook(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the example above the Data Service will generate the implementation based on the fact that the <code>title</code> parameter matches the <code>title</code> property of the <code>Book</code> class both in terms of name and type.</p>
</div>
<div class="paragraph">
<p>If you were to misspell the <code>title</code> parameter or use an incorrect type then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>You can alter the return type to return more results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; findBooks(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And if you wish to control pagination and query arguments you can add an <code>args</code> parameter that should be a <code>Map</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; findBooks(<span class="predefined-type">String</span> title, <span class="predefined-type">Map</span> args)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the following query will control pagination and ordering:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = bookService.findBooks(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">The Stand</span><span class="delimiter">&quot;</span></span>,
    [<span class="key">offset</span>:<span class="integer">10</span>, <span class="key">max</span>:<span class="integer">10</span>, <span class="key">sort</span>:<span class="string"><span class="delimiter">'</span><span class="content">title</span><span class="delimiter">'</span></span>, <span class="key">order</span>:<span class="string"><span class="delimiter">'</span><span class="content">desc</span><span class="delimiter">'</span></span>]
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can include multiple parameters in the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; findBooks(<span class="predefined-type">String</span> title, <span class="predefined-type">Date</span> publishDate)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case a conjunction (<code>AND</code>) query will be executed. If you need to do a disjunction (<code>OR</code>) then it is time you learn about Dynamic Finder-style queries.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dynamic_finder_queries">10.2.2. Dynamic Finder Queries</h4>
<div class="paragraph">
<p>Dynamic finder styles queries use the stem plus the word <code>By</code> and then a <a href="#finders">Dynamic Finder expression</a>.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; findByTitleAndPublishDateGreaterThan(<span class="predefined-type">String</span> title, <span class="predefined-type">Date</span> publishDate)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The signature above will produce a dynamic finder query using the method signature expression.</p>
</div>
<div class="paragraph">
<p>The possible method expressions are the same as those possible with GORM&#8217;s static <a href="#finders">Dynamic Finders</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this case the names of the properties to query are inferred from the method signature and the parameter names are not critical. If you misspell the method signature a compilation error will occur.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_where_queries">10.2.3. Where Queries</h4>
<div class="paragraph">
<p>If you have a more complex query then you may want to consider using the <code>@Where</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">    <span class="annotation">@Where</span>({ title ==~ pattern &amp;&amp; releaseDate &gt; fromDate })
    <span class="predefined-type">Book</span> searchBooks(<span class="predefined-type">String</span> pattern, <span class="predefined-type">Date</span> fromDate)</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the <code>@Where</code> annotation the method name can be anything you want and query is expressed within a closure passed with the <code>@Where</code> annotation.</p>
</div>
<div class="paragraph">
<p>The query will be type checked against the parameters and compilation will fail if you misspell a parameter or property name.</p>
</div>
<div class="paragraph">
<p>The syntax is the same as what is passed to GORM&#8217;s static <code>where</code> method, see the section on <a href="#whereQueries">Where Queries</a> for more information.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_query_joins">10.3. Query Joins</h3>
<div class="paragraph">
<p>You can specify query joins using the <code>@Join</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">javax.persistence.criteria.JoinType.*</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="annotation">@Join</span>(<span class="string"><span class="delimiter">'</span><span class="content">author</span><span class="delimiter">'</span></span>)
    <span class="predefined-type">Book</span> find(<span class="predefined-type">String</span> title) <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Join</span>(value=<span class="string"><span class="delimiter">'</span><span class="content">author</span><span class="delimiter">'</span></span>, type=LEFT) <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="predefined-type">Book</span> findAnother(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Join on the <code>author</code> property</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Join on the <code>author</code> property using a <code>LEFT OUTER</code> join</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_jpa_ql_queries">10.3.1. JPA-QL Queries</h4>
<div class="paragraph">
<p>If you need even more flexibility, then HQL queries can be used via the <code>@Query</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">from </span><span class="inline"><span class="inline-delimiter">$</span><span class="predefined-type">Book</span></span><span class="content"> as book where book.title like </span><span class="inline"><span class="inline-delimiter">$</span>pattern</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Book</span> searchByTitle(<span class="predefined-type">String</span> pattern)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the example above, if you misspell the <code>pattern</code> parameter passed to the query a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>However, if you were to incorrectly input the <code>title</code> property no error would occur since it is part of the String and not a variable.</p>
</div>
<div class="paragraph">
<p>You can resolve this by declaring the value of <code>book</code> within the passed GString:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">from </span><span class="inline"><span class="inline-delimiter">${</span><span class="predefined-type">Book</span> book<span class="inline-delimiter">}</span></span><span class="content"> where </span><span class="inline"><span class="inline-delimiter">${</span>book.title<span class="inline-delimiter">}</span></span><span class="content"> like </span><span class="inline"><span class="inline-delimiter">$</span>pattern</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Book</span> searchByTitle(<span class="predefined-type">String</span> pattern)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example if you misspell the <code>title</code> property then a compilation error will occur. This is extremely powerful as it gives you the ability to type check HQL queries, which has always been one of the disadvantages of using them in comparison to criteria.</p>
</div>
<div class="paragraph">
<p>This support for type checked queries extends to joins. For example consider this query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
 from </span><span class="inline"><span class="inline-delimiter">${</span><span class="predefined-type">Book</span> book<span class="inline-delimiter">}</span></span><span class="content"> <i class="conum" data-value="1"></i><b>(1)</b>
 inner join </span><span class="inline"><span class="inline-delimiter">${</span>Author author = book.author<span class="inline-delimiter">}</span></span><span class="content"> <i class="conum" data-value="2"></i><b>(2)</b>
 where </span><span class="inline"><span class="inline-delimiter">$</span>book</span><span class="content">.title = </span><span class="inline"><span class="inline-delimiter">$</span>title</span><span class="content"> and </span><span class="inline"><span class="inline-delimiter">$</span>author</span><span class="content">.name = </span><span class="inline"><span class="inline-delimiter">$</span>author</span><span class="delimiter">&quot;&quot;&quot;</span></span>) <i class="conum" data-value="3"></i><b>(3)</b>
<span class="predefined-type">Book</span> find(<span class="predefined-type">String</span> title, <span class="predefined-type">String</span> author)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using <code>from</code> to define the root query</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Use inner join and a declaration to define the association to join on</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Apply any conditions in the <code>where</code> clause</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_query_projections">10.3.2. Query Projections</h4>
<div class="paragraph">
<p>There are a few ways to implement projections. One way is to is to use the convention <code>T find[Domain Class][Property]</code>. For example say the <code>Book</code> class has a <code>releaseDate</code> property of type <code>Date</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
   <span class="predefined-type">Date</span> findBookReleaseDate(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This also works for multiple results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
   <span class="predefined-type">List</span>&lt;<span class="predefined-type">Date</span>&gt; findBookReleaseDate(<span class="predefined-type">String</span> publisher)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you can use the <code>Map</code> argument to provide ordering and pagination if necessary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
   <span class="predefined-type">List</span>&lt;<span class="predefined-type">Date</span>&gt; findBookReleaseDate(<span class="predefined-type">String</span> publisher, <span class="predefined-type">Map</span> args)
}</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_jpa_ql_projections">JPA-QL Projections</h5>
<div class="paragraph">
<p>You can also use a JPA-QL query to perform a projection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
   <span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">select </span><span class="inline"><span class="inline-delimiter">$</span>b</span><span class="content">.releaseDate from </span><span class="inline"><span class="inline-delimiter">${</span><span class="predefined-type">Book</span> b<span class="inline-delimiter">}</span></span><span class="content"> where </span><span class="inline"><span class="inline-delimiter">$</span>b</span><span class="content">.publisher = </span><span class="inline"><span class="inline-delimiter">$</span>publisher</span><span class="content"> order by </span><span class="inline"><span class="inline-delimiter">$</span>b</span><span class="content">.releaseDate</span><span class="delimiter">&quot;</span></span>)
   <span class="predefined-type">List</span>&lt;<span class="predefined-type">Date</span>&gt; findBookReleaseDates(<span class="predefined-type">String</span> publisher)
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_interface_projections">Interface Projections</h5>
<div class="paragraph">
<p>Sometimes you want to expose a more limited set of a data to the calling class. In this case it is possible to use interface projections.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    <span class="predefined-type">String</span> name
    <span class="predefined-type">Date</span> dateOfBirth <i class="conum" data-value="1"></i><b>(1)</b>
}
<span class="type">interface</span> AuthorInfo {
    <span class="predefined-type">String</span> getName() <i class="conum" data-value="2"></i><b>(2)</b>
}
<span class="annotation">@Service</span>(Author)
<span class="type">interface</span> AuthorService {
   AuthorInfo find(<span class="predefined-type">String</span> name) <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The domain class <code>Author</code> has a property called <code>dateOfBirth</code> that we do not want to make available to the client</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can define an interface that only exposes the properties you want to expose</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Return the interface from the service.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If a property exists on the interface but not on the domain class you will receive a compilation error.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_service_write_operations">10.4. Data Service Write Operations</h3>
<div class="paragraph">
<p>Write operations in Data Services are automatically wrapped in a transaction. You can modify the transactional attributes by simply adding the <code>@Transactional</code> transformation to any method.</p>
</div>
<div class="paragraph">
<p>The following sections discuss the details of the different write operations.</p>
</div>
<div class="sect3">
<h4 id="_create_2">10.4.1. Create</h4>
<div class="paragraph">
<p>To create a new entity the method should return the new entity and feature either the parameters to be used to create the entity or the entity itself.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">Book</span> saveBook(<span class="predefined-type">String</span> title)

    <span class="predefined-type">Book</span> saveBook(<span class="predefined-type">Book</span> newBook)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If any of the parameters don&#8217;t match up to a property on the domain class then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>If a validation error occurs then a <code>ValidationException</code> will be thrown from the service.</p>
</div>
</div>
<div class="sect3">
<h4 id="_update_2">10.4.2. Update</h4>
<div class="paragraph">
<p>Update operations are similar to Create operations, the main difference being that the first argument should be the <code>id</code> of the object to update.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">Book</span> updateBook(<span class="predefined-type">Serializable</span> id, <span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If any of the parameters don&#8217;t match up to a property on the domain class then a compilation error will occur.</p>
</div>
<div class="paragraph">
<p>If a validation error occurs then a <code>ValidationException</code> will be thrown from the service.</p>
</div>
<div class="paragraph">
<p>You can also implement update operations using JPA-QL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">update </span><span class="inline"><span class="inline-delimiter">${</span><span class="predefined-type">Book</span> book<span class="inline-delimiter">}</span></span><span class="content"> set </span><span class="inline"><span class="inline-delimiter">${</span>book.title<span class="inline-delimiter">}</span></span><span class="content"> = </span><span class="inline"><span class="inline-delimiter">$</span>newTitle</span><span class="content"> where </span><span class="inline"><span class="inline-delimiter">$</span>book</span><span class="content">.title = </span><span class="inline"><span class="inline-delimiter">$</span>oldTitle</span><span class="delimiter">&quot;</span></span>)
<span class="predefined-type">Number</span> updateTitle(<span class="predefined-type">String</span> newTitle, <span class="predefined-type">String</span> oldTitle)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_delete_2">10.4.3. Delete</h4>
<div class="paragraph">
<p>Delete operations can either return <code>void</code> or return the instance that was deleted. In the latter case an extra query is required to fetch the entity prior to issue a delete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
    <span class="predefined-type">Number</span> deleteAll(<span class="predefined-type">String</span> title)

    <span class="type">void</span> delete(<span class="predefined-type">Serializable</span> id)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also implement delete operations using JPA-QL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">delete </span><span class="inline"><span class="inline-delimiter">${</span><span class="predefined-type">Book</span> book<span class="inline-delimiter">}</span></span><span class="content"> where </span><span class="inline"><span class="inline-delimiter">$</span>book</span><span class="content">.title = </span><span class="inline"><span class="inline-delimiter">$</span>title</span><span class="delimiter">&quot;</span></span>)
<span class="type">void</span> delete(<span class="predefined-type">String</span> title)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or via where queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Where</span>({ title == title &amp;&amp; releaseDate &gt; date })
<span class="type">void</span> delete(<span class="predefined-type">String</span> title, <span class="predefined-type">Date</span> date)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_validating_data_services">10.5. Validating Data Services</h3>
<div class="paragraph">
<p>GORM Data Services have built in support for <code>javax.validation</code> annotations for method parameters.</p>
</div>
<div class="paragraph">
<p>You will need to have a <code>javax.validation</code> implementation on your classpath (such as <code>hibernate-validator</code> and then simply annotate your method parameters using the appropriate annotation. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">javax.validation.constraints.*</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {

    <span class="predefined-type">Book</span> find(<span class="annotation">@NotNull</span> <span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example the <code>NotNull</code> constraint is applied to the <code>title</code> property. If <code>null</code> is passed to the method a <code>ConstraintViolationException</code> exception will be thrown.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rxjava_support">10.6. RxJava Support</h3>
<div class="paragraph">
<p>GORM Data Services also support returning RxJava 1.x <a href="https://reactivex.io/RxJava/1.x/javadoc/rx/Observable.html">rx.Observable</a> or <a href="https://reactivex.io/RxJava/1.x/javadoc/rx/Single.html">rx.Single</a> types.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
RxJava 2.x support is planned for a future release
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To use the RxJava support you need to ensure that the <code>grails-datastore-gorm-rx</code> dependencies is on the classpath by adding the following to <code>build.gradle</code>:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">compile "org.grails:grails-datastore-gorm-rx:8.0.2"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">rx.*</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
   Single&lt;<span class="predefined-type">Book</span>&gt; findOne(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When a <code>rx.Single</code> is used then a single result is returned. To query multiple results use an <code>rx.Observable</code> instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">rx.*</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {
   <span class="predefined-type">Observable</span>&lt;<span class="predefined-type">Book</span>&gt; findBooks(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For regular GORM entities, GORM will by default execute the persistence operation using RxJava&#8217;s <a href="https://reactivex.io/RxJava/1.x/javadoc/rx/schedulers/Schedulers.html#io()">IO Scheduler</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For RxGORM entities where the underlying database supports non-blocking access the database driver will schedule the operation accordingly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run the operation on a different scheduler using the <code>RxSchedule</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">rx.*</span>
<span class="keyword">import</span> <span class="include">grails.gorm.rx.services.RxSchedule</span>
<span class="keyword">import</span> <span class="include">grails.gorm.services.Service</span>
<span class="keyword">import</span> <span class="include">rx.schedulers.Schedulers</span>

<span class="annotation">@Service</span>(<span class="predefined-type">Book</span>)
<span class="type">interface</span> BookService {

   <span class="annotation">@RxSchedule</span>(scheduler = { Schedulers.newThread() })
   <span class="predefined-type">Observable</span>&lt;<span class="predefined-type">Book</span>&gt; findBooks(<span class="predefined-type">String</span> title)
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multipleDataSources">11. Multiple Data Sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GORM supports the notion of multiple data sources where multiple individual SQL <code>DataSource</code> instances can be configured and switched between.</p>
</div>
<div class="sect2">
<h3 id="_configuring_multiple_data_sources">11.1. Configuring Multiple Data Sources</h3>
<div class="paragraph">
<p>To configure multiple data sources you need to use the <code>dataSources</code> setting. For example in <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">dataSource</span>:
    <span class="key">pooled</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">dbCreate</span>: <span class="string"><span class="content">create-drop</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:books</span></span>
    <span class="key">driverClassName</span>: <span class="string"><span class="content">org.h2.Driver</span></span>
    <span class="key">username</span>: <span class="string"><span class="content">sa</span></span>
    <span class="key">password</span>:
<span class="key">dataSources</span>:
    <span class="key">moreBooks</span>:
        <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:moreBooks</span></span>
        <span class="key">hibernate</span>:
            <span class="key">readOnly</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">evenMoreBooks</span>:
        <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:evenMoreBooks</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure individual settings for each data source. If a setting is not specified by default the setting is inherited from the default data source, so in the example above there is no need to specify the <code>driverClassName</code> for each data source if the same driver is used for all.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For more information on configuration see the <a href="#configuration">Configuration section</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_mapping_domain_classes_to_data_sources">11.2. Mapping Domain Classes to Data Sources</h3>
<div class="paragraph">
<p>If a domain class has no <code>DataSource</code> configuration, it defaults to the standard <code>'dataSource'</code>. Set the <code>datasource</code> property in the <code>mapping</code> block to configure a non-default <code>DataSource</code>. For example, if you want to use the <code>ZipCode</code> domain to use a <code>DataSource</code> called <code>'lookup'</code>, configure it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">ZipCode</span> {

   <span class="predefined-type">String</span> code

   <span class="directive">static</span> mapping = {
      datasource <span class="string"><span class="delimiter">'</span><span class="content">lookup</span><span class="delimiter">'</span></span>
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A domain class can also use two or more configured <code>DataSource</code> instances. Use the <code>datasources</code> property with a list of names to configure more than one, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">ZipCode</span> {

   <span class="predefined-type">String</span> code

   <span class="directive">static</span> mapping = {
      datasources([<span class="string"><span class="delimiter">'</span><span class="content">lookup</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">auditing</span><span class="delimiter">'</span></span>])
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a domain class uses the default <code>DataSource</code> and one or more others, you can use the <code>ConnectionSource.DEFAULT</code> constant to indicate that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.core.connections.*</span>

<span class="type">class</span> <span class="class">ZipCode</span> {

   <span class="predefined-type">String</span> code

   <span class="directive">static</span> mapping = {
      datasources([<span class="string"><span class="delimiter">'</span><span class="content">lookup</span><span class="delimiter">'</span></span>, ConnectionSource.DEFAULT])
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a domain class uses all configured <code>DataSource</code> instances use the value <code>ALL</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.grails.datastore.mapping.core.connections.*</span>

<span class="type">class</span> <span class="class">ZipCode</span> {

   <span class="predefined-type">String</span> code

   <span class="directive">static</span> mapping = {
      datasource ConnectionSource.ALL
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_data_source_namespaces">11.3. Data Source Namespaces</h3>
<div class="paragraph">
<p>If a domain class uses more than one <code>DataSource</code> then you can use the namespace implied by each <code>DataSource</code> name to make GORM calls for a particular <code>DataSource</code>. For example, consider this class which uses two <code>DataSource</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">ZipCode</span> {

   <span class="predefined-type">String</span> code

   <span class="directive">static</span> mapping = {
      datasources([<span class="string"><span class="delimiter">'</span><span class="content">lookup</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">auditing</span><span class="delimiter">'</span></span>])
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first <code>DataSource</code> specified is the default when not using an explicit namespace, so in this case we default to <em>lookup</em>. But you can call GORM methods on the <em>auditing</em> <code>DataSource</code> with the <code>DataSource</code> name, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> zipCode = ZipCode.auditing.get(<span class="integer">42</span>)
...
zipCode.auditing.save()</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, you add the <code>DataSource</code> to the method call in both the static case and the instance case.</p>
</div>
<div class="paragraph">
<p>You can use <code>Where</code> queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> results = ZipCode.where {
    code ==~ <span class="string"><span class="delimiter">'</span><span class="content">995%</span><span class="delimiter">'</span></span>
}.withConnection(<span class="string"><span class="delimiter">'</span><span class="content">auditing</span><span class="delimiter">'</span></span>).list()</code></pre>
</div>
</div>
<div class="paragraph">
<p>or <code>Criteria</code> queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">def</span> c = ZipCode.auditing.createCriteria()
<span class="keyword">def</span> results = c.list {
    like(<span class="string"><span class="delimiter">'</span><span class="content">code</span><span class="delimiter">'</span></span>,<span class="string"><span class="delimiter">'</span><span class="content">995%</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="connectionSources">11.4. The ConnectionSources API</h3>
<div class="paragraph">
<p>Introduced in GORM 6.0, the <a href="../api/org/grails/datastore/mapping/core/connections/ConnectionSources.html">ConnectionSources</a> API allows you to introspect the data sources configured for the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Autowired</span>
HibernateDatastore hibernateDatastore
...
ConnectionSources&lt;SessionFactory, HibernateConnectionSourceSettings&gt; connectionSources
                                        = hibernateDatastore.getConnectionSources()

<span class="keyword">for</span>(ConnectionSource&lt;SessionFactory, HibernateConnectionSourceSettings&gt; connectionSource <span class="keyword">in</span> connectionSources) {
        println <span class="string"><span class="delimiter">&quot;</span><span class="content">Name </span><span class="inline"><span class="inline-delimiter">$</span>connectionSource</span><span class="content">.name</span><span class="delimiter">&quot;</span></span>
        SessionFactory sessionFactory = connectionSource.source
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multiTenancy">12. Multi-Tenancy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Multi-Tenancy, as it relates to software developments, is when a single instance of an application is used to service multiple clients (tenants) in a way that each tenants' data is isolated from the other.</p>
</div>
<div class="paragraph">
<p>This type of architecture is highly common in Software as a Service (SaaS) and Cloud architectures. There are a variety of approaches to multi-tenancy and GORM tries to be flexible in supporting as many as possible.</p>
</div>
<div class="sect2">
<h3 id="_multi_tenancy_modes">12.1. Multi-Tenancy Modes</h3>
<div class="paragraph">
<p>GORM supports the following different multitenancy modes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DATABASE</code> - A separate database with a separate connection pool is used to store each tenants data.</p>
</li>
<li>
<p><code>SCHEMA</code> - The same database, but different schemas are used to store each tenants data.</p>
</li>
<li>
<p><code>DISCRIMINATOR</code> - The same database is used with a discriminator used to partition and isolate data.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above modes are listed from least probable to leak data between tenants to most probable. When using a <code>DISCRIMINATOR</code> approach much greater care needs to be taken to ensure tenants don&#8217;t see each other&#8217;s data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_multi_tenancy_transformations">12.2. Multi-Tenancy Transformations</h3>
<div class="paragraph">
<p>The following transformations can be applied to any class to simplify greatly the development of Multi-Tenant applications. These include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@CurrentTenant</code> - Resolve the current tenant for the context of a class or method</p>
</li>
<li>
<p><code>@Tenant</code> - Use a specific tenant for the context of a class or method</p>
</li>
<li>
<p><code>@WithoutTenant</code> - Execute logic without a specific tenant (using the default connection)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">grails.gorm.multitenancy.*</span>

<span class="comment">// resolve the current tenant for every method</span>
<span class="annotation">@CurrentTenant</span>
<span class="type">class</span> <span class="class">TeamService</span> {

    <span class="comment">// execute the countPlayers method without a tenant id</span>
    <span class="annotation">@WithoutTenant</span>
    <span class="type">int</span> countPlayers() {
        Player.count()
    }

    <span class="comment">// use the tenant id &quot;another&quot; for all GORM logic within the method</span>
    <span class="annotation">@Tenant</span>({<span class="string"><span class="delimiter">&quot;</span><span class="content">another</span><span class="delimiter">&quot;</span></span>})
    <span class="predefined-type">List</span>&lt;Team&gt; allTwoTeams() {
        Team.list()
    }

    <span class="predefined-type">List</span>&lt;Team&gt; listTeams() {
        Team.list(<span class="key">max</span>:<span class="integer">10</span>)
    }

    <span class="annotation">@Transactional</span>
    <span class="type">void</span> addTeam(<span class="predefined-type">String</span> name) {
        <span class="keyword">new</span> Team(<span class="key">name</span>:name).save(<span class="key">flush</span>:<span class="predefined-constant">true</span>)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_database_per_tenant">12.3. Database Per Tenant</h3>
<div class="paragraph">
<p>Using a database per tenant is the most secure way to isolate each tenants data and builds upon GORM&#8217;s existing support for <a href="#multipleDataSources">Multiple Data Sources</a>.</p>
</div>
<div class="sect3">
<h4 id="_configuration">12.3.1. Configuration</h4>
<div class="paragraph">
<p>In order to activate database-per-tenant multi-tenancy you need to set the multi-tenancy mode to <code>DATABASE</code> in your configuration and supply a <a href="../api/org/grails/datastore/mapping/multitenancy/TenantResolver.html">TenantResolver</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">grails</span>:
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">DATABASE</span></span>
            <span class="key">tenantResolverClass</span>: <span class="string"><span class="content">org.grails.datastore.mapping.multitenancy.web.SubDomainTenantResolver</span></span>
<span class="key">dataSource</span>:
    <span class="key">dbCreate</span>: <span class="string"><span class="content">create-drop</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:books</span></span>
<span class="key">dataSources</span>:
    <span class="key">moreBooks</span>:
        <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:moreBooks</span></span>
    <span class="key">evenMoreBooks</span>:
        <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:evenMoreBooks</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example uses a built-in <code>TenantResolver</code> implementation that works with Grails or Spring Boot and evaluates the current tenant id from the DNS sub-domain in a web application. However, you can implement whatever tenant resolving strategy you choose.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multi_tenant_domain_classes">12.3.2. Multi Tenant Domain Classes</h4>
<div class="paragraph">
<p>With the above configuration in place you then to need to implement the <a href="../api/grails/gorm/MultiTenant.html">MultiTenant</a> trait in the domain classes you want to be regarded as multi tenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> <span class="directive">implements</span> MultiTenant&lt;<span class="predefined-type">Book</span>&gt; {
    <span class="predefined-type">String</span> title
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that done whenever you attempt to execute a method on a domain class the tenant id will be resolved via the <code>TenantResolver</code>. So for example if the <code>TenantResolver</code> returns <code>moreBooks</code> then the <code>moreBooks</code> connection will be used when calling GORM methods such as <code>save()</code>, <code>list()</code> and so on.</p>
</div>
</div>
<div class="sect3">
<h4 id="_multi_tenancy_and_the_session_factory">12.3.3. Multi Tenancy and the Session Factory</h4>
<div class="paragraph">
<p>Note that if you reference the default <code>SessionFactory</code> or <code>PlatformTransactionManager</code> in your classes that are injected via Spring, these will not be tenant aware and will point directly to default data source.</p>
</div>
<div class="paragraph">
<p>If you wish to obtain a specific <code>SessionFactory</code> or <code>PlatformTransactionManager</code> then you can use the <code>getDatastoreForConnection(name)</code> method of the <code>HibernateDatastore</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="annotation">@Autowired</span>
HibernateDatastore hibernateDatastore
...
Serializable tenantId = Tenants.currentId(HibernateDatastore)
SessionFactory sessionFactory = hibernateDatastore
                                    .getDatastoreForConnection(tenantId.toString())
                                    .getSessionFactory()</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_multi_tenancy_with_sessions">12.3.4. Multi Tenancy with Sessions</h4>
<div class="paragraph">
<p>When working with GORM typically you need a session bound to the current thread in order for GORM and transactions to work consistently. If you switch to a different tenant then it may be that the session bound to the current thread no longer matches the underlying <code>SessionFactory</code> being used by the tenant. With this in mind you may wants to use the <a href="../api/grails/gorm/multitenancy/Tenants.html">Tenants</a> class to ensure the correct session is bound for the current tenant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">grails.gorm.multitenancy.Tenants.*</span>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = withCurrent {
    <span class="predefined-type">Book</span>.list()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use a specify tenant id using the <code>withId</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">grails.gorm.multitenancy.Tenants.*</span>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = withId(<span class="string"><span class="delimiter">&quot;</span><span class="content">moreBooks</span><span class="delimiter">&quot;</span></span>) {
    <span class="predefined-type">Book</span>.list()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that if you are using more than one GORM implementation, it may be necessary to specify the implementation type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">grails.gorm.multitenancy.Tenants.*</span>
<span class="keyword">import</span> <span class="include">org.grails.orm.hibernate.*</span>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = withId(HibernateDatastore, <span class="string"><span class="delimiter">&quot;</span><span class="content">moreBooks</span><span class="delimiter">&quot;</span></span>) {
    <span class="predefined-type">Book</span>.list()
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_tenants_at_runtime">12.3.5. Adding Tenants at Runtime</h4>
<div class="paragraph">
<p>Provisioning and creating SQL databases at runtime is non-trivial and beyond the scope of what GORM offers, however the <a href="#connectionSources">ConnectionSources API</a> does provide a way to hook into GORM to make this possible.</p>
</div>
<div class="paragraph">
<p>By default an <a href="../api/org/grails/datastore/mapping/core/connections/InMemoryConnectionSources.html">InMemoryConnectionSources</a> object is used which will read the connection sources from the application configuration and store them in-memory.</p>
</div>
<div class="paragraph">
<p>However, it is possible to configure an alternate implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">grails</span>:
    <span class="key">gorm</span>:
        <span class="key">connectionSourcesClass</span>: <span class="string"><span class="content">com.example.MyConnectionSources</span></span>
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">DATABASE</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation could read the connection sources at startup from another database table and implement logic by overriding the <code>addConnectionSource</code> method to provision a new databases at runtime.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are interested in more examples, an <a href="https://github.com/grails/gorm-mongodb/blob/master/grails-datastore-gorm-mongodb/src/main/groovy/org/grails/datastore/mapping/mongo/connections/MongoConnectionSources.groovy">implementation exists for MongoDB</a> that reads connection sources from a MongoDB collection. However, it doesn&#8217;t implement support for provision MongoDB instances at runtime.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_schema_per_tenant">12.4. Schema Per Tenant</h3>
<div class="paragraph">
<p>Schema-per-tenant is when a single database is used, but a different database schema is used for each tenant.</p>
</div>
<div class="sect3">
<h4 id="_configuration_2">12.4.1. Configuration</h4>
<div class="paragraph">
<p>In order to activate schema-per-tenant multi-tenancy you need to set the multi-tenancy mode to <code>SCHEMA</code> in your configuration and supply a <a href="../api/org/grails/datastore/mapping/multitenancy/TenantResolver.html">TenantResolver</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">grails</span>:
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">SCHEMA</span></span>
            <span class="key">tenantResolverClass</span>: <span class="string"><span class="content">foo.bar.MySchemaResolver</span></span>
<span class="key">dataSource</span>:
    <span class="key">dbCreate</span>: <span class="string"><span class="content">create-drop</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:books</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>TenantResolver</code> can optionally implement the <code>AllTenantsResolver</code> interface and return the schema names of all tenants. This gives you the option to hard code these, place them in configuration or read them from the default schema dynamically.</p>
</div>
<div class="paragraph">
<p>If the <code>AllTenantsResolver</code> resolver is not implemented then GORM will use the configured <a href="../api/org/grails/org/hibernate/jdbc/schema/SchemaHandler.html">SchemaHandler</a> to resolve all the schema names from the database which it will use for the tenants.</p>
</div>
</div>
<div class="sect3">
<h4 id="_runtime_schema_creation">12.4.2. Runtime Schema Creation</h4>
<div class="paragraph">
<p>On startup, if <code>dataSource.dbCreate</code> is set to create the database at runtime, then GORM will attempt to create the schemas if they are missing.</p>
</div>
<div class="paragraph">
<p>To do this it uses an instance <a href="../api/org/grails/org/hibernate/jdbc/schema/SchemaHandler.html">SchemaHandler</a> which by default uses the <code>CREATE SCHEMA [name]</code> syntax, but can be overridden and customized for other database dialects as necessary.</p>
</div>
<div class="paragraph">
<p>If you want to use this feature and create schemas at runtime depending on the database you may need to configure an alternate implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">dataSource</span>:
    <span class="key">dbCreate</span>: <span class="string"><span class="content">create-drop</span></span>
    <span class="key">schemaHandler</span>: <span class="string"><span class="content">foo.bar.MySchemaHandler</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can disable completely runtime schema creation by removing the <code>dbCreate</code> option or setting it to <code>none</code>.</p>
</div>
<div class="paragraph">
<p>If you wish to add a schema whilst the application is running then you can use the <code>addTenantForSchema</code> of the <code>HibernateDatastore</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">HibernateDatastore datastore = ...
datastore.addTenantForSchema(<span class="string"><span class="delimiter">&quot;</span><span class="content">myNewSchema</span><span class="delimiter">&quot;</span></span>)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If <code>dbCreate</code> is disabled then you will have to create the schema manually prior to invoking this method
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_schema_per_tenant_caveats">12.4.3. Schema-Per-Tenant Caveats</h4>
<div class="paragraph">
<p>In order to support a schema-per-tenant, just like the <code>DATABASE</code> Multi-Tenancy mode, GORM uses a unique <code>SessionFactory</code> per tenant. So all of the same considerations regarding session management apply.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_partitioned_multi_tenancy">12.5. Partitioned Multi-Tenancy</h3>
<div class="paragraph">
<p>Partitioned multi-tenancy is when a discriminator column is used in each multi-tenant class in order to partition the data.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
When using a discriminator all data for all tenants is stored in a single database. This is means that, as a developer, you have to take much greater care to ensure that each tenants' data is correctly isolated.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_configuration_3">12.5.1. Configuration</h4>
<div class="paragraph">
<p>In order to activate discriminator-based multi-tenancy you need to set the multi-tenancy mode to <code>DISCRIMINATOR</code> in your configuration and supply a <a href="../api/org/grails/datastore/mapping/multitenancy/TenantResolver.html">TenantResolver</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">grails</span>:
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">DISCRIMINATOR</span></span>
            <span class="key">tenantResolverClass</span>: <span class="string"><span class="content">foo.bar.MyTenantResolver</span></span>
<span class="key">dataSource</span>:
    <span class="key">dbCreate</span>: <span class="string"><span class="content">create-drop</span></span>
    <span class="key">url</span>: <span class="string"><span class="content">jdbc:h2:mem:books</span></span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The specified <code>TenantResolver</code> will also need to implement the <a href="../api/org/grails/datastore/mapping/multitenancy/AllTenantsResolver.html">AllTenantsResolver</a> interface, which has an additional method to resolve all known tenants.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_domain_classes">12.5.2. Mapping Domain Classes</h4>
<div class="paragraph">
<p>Like the other forms of multi-tenancy you then need to implement the <a href="../api/grails/gorm/MultiTenant.html">MultiTenant</a> trait in the domain classes that are multi-tenant. In addition, you also need to specify a discriminator column. The default discriminator column is called <code>tenantId</code>, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> <span class="directive">implements</span> MultiTenant&lt;<span class="predefined-type">Book</span>&gt; {
    <span class="predefined-type">Long</span> tenantId
    <span class="predefined-type">String</span> title
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the tenant identifier can be any type or name. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Book</span> <span class="directive">implements</span> MultiTenant&lt;<span class="predefined-type">Book</span>&gt; {
    <span class="predefined-type">String</span> publisher
    <span class="predefined-type">String</span> title

    <span class="directive">static</span> mapping = {
        tenantId <span class="key">name</span>:<span class="string"><span class="delimiter">'</span><span class="content">publisher</span><span class="delimiter">'</span></span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_querying_and_caveats">12.5.3. Querying and Caveats</h4>
<div class="paragraph">
<p>The discriminator-based multi-tenancy transparently adds a Hibernate filter that is activated when you query the domain class and you can also use the <a href="../api/grails/gorm/multitenancy/Tenants.html">Tenants</a> API to switch between tenants:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">grails.gorm.multitenancy.Tenants.*</span>

<span class="predefined-type">List</span>&lt;<span class="predefined-type">Book</span>&gt; books = withCurrent {
    <span class="predefined-type">Book</span>.list()
}
...
List&lt;<span class="predefined-type">Book</span>&gt; books = withId(<span class="string"><span class="delimiter">&quot;</span><span class="content">moreBooks</span><span class="delimiter">&quot;</span></span>) {
    <span class="predefined-type">Book</span>.list()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this automatic activation of the Hibernate filter using GORM eventing and therefore only works when you use GORM methods, if you perform any raw Hibernate queries on the session factory you will need to activate the filter manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">static</span> <span class="include">grails.gorm.multitenancy.Tenants.*</span>
<span class="keyword">import</span> <span class="include">org.grails.orm.hibernate.*</span>

<span class="comment">// get a reference to the datastore and sessionFactory, probably from Spring</span>
HibernateDatastore datastore = ..
SessionFactory sessionFactory = ..
datastore.enableMultiTenancyFilter()

<span class="comment">// do work with the session factory</span>
sessionFactory.openSession()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_understanding_tenant_resolvers">12.6. Understanding Tenant Resolvers</h3>
<div class="paragraph">
<p>As mentioned previously the <a href="../api/org/grails/datastore/mapping/multitenancy/TenantResolver.html">TenantResolver</a> interface is how you define the value of the <a href="../api/grails/gorm/multitenancy/Tenants.html#currentId()">current tenant</a>.</p>
</div>
<div class="paragraph">
<p>This section will cover a few more details about implementing <code>TenantResolver</code> instances.</p>
</div>
<div class="sect3">
<h4 id="_specifying_the_tenant_resolver">12.6.1. Specifying the Tenant Resolver</h4>
<div class="paragraph">
<p>As already mentioned you can specify the <code>TenantResolver</code> via configuration using the <code>grails.gorm.tenantResolverClass</code> setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">grails</span>:
    <span class="key">gorm</span>:
        <span class="key">multiTenancy</span>:
            <span class="key">mode</span>: <span class="string"><span class="content">DATABASE</span></span>
            <span class="key">tenantResolverClass</span>: <span class="string"><span class="content">org.grails.datastore.mapping.multitenancy.web.SubDomainTenantResolver</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if you are using Grails or Spring Boot then the <code>TenantResolver</code> can also be specified as a Spring bean and it will automatically be injected, this allows you to use dependency injection to configure the dependencies of the resolver.</p>
</div>
</div>
<div class="sect3">
<h4 id="_built_in_tenant_resolvers">12.6.2. Built-in Tenant Resolvers</h4>
<div class="paragraph">
<p>The following table contains all of the <code>TenantResolver</code> implementations that ship with GORM and are usable out of the box. The package name has been shorted from <code>org.grails.datastore.mapping</code> to <code>o.g.d.m</code> for brevity:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">name</th>
<th class="tableblock halign-left valign-top">description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.resolvers.FixedTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves against a fixed tenant id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.resolvers.SystemPropertyTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from a system property called <code>gorm.tenantId</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.SubDomainTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the tenant id from the subdomain via DNS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.CookieTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the current tenant from an HTTP cookie named <code>gorm.tenantId</code> by default</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.SessionTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the current tenant from the HTTP session using the attribute <code>gorm.tenantId</code> by default</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>o.g.d.m.multitenancy.web.HttpHeaderTenantResolver</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resolves the current tenant from the request HTTP Header using the header name <code>gorm.tenantId</code> by default</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The tenant resolvers in the <code>org.grails.datastore.mapping.multitenancy.web</code> package require the <code>grails-datastore-web</code> dependency:</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">compile "org.grails:grails-datastore-web:8.0.2"</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_alltenantsresolver_interface">12.6.3. The AllTenantsResolver interface</h4>
<div class="paragraph">
<p>If you are using discriminator-based multi-tenancy then you may need to implement the <a href="../api/org/grails/datastore/mapping/multitenancy/AllTenantsResolver.html">AllTenantsResolver</a> interface in your <code>TenantResolver</code> implementation if you want to at any point iterate over all available tenants.</p>
</div>
<div class="paragraph">
<p>Typically with discriminator-based multi-tenancy the tenants are identified by some other domain class property. So for example an implementation would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Iterable</span>&lt;<span class="predefined-type">Serializable</span>&gt; resolveTenantIds() {
    <span class="keyword">new</span> DetachedCriteria(Company)
            .distinct(<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>)
            .list()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example uses the distinct names of each <code>Company</code> domain class to resolve all of the tenant identifiers.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_web_tenant_resolvers">12.6.4. Implementing Web Tenant Resolvers</h4>
<div class="paragraph">
<p>If you wish to implement your own tenant resolver for Grails or Spring Boot then it is possible do so using the <code>RequestContextHolder</code> class without needing to inject any dependencies. For example the <code>SubDomainTenantResolver</code> implementation is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">Serializable</span> resolveTenantIdentifier() {

    RequestAttributes requestAttributes = RequestContextHolder.getRequestAttributes()
    <span class="keyword">if</span>(requestAttributes <span class="keyword">instanceof</span> ServletWebRequest) {

        <span class="predefined-type">String</span> subdomain = ((ServletWebRequest)requestAttributes).getRequest().getRequestURL().toString();
        subdomain = subdomain.substring(subdomain.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span>) + <span class="integer">2</span>);
        <span class="keyword">if</span>( subdomain.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span>) &gt; -<span class="integer">1</span> ) {
            <span class="keyword">return</span> subdomain.substring(<span class="integer">0</span>, subdomain.indexOf(<span class="string"><span class="delimiter">&quot;</span><span class="content">.</span><span class="delimiter">&quot;</span></span>))
        }
        <span class="keyword">else</span> {
            <span class="keyword">return</span> ConnectionSource.DEFAULT
        }
    }
    <span class="keyword">throw</span> <span class="keyword">new</span> TenantNotFoundException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Tenant could not be resolved outside a web request</span><span class="delimiter">&quot;</span></span>)
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the tenant id is not found a <code>TenantNotFoundException</code> should be thrown.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="constraints">13. Validation and Constraints</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Constraints are how you define validation when using GORM entities.</p>
</div>
<div class="sect2">
<h3 id="_applying_constraints">13.1. Applying Constraints</h3>
<div class="paragraph">
<p>Within a domain class constraints are defined with the constraints property that is assigned a code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
    <span class="predefined-type">String</span> login
    <span class="predefined-type">String</span> password
    <span class="predefined-type">String</span> email
    <span class="predefined-type">Integer</span> age

    <span class="directive">static</span> constraints = {
      ...
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You then use method calls that match the property name for which the constraint applies in combination with named parameters to specify constraints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
    ...

    static constraints = {
        login size: <span class="integer">5</span>.<span class="float">.15</span>, blank: <span class="predefined-constant">false</span>, unique: <span class="predefined-constant">true</span>
        password size: <span class="integer">5</span>.<span class="float">.15</span>, blank: <span class="predefined-constant">false</span>
        email email: <span class="predefined-constant">true</span>, blank: <span class="predefined-constant">false</span>
        age min: <span class="integer">18</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example we&#8217;ve declared that the <code>login</code> property must be between 5 and 15 characters long, it cannot be blank and must be unique. We&#8217;ve also applied other constraints to the <code>password</code>, <code>email</code> and <code>age</code> properties.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, all domain class properties are not nullable (i.e. they have an implicit <code>nullable: false</code> constraint).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that constraints are only evaluated once which may be relevant for a constraint that relies on a value like an instance of <code>java.util.Date</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">User</span> {
    ...

    static constraints = {
        <span class="comment">// this Date object is created when the constraints are evaluated, not</span>
        <span class="comment">// each time an instance of the User class is validated.</span>
        birthDate max: <span class="keyword">new</span> <span class="predefined-type">Date</span>()
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_referencing_instances_in_constraints">13.2. Referencing Instances in Constraints</h3>
<div class="paragraph">
<p>It&#8217;s very easy to attempt to reference instance variables from the static constraints block, but this isn&#8217;t legal in Groovy (or Java). If you do so, you will get a <code>MissingPropertyException</code> for your trouble. For example, you may try the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Response</span> {
    Survey survey
    Answer answer

    <span class="directive">static</span> constraints = {
        survey <span class="key">blank</span>: <span class="predefined-constant">false</span>
        answer <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">inList</span>: survey.answers
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>See how the <code>inList</code> constraint references the instance property <code>survey</code>? That won&#8217;t work. Instead, use a custom <code>validator</code> constraint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Response</span> {
    ...
    static constraints = {
        survey <span class="key">blank</span>: <span class="predefined-constant">false</span>
        answer <span class="key">blank</span>: <span class="predefined-constant">false</span>, <span class="key">validator</span>: { val, Response obj -&gt; val <span class="keyword">in</span> obj.survey.answers }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>obj</code> argument to the custom validator is the domain <em>instance</em> that is being validated, so we can access its <code>survey</code> property and return a boolean to indicate whether the new value for the <code>answer</code> property, <code>val</code>, is valid.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cascade_constraints_validation">13.3. Cascade constraints validation</h3>
<div class="paragraph">
<p>If GORM entity references some other entities, then during its constraints evaluation (validation) the constraints of the referenced entity could be
evaluated also, if needed. There is a special parameter <code>cascadeValidate</code> in the entity mappings section, which manage the way of this <em>cascaded</em> validation happens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="type">class</span> <span class="class">Author</span> {
    Publisher publisher

    <span class="directive">static</span> mapping = {
        publisher(<span class="key">cascadeValidate</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">dirty</span><span class="delimiter">&quot;</span></span>)
    }
}

<span class="type">class</span> <span class="class">Publisher</span> {
    <span class="predefined-type">String</span> name

    <span class="directive">static</span> constraints = {
        name <span class="key">blank</span>: <span class="predefined-constant">false</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following table presents all options, which can be used:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Will not do any cascade validation at all for the association.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">default</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The DEFAULT option. GORM performs cascade validation in some cases.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">dirty</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only cascade validation if the referenced object is dirty via the <code>DirtyCheckable</code> trait. If the object doesn&#8217;t implement DirtyCheckable, this will fall back to <code>default</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">owned</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Only cascade validation if the entity <a href="#gormAssociation">owns</a> the referenced object.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>It is possible to set the global option for the <code>cascadeValidate</code>:</p>
</div>
<div class="listingblock">
<div class="title">grails-app/conf/application.groovy</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">grails.gorm.default.mapping = {
    <span class="string"><span class="delimiter">'</span><span class="content">*</span><span class="delimiter">'</span></span>(<span class="key">cascadeValidate</span>: <span class="string"><span class="delimiter">'</span><span class="content">dirty</span><span class="delimiter">'</span></span>)
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constraints_reference">13.4. Constraints Reference</h3>
<div class="paragraph">
<p>The following table summarizes the available constraints with a brief example:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Constraint</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">blank</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a String value is not blank</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>login(blank:false)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">creditCard</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a String value is a valid credit card number</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cardNumber(creditCard: true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">email</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a String value is a valid email address.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>homeEmail(email: true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">inList</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a value is within a range or collection of constrained values.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name(inList: ["Joe"])</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">matches</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a String value matches a given regular expression.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>login(matches: "[a-zA-Z]+")</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">max</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a value does not exceed the given maximum value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>age(max: new Date())</code> <code>price(max: 999F)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">maxSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a value&#8217;s size does not exceed the given maximum value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>children(maxSize: 25)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">min</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a value does not fall below the given minimum value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>age(min: new Date())</code> <code>price(min: 0F)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">minSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a value&#8217;s size does not fall below the given minimum value.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>children(minSize: 25)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">notEqual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that that a property is not equal to the specified value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>login(notEqual: "Bob")</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">nullable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows a property to be set to <code>null</code> - defaults to <code>false</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>age(nullable: true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses a Groovy range to ensure that a property&#8217;s value occurs within a specified range</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>age(range: 18..65)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">scale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set to the desired scale for floating point numbers (i.e. the number of digits to the right of the decimal point).</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>salary(scale: 2)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">size</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uses a Groovy range to restrict the size of a collection or number or the length of a String.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>children(size: 5..15)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unique</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Constrains a property as unique at the database level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>login(unique: true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">url</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Validates that a String value is a valid URL.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>homePage(url: true)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">validator</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Adds custom validation to a field.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">See documentation</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_constraints_and_database_mapping">13.5. Constraints and Database Mapping</h3>
<div class="paragraph">
<p>Although constraints are primarily for validation, it is important to understand that constraints can affect the way in which the database schema is generated.</p>
</div>
<div class="paragraph">
<p>Where feasible, GORM uses a domain class&#8217;s constraints to influence the database columns generated for the corresponding domain class properties.</p>
</div>
<div class="paragraph">
<p>Consider the following example.  Suppose we have a domain model with the following properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="predefined-type">String</span> name
<span class="predefined-type">String</span> description</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, in MySQL, GORM would define these columns as</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Data Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(255)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">varchar(255)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>But perhaps the business rules for this domain class state that a description can be up to 1000 characters in length.  If that were the case, we would likely define the column as follows <em>if</em> we were creating the table with an SQL script.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Column</th>
<th class="tableblock halign-left valign-top">Data Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Chances are we would also want to have some application-based validation to make sure we don&#8217;t exceed that 1000 character limit <em>before</em> we persist any records.  In GORM, we achieve this validation with <a href="#constraints">constraints</a>.  We would add the following constraint declaration to the domain class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="directive">static</span> constraints = {
    description <span class="key">maxSize</span>: <span class="integer">1000</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This constraint would provide both the application-based validation we want and it would also cause the schema to be generated as shown above.  Below is a description of the other constraints that influence schema generation.</p>
</div>
<div class="sect3">
<h4 id="_constraints_affecting_string_properties">13.5.1. Constraints Affecting String Properties</h4>
<div class="ulist">
<ul>
<li>
<p><code>inList</code></p>
</li>
<li>
<p><code>maxSize</code></p>
</li>
<li>
<p><code>size</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If either the <code>maxSize</code> or the <code>size</code> constraint is defined, Grails sets the maximum column length based on the constraint value.</p>
</div>
<div class="paragraph">
<p>In general, it&#8217;s not advisable to use both constraints on the same domain class property.  However, if both the <code>maxSize</code> constraint and the <code>size</code> constraint are defined, then GORM sets the column length to the minimum of the <code>maxSize</code> constraint and the upper bound of the size constraint.  (GORM uses the minimum of the two, because any length that exceeds that minimum will result in a validation error.)</p>
</div>
<div class="paragraph">
<p>If the <code>inList</code> constraint is defined (and the <code>maxSize</code> and the <code>size</code> constraints are not defined), then GORM sets the maximum column length based on the length of the longest string in the list of valid values.  For example, given a list including values "Java", "Groovy", and "C++", GORM would set the column length to 6 (i.e., the number of characters in the string "Groovy").</p>
</div>
</div>
<div class="sect3">
<h4 id="_constraints_affecting_numeric_properties">13.5.2. Constraints Affecting Numeric Properties</h4>
<div class="ulist">
<ul>
<li>
<p><code>min</code></p>
</li>
<li>
<p><code>max</code></p>
</li>
<li>
<p><code>range</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <code>max</code>, <code>min</code>, or <code>range</code> constraint is defined, GORM attempts to set the column precision based on the constraint value.  (The success of this attempted influence is largely dependent on how Hibernate interacts with the underlying DBMS.)</p>
</div>
<div class="paragraph">
<p>In general, it&#8217;s not advisable to combine the pair <code>min</code>/<code>max</code> and <code>range</code> constraints together on the same domain class property.  However, if both of these constraints is defined, then GORM uses the minimum precision value from the constraints.  (GORM uses the minimum of the two, because any length that exceeds that minimum precision will result in a validation error.)</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scale</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the scale constraint is defined, then GORM attempts to set the column <a href="#ref-constraints-scale">scale</a> based on the constraint value.  This rule only applies to floating point numbers (i.e., <code>java.lang.Float</code>, <code>java.Lang.Double</code>, <code>java.lang.BigDecimal</code>, or subclasses of <code>java.lang.BigDecimal</code>). The success of this attempted influence is largely dependent on how Hibernate interacts with the underlying DBMS.</p>
</div>
<div class="paragraph">
<p>The constraints define the minimum/maximum numeric values, and GORM derives the maximum number of digits for use in the precision. Keep in mind that specifying only one of <code>min</code>/<code>max</code> constraints will not affect schema generation (since there could be large negative value of property with max:100, for example), unless the specified constraint value requires more digits than default Hibernate column precision is (19 at the moment). For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">someFloatValue <span class="key">max</span>: <span class="integer">1000000</span>, <span class="key">scale</span>: <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>would yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">someFloatValue DECIMAL(<span class="integer">19</span>, <span class="integer">3</span>) <span class="comment">// precision is default</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>but</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">someFloatValue <span class="key">max</span>: <span class="integer">12345678901234567890</span>, <span class="key">scale</span>: <span class="integer">5</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>would yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">someFloatValue DECIMAL(<span class="integer">25</span>, <span class="integer">5</span>) <span class="comment">// precision = digits in max + scale</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">someFloatValue <span class="key">max</span>: <span class="integer">100</span>, <span class="key">min</span>: -<span class="integer">100000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>would yield:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">someFloatValue DECIMAL(<span class="integer">8</span>, <span class="integer">2</span>) <span class="comment">// precision = digits in min + default scale</span></code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing">14. GORM and Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In previous versions of GORM it was much more difficult to setup a unit test to test your GORM logic.</p>
</div>
<div class="paragraph">
<p>However, since GORM 6.0, this situation has changed and it is relatively trivial to setup GORM for testing.</p>
</div>
<div class="sect2">
<h3 id="_unit_testing_with_spock">14.1. Unit Testing with Spock</h3>
<div class="paragraph">
<p><a href="https://docs.spockframework.org">Spock</a> is the recommended tool for writing unit tests with GORM and is trivial to setup.</p>
</div>
<div class="sect3">
<h4 id="_gorm_with_hibernate_and_spock_basics">14.1.1. GORM with Hibernate and Spock Basics</h4>
<div class="paragraph">
<p>The following is an example Spock unit test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">spock.lang.*</span>
<span class="keyword">import</span> <span class="include">grails.gorm.annotation.Entity</span>
<span class="keyword">import</span> <span class="include">org.grails.orm.hibernate.HibernateDatastore</span>

<span class="type">class</span> <span class="class">ExampleSpec</span> <span class="directive">extends</span> Specification { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="annotation">@Shared</span> <span class="annotation">@AutoCleanup</span> HibernateDatastore hibernateDatastore <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="type">void</span> setupSpec() {
       hibernateDatastore = <span class="keyword">new</span> HibernateDatastore(Person) <i class="conum" data-value="3"></i><b>(3)</b>
    }

    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test something</span><span class="delimiter">&quot;</span></span>() { <i class="conum" data-value="4"></i><b>(4)</b>
       <span class="comment">// your logic here</span>
    }
}

<span class="annotation">@Entity</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="type">class</span> <span class="class">Person</span> {
    ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The test should extend <code>spock.lang.Specification</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>Shared</code> annotation is used to indicate to Spock that the <code>HibernateDatastore</code> is shared across all tests. The <code>AutoCleanup</code> annotation makes sure that <code>HibernateDatastore</code> is shutdown when all tests finish executing.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Within the <code>setupSpec</code> method a new <code>HibernateDatastore</code> is constructed with the classes to use as the argument to the constructor.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>You then write your test logic within each method</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>You can inline domain classes within the unit test if you annotate them with <code>@Entity</code></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_spock_and_transactions">14.1.2. Spock and Transactions</h4>
<div class="paragraph">
<p>Note that in general you have to wrap your test execution logic in a session or transaction. The easiest way to do this is with <code>grails.gorm.transactions.Transactional</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">...
import grails.gorm.transactions.*
<span class="keyword">import</span> <span class="include">org.springframework.transaction.PlatformTransactionManager</span>

<span class="type">class</span> <span class="class">ExampleSpec</span> <span class="directive">extends</span> Specification {

    <span class="annotation">@Shared</span> <span class="annotation">@AutoCleanup</span> HibernateDatastore hibernateDatastore
    <span class="annotation">@Shared</span> PlatformTransactionManager transactionManager <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="type">void</span> setupSpec() {
        hibernateDatastore = <span class="keyword">new</span> HibernateDatastore(Person)
        transactionManager = hibernateDatastore.getTransactionManager() <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="annotation">@Transactional</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="keyword">def</span> <span class="function">setup</span>() {
        <span class="keyword">new</span> Person(<span class="key">firstName</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>).save()
    }

    <span class="annotation">@Rollback</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="type">void</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">test execute GORM standalone in a unit test</span><span class="delimiter">&quot;</span></span>() {
        <span class="comment">// your logic here</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>PlatformTransactionManager</code> is defined as a <code>Shared</code> field</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can obtain the <code>PlatformTransactionManager</code> from the <code>HibernateDatastore</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>Transactional</code> annotation is used to setup test data</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>Rollback</code> annotation is used to rollback any changes made within each test</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example above, each test method is wrapped in a transaction that rolls back any changes using the <code>grails.gorm.transactions.Rollback</code> annotation.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you want to setup some test data within the <code>setupSpec</code> method that is shared across all tests then you can use <code>withTransaction</code>:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">...
void setupSpec() {
    hibernateDatastore = <span class="keyword">new</span> HibernateDatastore(Person)
    ...
    Person.withTransaction {
        <span class="keyword">new</span> Person(<span class="key">firstName</span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">Fred</span><span class="delimiter">&quot;</span></span>).save()
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_gorm_in_spock">14.1.3. Configuring GORM in Spock</h4>
<div class="paragraph">
<p>If you need to configure GORM within a Spock unit test you can pass a map to the constructor of <code>HibernateDatastore</code>. For example to setup multi-tenancy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">...
void setupSpec() {
    <span class="predefined-type">Map</span> configuration = [
        <span class="string"><span class="delimiter">'</span><span class="content">grails.gorm.multiTenancy.mode</span><span class="delimiter">'</span></span>:<span class="string"><span class="delimiter">'</span><span class="content">DISCRIMINATOR</span><span class="delimiter">'</span></span>,
        <span class="string"><span class="delimiter">'</span><span class="content">grails.gorm.multiTenancy.tenantResolverClass</span><span class="delimiter">'</span></span>:SystemPropertyTenantResolver
    ]
    hibernateDatastore = <span class="keyword">new</span> HibernateDatastore(configuration, Person)
    ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_unit_testing_with_junit">14.2. Unit Testing with JUnit</h3>
<div class="paragraph">
<p>To unit test with <a href="https://junit.org/junit4">JUnit</a> it is largely similar to Spock, just following different idioms.</p>
</div>
<div class="paragraph">
<p>So instead of <code>setupSpec</code> use <code>@BeforeClass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">import</span> <span class="include">org.junit.*</span>
<span class="keyword">import</span> <span class="include">grails.gorm.transactions.*</span>
<span class="keyword">import</span> <span class="include">org.grails.orm.hibernate.HibernateDatastore</span>
<span class="keyword">import</span> <span class="include">org.springframework.transaction.PlatformTransactionManager</span>

<span class="type">class</span> <span class="class">ExampleTest</span>  {

    <span class="directive">static</span> HibernateDatastore hibernateDatastore

    PlatformTransactionManager transactionManager

    <span class="annotation">@BeforeClass</span>
    <span class="type">void</span> setupGorm() {
       hibernateDatastore = <span class="keyword">new</span> HibernateDatastore(Person)
    }

    <span class="annotation">@AfterClass</span>
    <span class="type">void</span> shutdownGorm() {
       hibernateDatastore.close()
    }

    <span class="annotation">@Before</span>
    <span class="type">void</span> setup() {
        transactionManager = hibernateDatastore.getTransactionManager()
    }

    <span class="annotation">@Rollback</span>
    <span class="annotation">@Test</span>
    <span class="type">void</span> testSomething() {
       <span class="comment">// your logic here</span>
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
JUnit doesn&#8217;t have anything like Spock&#8217;s <code>AutoCleanup</code> so you must call <code>close()</code> on the <code>HibernateDatastore</code> manually!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 8.0.2<br>
</div>
</div>
</body>
</html>